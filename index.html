<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dosemagna - Pannello Ordini</title>
    <link rel="icon" href="https://i.postimg.cc/L6H20zfp/logo-dosepranza-People-About-Food.png">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        primary: { light: '#e8b39a', DEFAULT: '#D6804F', dark: '#c0673a', '100': '#fef4ef', '800': '#8c502f' },
                        secondary: { DEFAULT: '#709460', dark: '#5a794d' },
                        background: '#F3F1E7', 'text-main': '#3B3F2F',
                    }
                }
            }
        }
    </script>
    <style>
        .view { display: none; }
        .view.active { display: block; }
        .product-title { min-height: 2.8rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .ingredient-card.selected { border-color: #D6804F; background-color: #fef4ef; border-width: 3px; }
        .nav-btn.active { background-color: #D6804F; color: white; }
    </style>
</head>
<body class="bg-background text-text-main pb-20 font-sans">

    <div id="app" class="max-w-4xl mx-auto p-4">
        <header class="mb-6 flex flex-col items-center">
            <img src="https://i.postimg.cc/L6H20zfp/logo-dosepranza-People-About-Food.png" class="w-64 md:w-80">
            <div class="bg-white/50 border-l-4 border-primary p-3 rounded-r-xl mt-4 w-full text-xs font-bold shadow-sm">
                Ordine entro le 11:30 | Consegna gratuita ore 12:30.
            </div>
        </header>

        <nav class="grid grid-cols-4 gap-1 bg-white p-2 rounded-2xl shadow-lg sticky top-2 z-50 mb-6 border border-gray-100">
            <button onclick="window.navigate('menu')" id="btn-menu" class="nav-btn py-3 rounded-xl font-bold text-[10px] uppercase transition-all active"><i class="fas fa-utensils block text-sm mb-1"></i>Men√π</button>
            <button onclick="window.navigate('custom')" id="btn-custom" class="nav-btn py-3 rounded-xl font-bold text-[10px] uppercase transition-all"><i class="fas fa-plus-circle block text-sm mb-1"></i>Crea</button>
            <button onclick="window.navigate('cart')" id="btn-cart" class="nav-btn py-3 rounded-xl font-bold text-[10px] uppercase transition-all relative">
                <i class="fas fa-shopping-basket block text-sm mb-1"></i>Ordine
                <span id="cart-count" class="absolute top-1 right-1 bg-red-500 text-white text-[9px] h-4 w-4 rounded-full flex items-center justify-center border border-white">0</span>
            </button>
            <button onclick="window.navigate('history')" id="btn-history" class="nav-btn py-3 rounded-xl font-bold text-[10px] uppercase transition-all"><i class="fas fa-users block text-sm mb-1"></i>Tutti</button>
        </nav>

        <main>
            <section id="menu-view" class="view active">
                <div class="space-y-4 mb-6">
                    <input type="search" id="search-input" placeholder="Cerca un piatto..." class="w-full p-4 border border-gray-200 rounded-2xl outline-none focus:ring-2 focus:ring-primary shadow-sm">
                    <div class="grid grid-cols-2 gap-2">
                        <select id="category-select" class="p-3 bg-white border border-gray-200 rounded-xl text-xs font-bold outline-none cursor-pointer"></select>
                        <select id="diet-select" class="p-3 bg-white border border-gray-200 rounded-xl text-xs font-bold outline-none cursor-pointer"></select>
                    </div>
                </div>
                <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-10"></div>
            </section>

            <section id="custom-view" class="view">
                <h2 class="text-2xl font-black mb-6">Crea il Tuo Prodotto</h2>
                <div class="bg-white p-5 rounded-3xl shadow-sm mb-4 border border-gray-100">
                    <h3 class="text-xs font-black text-gray-400 uppercase mb-4 text-center">1. Scegli la base</h3>
                    <div class="flex gap-4">
                        <button onclick="window.selectBase('Panino')" class="flex-1 p-6 bg-gray-50 rounded-2xl border-2 border-transparent hover:border-primary transition-all flex flex-col items-center">
                            <i class="fas fa-bread-slice text-3xl text-primary mb-2"></i><span class="font-bold text-sm">Panino</span>
                        </button>
                        <button onclick="window.selectBase('Pizza Ripiena')" class="flex-1 p-6 bg-gray-50 rounded-2xl border-2 border-transparent hover:border-primary transition-all flex flex-col items-center">
                            <i class="fas fa-pizza-slice text-3xl text-primary mb-2"></i><span class="font-bold text-sm">Pizza</span>
                        </button>
                    </div>
                </div>
                <div id="custom-subtype-container" class="bg-white p-5 rounded-3xl shadow-sm mb-4 border border-gray-100 hidden text-center">
                    <h3 class="text-xs font-black text-gray-400 uppercase mb-4">2. Variante</h3>
                    <div id="subtype-list" class="grid grid-cols-2 gap-2"></div>
                </div>
                <div id="custom-ingredients-container" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="ingredients-grid" class="md:col-span-2 grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                        <div class="md:col-span-1">
                            <div class="bg-white p-6 rounded-3xl shadow-xl sticky top-24 border border-gray-50">
                                <h4 id="custom-summary-title" class="font-bold text-xs mb-4 uppercase text-primary border-b pb-2">Riepilogo</h4>
                                <ul id="custom-summary-list" class="text-[10px] space-y-1 mb-4"></ul>
                                <div class="flex justify-between items-center mb-6 pt-2 border-t">
                                    <span class="text-xs font-bold">Prezzo:</span>
                                    <span id="custom-price-display" class="text-xl font-black text-primary">‚Ç¨3.50</span>
                                </div>
                                <button id="add-custom-to-cart-btn" onclick="window.addCustomToCart()" class="w-full bg-secondary text-white font-black py-4 rounded-2xl shadow-lg">AGGIUNGI</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="cart-view" class="view">
                <h2 class="text-2xl font-black mb-6 tracking-tighter">Il Mio Ordine</h2>
                <div id="cart-content-wrapper" class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 mb-4">
                    <div id="cart-items-list"></div>
                    <div id="cart-options" class="mt-8 space-y-6 hidden">
                        <div>
                            <label class="block text-xs font-black text-red-700 uppercase mb-2">Allergie o Note:</label>
                            <textarea id="allergies-input" class="w-full p-4 border border-red-100 rounded-2xl bg-red-50/30 outline-none text-sm"></textarea>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-4 rounded-2xl">
                            <span class="text-xs font-bold uppercase tracking-widest">Ti servono le posate?</span>
                            <button onclick="window.togglePosate()" id="posate-btn" class="px-6 py-2 rounded-full font-black text-[10px] bg-gray-200 uppercase">No</button>
                        </div>
                        <div class="flex justify-between items-end border-t pt-6">
                            <span class="text-gray-400 font-bold text-xs uppercase">Totale</span>
                            <span id="cart-total-display" class="text-4xl font-black text-primary">‚Ç¨0.00</span>
                        </div>
                        <button onclick="window.sendOrder()" class="w-full bg-primary text-white font-black py-5 rounded-[2rem] shadow-xl text-lg uppercase tracking-widest">Invia Ordine</button>
                    </div>
                </div>
            </section>

            <section id="history-view" class="view">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black">Riepilogo Ordini</h2>
                    <div class="flex gap-2">
                        <button id="admin-export-btn" onclick="window.exportFullHistory()" class="hidden bg-gray-900 text-white text-[10px] font-bold px-4 py-2 rounded-xl uppercase shadow-md"><i class="fas fa-file-csv mr-1"></i> Storico</button>
                        <button id="btn-copy-summary" onclick="window.copyDailySummary()" class="bg-primary text-white text-[10px] font-bold px-4 py-2 rounded-xl uppercase shadow-md"><i class="fas fa-copy mr-1"></i> Ristoratore</button>
                    </div>
                 </div>
                 <div id="all-orders-list" class="space-y-3 pb-20"></div>
                 <div class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[90%] max-w-lg bg-white p-5 rounded-3xl shadow-2xl border-t-4 border-primary flex justify-between items-center z-[60]">
                     <span class="text-gray-400 font-black text-[10px] uppercase">Incasso Oggi</span>
                     <span id="grand-total-display" class="text-2xl font-black text-primary">‚Ç¨0.00</span>
                 </div>
            </section>
        </main>
    </div>

    <div id="user-modal" class="fixed inset-0 bg-gray-900/90 backdrop-blur-md flex items-center justify-center z-[100] hidden p-4">
        <div class="bg-white p-8 rounded-[3rem] shadow-2xl w-full max-w-sm text-center">
            <h3 class="text-2xl font-black mb-6">Dati per l'ordine</h3>
            <input type="text" id="user-name-input" placeholder="Nome e Cognome" class="w-full p-5 border-2 border-gray-100 rounded-3xl mb-3 outline-none focus:border-primary text-center font-bold">
            <input type="email" id="user-email-input" placeholder="Email" class="w-full p-5 border-2 border-gray-100 rounded-3xl mb-8 outline-none focus:border-primary text-center font-bold text-sm">
            <button id="save-user-btn" class="w-full bg-primary text-white font-black py-5 rounded-3xl shadow-lg uppercase tracking-widest">Inizia</button>
        </div>
    </div>

    <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 bg-gray-900 text-white py-4 px-8 rounded-full shadow-2xl z-[200] opacity-0 transition-all duration-300 pointer-events-none scale-90">
        <p id="toast-message" class="text-xs font-black uppercase tracking-widest"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeFirestore, persistentLocalCache, collection, onSnapshot, addDoc, serverTimestamp, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG COSTANTI (GLOBAL MODULO) ---
        const DIETS_CONFIG = { "carne/pesce": "ü•© Carne/Pesce", "vegetariano": "üßÄ Vegetariano", "vegano": "üå± Vegano" };
        
        const INGREDIENTS_DATA = [
            { id: 'bresaola', name: 'Bresaola' }, { id: 'brie', name: 'Brie' }, { id: 'broccoletti', name: 'Broccoletti' },
            { id: 'capocollo', name: 'Capocollo' }, { id: 'carciofini', name: 'Carciofini' }, { id: 'cicoria', name: 'Cicoria' },
            { id: 'frittata', name: 'Frittata' }, { id: 'insalata', name: 'Insalata' }, { id: 'lattuga', name: 'Lattuga' },
            { id: 'melanzane-grigliate', name: 'Melanzane Grigliate' }, { id: 'mortadella', name: 'Mortadella' },
            { id: 'mozzarella', name: 'Mozzarella' }, { id: 'olive', name: 'Olive' }, { id: 'parmigiano', name: 'Parmigiano' },
            { id: 'pecorino', name: 'Pecorino' }, { id: 'peperoni-grigliati', name: 'Peperoni Grigliati' },
            { id: 'pom-secchi', name: 'Pomodori Secchi' }, { id: 'pomodoro', name: 'Pomodoro' }, { id: 'porchetta', name: 'Porchetta' },
            { id: 'primo-sale', name: 'Primo Sale' }, { id: 'p-cotto', name: 'Prosciutto Cotto' }, { id: 'p-crudo', name: 'Prosciutto Crudo' },
            { id: 'rucola', name: 'Rucola' }, { id: 'salame', name: 'Salame' }, { id: 'scamorza', name: 'Scamorza' },
            { id: 'scarola', name: 'Scarola' }, { id: 'speck', name: 'Speck' }, { id: 'stracchino', name: 'Stracchino' },
            { id: 'stracciatella', name: 'Stracciatella' }, { id: 'tacchino-arrosto', name: 'Tacchino Arrosto' }, { id: 'zucchine-grigliate', name: 'Zucchine Grigliate' }
        ].sort((a,b) => a.name.localeCompare(b.name));

        const RAW_MENU = {
            "Men√π Combinati": [
                { name: "Panino + acqua 50 cl", price: 4.0, diet: ["carne/pesce", "vegetariano", "vegano"] },
                { name: "Panino + lattina 33 cl", price: 4.5, diet: ["carne/pesce", "vegetariano", "vegano"] },
                { name: "Panino + bevanda 50 cl", price: 5.0, diet: ["carne/pesce", "vegetariano", "vegano"] }
            ],
            "Gastronomia": [
                { name: "Melanzane alla parmigiana (grigliate)", price: 6.0, desc: "Melanzane grigliate, Pomodoro, Parmigiano (250-300g)", diet: ["vegetariano"] },
                { name: "Lasagna classica al rag√π", price: 6.0, desc: "Sfoglia all'uovo, Rag√π di carne, Besciamella (250-300g)", diet: ["carne/pesce"] },
                { name: "Lasagna bianca ai carciofi", price: 6.0, desc: "Besciamella, Carciofi, Parmigiano (250-300g)", diet: ["vegetariano"] },
                { name: "Lasagna bianca funghi piselli e salsiccia", price: 6.0, desc: "Funghi, Piselli, Salsiccia (250-300g)", diet: ["carne/pesce"] },
                { name: "Cous cous vegetale con pollo", price: 4.0, diet: ["carne/pesce"] },
                { name: "Cous cous vegetale", price: 4.0, diet: ["vegano"] },
                { name: "Riso Venere gamberi e zucchine", price: 4.0, diet: ["carne/pesce"] },
                { name: "Pasta fredda tonno e olive", price: 4.0, diet: ["carne/pesce"] },
                { name: "Pomodori con il riso (2 pz)", price: 6.0, diet: ["vegano"] },
                { name: "Ovoline di bufala 150g", price: 1.0, diet: ["vegetariano"] }
            ],
            "Verdure": [
                { name: "Melanzane grigliate", price: 2.0, isCustomPriced: true, pricingOptions: [{text:"100g-2‚Ç¨", value:"2.00"}, {text:"150g-3‚Ç¨", value:"3.00"}, {text:"200g-4‚Ç¨", value:"4.00"}], diet: ["vegano"] },
                { name: "Zucchine grigliate", price: 2.0, isCustomPriced: true, pricingOptions: [{text:"100g-2‚Ç¨", value:"2.00"}, {text:"150g-3‚Ç¨", value:"3.00"}, {text:"200g-4‚Ç¨", value:"4.00"}], diet: ["vegano"] },
                { name: "Cicoria ripassata", price: 2.0, isCustomPriced: true, pricingOptions: [{text:"100g-2‚Ç¨", value:"2.00"}, {text:"150g-3‚Ç¨", value:"3.00"}, {text:"200g-4‚Ç¨", value:"4.00"}], diet: ["vegano"] },
                { name: "Broccoletti ripassati", price: 2.0, isCustomPriced: true, pricingOptions: [{text:"100g-2‚Ç¨", value:"2.00"}, {text:"150g-3‚Ç¨", value:"3.00"}, {text:"200g-4‚Ç¨", value:"4.00"}], diet: ["vegano"] }
            ],
            "Panini": [
                { name: "Crudo pomodoro mozzarella", price: 3.5, diet: ["carne/pesce"] },
                { name: "Cotto scamorza e verdura", price: 3.5, diet: ["carne/pesce"] },
                { name: "Porchetta di Ariccia", price: 3.5, diet: ["carne/pesce"] },
                { name: "Bresaola parmigiano e rughetta", price: 3.5, diet: ["carne/pesce"] },
                { name: "Brasato di manzo e verdura", price: 3.5, diet: ["carne/pesce"] }
            ],
            "Pizze": [
                { name: "Pizza Crudo e Mozzarella", price: 3.5, diet: ["carne/pesce"] },
                { name: "Pizza bresaola filadelfia rughetta", price: 3.5, diet: ["carne/pesce"] },
                { name: "Pizza rustica: Scarola e olive", price: 8.0, isCustomPriced: true, pricingOptions: [{text:"Intera-8‚Ç¨", value:"8.00"}, {text:"Mezza-4‚Ç¨", value:"4.00"}, {text:"1/4-2‚Ç¨", value:"2.00"}], diet: ["vegano"] }
            ],
            "Prodotti da Forno": [
                { name: "Pane di Lariano", price: 0.75, isCustomPriced: true, pricingOptions: [{text:"250g-0.75‚Ç¨", value:"0.75"}, {text:"500g-1.50‚Ç¨", value:"1.50"}, {text:"1kg-3.00‚Ç¨", value:"3.00"}], diet: ["vegano"] }
            ]
        };

        const state = {
            user: JSON.parse(localStorage.getItem('dose_user')) || null,
            cart: [], currentView: 'menu', search: '', cat: 'all', diet: 'all', posate: false,
            custom: { base: null, subtype: null, ings: [], total: 3.5 },
            ordersToday: [],
            menuData: []
        };

        const firebaseConfig = { apiKey: "AIzaSyCQJsNbgaR89gF_1vLe6H4DPboOhQvm9nI", authDomain: "app-ordini-pranzo-alimentari.firebaseapp.com", projectId: "app-ordini-pranzo-alimentari", storageBucket: "app-ordini-pranzo-alimentari.appspot.com", messagingSenderId: "553169964686", appId: "1:553169964686:web:7f8ca6f32a301949e4c3df" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- GLOBAL FUNCTIONS ATTACHED TO WINDOW ---
        window.toast = (m) => {
            const el = document.getElementById('toast');
            document.getElementById('toast-message').textContent = m;
            el.style.opacity = '1';
            setTimeout(() => el.style.opacity = '0', 2000);
        };

        window.navigate = (v) => {
            state.currentView = v;
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.getElementById(`${v}-view`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.id === `btn-${v}`));
            if(v === 'cart') renderCart();
            if(v === 'history') syncOrders();
        };

        window.addStdToCart = (id) => {
            const item = state.menuData.find(i => i.id === id);
            const select = document.querySelector(`select[data-pid="${id}"]`);
            const price = select ? parseFloat(select.value) : item.price;
            const det = select ? `Opzione: ${select.options[select.selectedIndex].text.split('-')[0]}` : "";
            state.cart.push({ ...item, price, details: det, cartId: Date.now() });
            document.getElementById('cart-count').textContent = state.cart.length;
            window.toast("Aggiunto!");
        };

        window.selectBase = (b) => {
            state.custom.base = b;
            state.custom.ings = [];
            const subs = b === 'Panino' ? ['Pane arabo','Ciabattina','5 cereali','Integrale'] : ['Pizza classica'];
            document.getElementById('subtype-list').innerHTML = subs.map(s => `
                <button onclick="window.setSubtype('${s}')" class="p-4 bg-gray-50 rounded-2xl border-2 border-transparent font-bold text-[10px] uppercase hover:border-primary transition-all">${s}</button>
            `).join('');
            document.getElementById('custom-subtype-container').classList.remove('hidden');
        };

        window.setSubtype = (s) => {
            state.custom.subtype = s;
            document.getElementById('custom-ingredients-container').classList.remove('hidden');
            renderIngredients();
            updateCustomSummary();
        };

        window.addIng = (id) => {
            state.custom.ings.push(INGREDIENTS_DATA.find(i => i.id === id));
            renderIngredients(); updateCustomSummary();
        };

        window.removeIng = (idx) => {
            state.custom.ings.splice(idx, 1);
            renderIngredients(); updateCustomSummary();
        };

        window.addCustomToCart = () => {
            const c = state.custom;
            if(!c.subtype || c.ings.length === 0) return window.toast("Scegli gli ingredienti!");
            state.cart.push({ name: `${c.base} (${c.subtype})`, price: c.total, cat: 'Personalizzato', details: c.ings.map(i=>i.name).join(', '), cartId: Date.now() });
            document.getElementById('cart-count').textContent = state.cart.length;
            state.custom = { base:null, subtype:null, ings:[], total:3.5 };
            document.getElementById('custom-subtype-container').classList.add('hidden');
            document.getElementById('custom-ingredients-container').classList.add('hidden');
            window.navigate('menu');
            window.toast("Creato e aggiunto!");
        };

        window.removeFromCart = (id) => {
            state.cart = state.cart.filter(i => i.cartId !== id);
            document.getElementById('cart-count').textContent = state.cart.length;
            renderCart();
        };

        window.togglePosate = () => {
            state.posate = !state.posate;
            const b = document.getElementById('posate-btn');
            b.textContent = state.posate ? 'Si' : 'No';
            b.classList.toggle('bg-primary', state.posate);
            b.classList.toggle('text-white', state.posate);
        };

        window.sendOrder = async () => {
            if(!state.user) return document.getElementById('user-modal').classList.remove('hidden');
            try {
                await addDoc(ordersCol, { 
                    user: state.user.name, email: state.user.email,
                    items: state.cart, total: state.cart.reduce((s,i)=>s+i.price,0),
                    allergies: document.getElementById('allergies-input').value,
                    posate: state.posate ? 'Si' : 'No',
                    createdAt: serverTimestamp() 
                });
                state.cart = []; document.getElementById('cart-count').textContent='0'; window.navigate('menu'); window.toast("Ordine inviato!");
            } catch(e) { alert("Errore di rete."); }
        };

        window.copyDailySummary = () => {
            const sum = {};
            state.ordersToday.forEach(o => o.items.forEach(i => {
                const k = i.name + (i.details ? ` (${i.details})` : "");
                sum[k] = (sum[k] || 0) + 1;
            }));
            const text = "PREPARAZIONE DOSEPRANZA:\n" + Object.entries(sum).map(([k,v]) => `- ${v}x ${k}`).join('\n');
            navigator.clipboard.writeText(text).then(() => window.toast("Riepilogo copiato!"));
        };

        window.exportFullHistory = async () => {
            const snap = await getDocs(query(ordersCol, orderBy("createdAt", "desc")));
            let csv = "OrderID;TimestampISO8601;DataLeggibile;UserID;Utente;EmailUtente;Prodotto;Dettagli;CategoriaProdotto;Quantita;PrezzoUnitario;TotaleRiga;MetodoPagamento;Allergie;Posate;CanaleOrdine;StatoPagamento\n";
            snap.forEach(d => {
                const o = d.data();
                o.items.forEach(i => {
                    csv += `${d.id};${o.createdAt?.toDate().toISOString()};${o.createdAt?.toDate().toLocaleString()};Auth;${o.user};${o.email};${i.name};${i.details || ""};${i.cat};1;${i.price};${o.total};Satispay;${o.allergies || "No"};${o.posate || "No"};Web;Da Pagare\n`;
                });
            });
            const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "Storico_Ordini.csv"; link.click();
        };

        // --- INTERNAL LOGIC ---
        function renderMenu() {
            const filtered = state.menuData.filter(item => {
                const sMatch = item.name.toLowerCase().includes(state.search.toLowerCase());
                const cMatch = state.cat === 'all' || item.cat === state.cat;
                const dMatch = state.diet === 'all' || (item.diet && item.diet.includes(state.diet));
                return sMatch && cMatch && dMatch;
            });

            let curCat = "";
            document.getElementById('menu-container').innerHTML = filtered.map(i => {
                let html = "";
                if(i.cat !== curCat) {
                    curCat = i.cat;
                    html += `<div class="col-span-full mt-6 mb-2 font-black text-[10px] uppercase text-primary/50 border-b border-primary/10 pb-1 tracking-widest">${curCat}</div>`;
                }
                const pricing = i.isCustomPriced 
                    ? `<select data-pid="${i.id}" class="text-[9px] p-2 border rounded-xl bg-gray-50 font-bold outline-none w-full">${i.pricingOptions.map(o => `<option value="${o.value}">${o.text}</option>`).join('')}</select>`
                    : `<span class="font-black text-primary text-lg">‚Ç¨${i.price.toFixed(2)}</span>`;

                html += `<div class="bg-white p-5 rounded-[2rem] shadow-sm flex flex-col justify-between border border-transparent hover:shadow-xl transition-all">
                    <div><h4 class="font-bold text-sm product-title mb-1 leading-tight text-gray-800">${i.name}</h4><p class="text-[9px] text-gray-300 italic">${i.cat}</p></div>
                    <div class="mt-4 flex justify-between items-center gap-2">${pricing}<button onclick="window.addStdToCart('${i.id}')" class="bg-primary text-white h-10 w-10 rounded-2xl shadow-lg flex items-center justify-center flex-shrink-0"><i class="fas fa-plus"></i></button></div>
                </div>`;
                return html;
            }).join('');
        }

        function renderIngredients() {
            document.getElementById('ingredients-grid').innerHTML = INGREDIENTS_DATA.map(ing => {
                const count = state.custom.ings.filter(i => i.id === ing.id).length;
                return `<div onclick="window.addIng('${ing.id}')" class="ingredient-card bg-white p-3 rounded-2xl border-2 border-transparent shadow-sm text-center cursor-pointer transition-all relative ${count > 0 ? 'selected' : ''}">
                    <p class="text-[9px] font-bold leading-tight">${ing.name}</p>
                    ${count > 0 ? `<span class="absolute -top-1 -right-1 bg-primary text-white text-[9px] h-4 w-4 rounded-full flex items-center justify-center font-black shadow-md">${count}</span>` : ''}
                </div>`;
            }).join('');
        }

        function updateCustomSummary() {
            const s = state.custom;
            const extra = Math.max(0, s.ings.length - 3) * 1.0;
            s.total = 3.5 + extra;
            document.getElementById('custom-price-display').textContent = `‚Ç¨${s.total.toFixed(2)}`;
            document.getElementById('custom-summary-list').innerHTML = s.ings.map((n, idx) => `<li class="flex justify-between items-center bg-gray-50 p-2 rounded-xl"><span>${n.name}</span><i class="fas fa-times text-red-300 cursor-pointer" onclick="window.removeIng(${idx})"></i></li>`).join('');
        }

        function renderCart() {
            const wrapper = document.getElementById('cart-items-list');
            const options = document.getElementById('cart-options');
            if(state.cart.length === 0) {
                wrapper.innerHTML = `<p class="text-center py-10 text-gray-300 font-bold uppercase tracking-widest">Carrello vuoto</p>`;
                options.classList.add('hidden'); return;
            }
            options.classList.remove('hidden');
            const tot = state.cart.reduce((s,i) => s+i.price, 0);
            wrapper.innerHTML = state.cart.map(i => `<div class="flex justify-between items-center py-4 border-b border-gray-50 last:border-0">
                <div class="min-w-0 pr-4"><p class="font-black text-sm text-gray-800">${i.name}</p><p class="text-[9px] text-gray-400 italic truncate">${i.details || i.cat}</p><p class="text-xs text-primary font-black">‚Ç¨${i.price.toFixed(2)}</p></div>
                <button onclick="window.removeFromCart(${i.cartId})" class="text-red-300 p-2"><i class="fas fa-trash-alt"></i></button>
            </div>`).join('');
            document.getElementById('cart-total-display').textContent = `‚Ç¨${tot.toFixed(2)}`;
        }

        function syncOrders() {
            onSnapshot(query(ordersCol, orderBy("createdAt", "desc")), snap => {
                let totalG = 0;
                state.ordersToday = snap.docs.map(d => ({id: d.id, ...d.data()}));
                document.getElementById('all-orders-list').innerHTML = state.ordersToday.map(o => {
                    totalG += o.total || 0;
                    return `<div class="bg-white p-4 rounded-2xl border-l-8 border-primary shadow-sm flex justify-between items-center">
                        <div class="min-w-0 pr-4">
                            <p class="font-black text-sm text-gray-800">${o.user}</p>
                            <p class="text-[9px] text-gray-300 font-bold truncate">${o.items.map(i=>i.name).join(' ‚Ä¢ ')}</p>
                        </div>
                        <p class="font-black text-primary text-lg">‚Ç¨${(o.total || 0).toFixed(2)}</p>
                    </div>`;
                }).join('');
                document.getElementById('grand-total-display').textContent = `‚Ç¨${totalG.toFixed(2)}`;
            });
        }

        function checkAdmin(name) {
            if(name === "Marco Tranquilli") document.getElementById('admin-export-btn').classList.remove('hidden');
            else document.getElementById('admin-export-btn').classList.add('hidden');
        }

        // --- INIT APP ---
        const init = () => {
            state.menuData = Object.entries(RAW_MENU).flatMap(([cat, items]) => items.map((it, idx) => ({...it, cat, id: cat.replace(/\s/g,'')+idx})));
            
            // Dropdowns
            document.getElementById('category-select').innerHTML = `<option value="all">TUTTE LE CATEGORIE</option>` + Object.keys(RAW_MENU).map(c => `<option value="${c}">${c.toUpperCase()}</option>`).join('');
            document.getElementById('diet-select').innerHTML = `<option value="all">OGNI REGIME</option>` + Object.entries(DIETS_CONFIG).map(([k,v]) => `<option value="${k}">${v.toUpperCase()}</option>`).join('');

            // Listeners
            document.getElementById('search-input').oninput = (e) => { state.search = e.target.value; renderMenu(); };
            document.getElementById('category-select').onchange = (e) => { state.cat = e.target.value; renderMenu(); };
            document.getElementById('diet-select').onchange = (e) => { state.diet = e.target.value; renderMenu(); };

            document.getElementById('save-user-btn').onclick = () => {
                const n = document.getElementById('user-name-input').value.trim();
                const e = document.getElementById('user-email-input').value.trim();
                if(n && e) {
                    state.user = { name: n, email: e };
                    localStorage.setItem('dose_user', JSON.stringify(state.user));
                    document.getElementById('user-modal').classList.add('hidden');
                    checkAdmin(n);
                    window.toast(`Benvenuto ${n.split(' ')[0]}`);
                }
            };

            onAuthStateChanged(auth, u => { 
                if(!u) signInAnonymously(auth); 
                if(!state.user) {
                    document.getElementById('user-modal').classList.remove('hidden');
                } else {
                    checkAdmin(state.user.name);
                }
            });

            renderMenu();
        };

        init();
    </script>
</body>
</html>
