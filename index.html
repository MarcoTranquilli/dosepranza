<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dosemagna</title>
    <link rel="icon" href="data:;base64,=">
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        primary: { light: '#e8b39a', DEFAULT: '#D6804F', dark: '#c0673a', '100': '#fef4ef', '800': '#8c502f' },
                        secondary: { light: '#a1bb96', DEFAULT: '#709460', dark: '#5a794d', '100': '#eef4ec', '800': '#415738' },
                        background: '#F3F1E7', 'text-main': '#3B3F2F',
                    }
                }
            }
        }
    </script>
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        .view { display: none; }
        .view.active { display: block; }
        .ingredient-card.selected { border-color: #D6804F; box-shadow: 0 0 0 3px rgba(214, 128, 79, 0.5); transform: translateY(-4px); }
        .toggle-checkbox:checked { right: 0; border-color: #709460; }
        .toggle-checkbox:checked + .toggle-label { background-color: #709460; }
        input::-webkit-calendar-picker-indicator { display: none !important; opacity: 0; }
    </style>
</head>
<body class="bg-background text-text-main pb-20">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        <header class="mb-6 flex flex-col items-center">
            <img src="https://i.postimg.cc/L6H20zfp/logo-dosepranza-People-About-Food.png" alt="Dosepranza Logo" class="w-64 md:w-96 mx-auto">
            <div class="bg-primary-100 border-l-4 border-primary text-primary-800 p-4 rounded-md my-4 w-full mt-6 shadow-sm">
                <p class="font-bold text-sm md:text-base">Attenzione: Ordine entro le 11:30.</p>
                <p class="text-sm md:text-base">Consegna gratuita stimata ore 12:30.</p>
            </div>
        </header>

        <nav id="main-nav" class="grid grid-cols-2 md:flex md:justify-center gap-2 bg-white/80 backdrop-blur-md p-3 rounded-xl shadow-lg mb-6 sticky top-2 z-40 border border-white/50">
            <a href="#menu-view" data-view="menu" class="nav-btn flex items-center justify-center text-center py-3 px-2 rounded-lg font-semibold text-sm md:text-base text-text-main transition-all duration-300 active:scale-95"><i class="fas fa-utensils mr-2"></i>Menù</a>
            <a href="#custom-sandwich-view" data-view="custom-sandwich" class="nav-btn flex items-center justify-center text-center py-3 px-2 rounded-lg font-semibold text-sm md:text-base text-text-main transition-all duration-300 active:scale-95"><i class="fas fa-plus-circle mr-2"></i>Crea</a>
            <a href="#my-order-view" data-view="my-order" class="nav-btn flex items-center justify-center text-center py-3 px-2 rounded-lg font-semibold text-sm md:text-base text-text-main transition-all duration-300 active:scale-95"><i class="fas fa-shopping-basket mr-2"></i>Ordine <span id="cart-count" class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 inline-flex items-center justify-center ml-1 shadow-sm">0</span></a>
            <a href="#all-orders-view" data-view="all-orders" class="nav-btn flex items-center justify-center text-center py-3 px-2 rounded-lg font-semibold text-sm md:text-base text-text-main transition-all duration-300 active:scale-95"><i class="fas fa-users mr-2"></i>Tutti</a>
        </nav>

        <main>
            <section id="menu-view" class="view">
                <h2 class="text-2xl md:text-3xl font-extrabold mb-4">Scegli cosa ordinare</h2>
                <div class="flex flex-col sm:flex-row gap-3 mb-4 items-center">
                    <div class="relative w-full sm:flex-grow">
                        <input type="search" id="search-input" placeholder="Cerca un piatto..." class="w-full p-3 pl-10 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-primary text-base">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <select id="category-select" class="w-full sm:w-auto p-3 border border-gray-300 rounded-xl bg-white shadow-sm focus:ring-2 focus:ring-primary"></select>
                </div>
                <div id="menu-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-10"></div>
            </section>

            <section id="custom-sandwich-view" class="view">
                <h2 class="text-2xl md:text-3xl font-extrabold mb-4">Crea il Tuo Prodotto</h2>
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-md mb-6 text-center">
                    <h3 class="text-lg font-bold mb-3">1. Scegli la base</h3>
                    <div id="base-choice-container" class="flex gap-4">
                        <button data-type="panino" class="choice-btn flex-1 p-4 bg-gray-50 rounded-xl shadow-sm border-2 border-transparent transition-all hover:bg-orange-50 flex flex-col items-center">
                            <i class="fas fa-bread-slice text-3xl text-primary mb-2"></i><span class="font-semibold">Panino</span>
                        </button>
                        <button data-type="pizza" class="choice-btn flex-1 p-4 bg-gray-50 rounded-xl shadow-sm border-2 border-transparent transition-all hover:bg-orange-50 flex flex-col items-center">
                            <i class="fas fa-pizza-slice text-3xl text-primary mb-2"></i><span class="font-semibold">Pizza</span>
                        </button>
                    </div>
                </div>
                <div id="subtype-choice-container" class="bg-white p-4 rounded-2xl shadow-md mb-6 hidden text-center">
                    <h3 class="text-lg font-bold mb-3">2. Scegli la variante</h3>
                    <div id="subtype-options" class="grid grid-cols-2 gap-3 p-2"></div>
                </div>
                <div id="ingredients-step-container" class="hidden">
                    <h3 class="text-lg font-bold mb-3 text-center">3. Aggiungi gli ingredienti</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="ingredients-list" class="md:col-span-2 grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                        <div id="sandwich-summary" class="md:col-span-1">
                            <div class="bg-white p-5 rounded-2xl shadow-lg border sticky top-24">
                                <h3 class="font-bold border-b pb-2 mb-3 text-sm">Riepilogo Personalizzato</h3>
                                <p class="font-semibold text-primary mb-2 text-xs" id="sandwich-base-summary"></p>
                                <ul id="selected-ingredients-list" class="space-y-1 text-[10px] mb-4 overflow-y-auto max-h-40"></ul>
                                <div class="border-t pt-3">
                                    <div class="flex justify-between items-end">
                                        <span class="text-gray-500 text-xs">Totale:</span>
                                        <p class="text-xl font-extrabold text-primary" id="sandwich-total-price">€0.00</p>
                                    </div>
                                    <button id="add-sandwich-to-cart-btn" class="w-full mt-4 bg-secondary text-white font-bold py-2 rounded-xl shadow-md disabled:opacity-50 text-xs">Aggiungi al Carrello</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="my-order-view" class="view">
                <h2 class="text-2xl md:text-3xl font-extrabold mb-4">Il Tuo Carrello</h2>
                <div id="my-order-content" class="bg-white p-4 md:p-6 rounded-2xl shadow-md"></div>
            </section>

            <section id="all-orders-view" class="view">
                 <div class="flex justify-between items-center mb-6">
                     <h2 class="text-2xl font-extrabold">Ordini di Oggi</h2>
                     <button id="export-history-btn" class="bg-primary text-white font-bold py-2 px-4 rounded-lg text-sm"><i class="fas fa-download mr-2"></i>Export CSV</button>
                 </div>
                 <div id="all-orders-list" class="space-y-4"></div>
                 <div class="mt-6 bg-white p-5 rounded-2xl shadow-lg text-right border-t-4 border-primary">
                     <span class="font-bold text-gray-600">Totale Globale:</span>
                     <span id="grand-total" class="text-3xl font-extrabold text-primary ml-2">€0.00</span>
                 </div>
            </section>
        </main>
    </div>

    <div id="user-modal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
            <h3 class="text-2xl font-bold mb-4">Benvenuto!</h3>
            <input type="text" id="username-input" placeholder="Nome e Cognome..." class="w-full p-3 border-2 rounded-xl mb-4 focus:border-primary outline-none">
            <input type="email" id="user-email-input" placeholder="Email..." class="w-full p-3 border-2 rounded-xl mb-6 focus:border-primary outline-none">
            <button id="save-username-btn" class="w-full bg-primary text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95">Salva</button>
        </div>
    </div>

    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-3 px-6 rounded-full shadow-2xl z-[60] opacity-0 transition-opacity duration-300 pointer-events-none">
        <p id="toast-message" class="text-sm font-medium"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, doc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCQJsNbgaR89gF_1vLe6H4DPboOhQvm9nI", authDomain: "app-ordini-pranzo-alimentari.firebaseapp.com", projectId: "app-ordini-pranzo-alimentari", storageBucket: "app-ordini-pranzo-alimentari.appspot.com", messagingSenderId: "553169964686", appId: "1:553169964686:web:7f8ca6f32a301949e4c3df" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ordersCollectionRef = collection(db, "orders");

        const CUSTOM_PRODUCT_BASE_PRICE = 3.50;
        const CATEGORY_ORDER = ["Prodotti da Forno", "Menù Combinati", "Gastronomia", "Panini", "Pizze", "Insalatone", "Verdure", "Fritti", "Dessert"];
        const BASE_OPTIONS = { 
            panino: { name: 'Panino ripieno', subtypes: ['Pane arabo', 'Ciabattina', 'Medaglione ai 5 cereali', 'Ciabattina integrale'] }, 
            pizza: { name: 'Pizza Ripiena', subtypes: ['Pizza classica'] } 
        };

        const INGREDIENTS_LIST = [
            { id: 'bresaola', name: 'Bresaola' }, { id: 'brie', name: 'Brie' }, { id: 'broccoletti', name: 'Broccoletti' },
            { id: 'capocollo', name: 'Capocollo' }, { id: 'carciofini', name: 'Carciofini' }, { id: 'cicoria', name: 'Cicoria' },
            { id: 'frittata', name: 'Frittata' }, { id: 'insalata', name: 'Insalata' }, { id: 'lattuga', name: 'Lattuga' },
            { id: 'melanzane-grigliate', name: 'Melanzane Grigliate' }, { id: 'mortadella', name: 'Mortadella' },
            { id: 'mozzarella', name: 'Mozzarella' }, { id: 'olive', name: 'Olive' }, { id: 'parmigiano', name: 'Parmigiano' },
            { id: 'pecorino', name: 'Pecorino' }, { id: 'peperoni-grigliati', name: 'Peperoni Grigliati' },
            { id: 'pomodori-secchi', name: 'Pomodori Secchi' }, { id: 'pomodoro', name: 'Pomodoro' },
            { id: 'porchetta', name: 'Porchetta' }, { id: 'primo-sale', name: 'Primo Sale' },
            { id: 'prosciutto-cotto', name: 'Prosciutto Cotto' }, { id: 'prosciutto-crudo', name: 'Prosciutto Crudo' },
            { id: 'rucola', name: 'Rucola' }, { id: 'salame', name: 'Salame' }, { id: 'scamorza', name: 'Scamorza' },
            { id: 'scarola', name: 'Scarola' }, { id: 'speck', name: 'Speck' }, { id: 'stracchino', name: 'Stracchino' },
            { id: 'stracciatella', name: 'Stracciatella' }, { id: 'tacchino-arrosto', name: 'Tacchino Arrosto' },
            { id: 'zucchine-grigliate', name: 'Zucchine Grigliate' }
        ];

        const RAW_MENU = {
            "prodotti da forno": [
                { name: "Pane di Lariano", isCustomPriced: true, description: "Pane rustico a lunga lievitazione, crosta spessa", pricingOptions: [ { text: '250g - 0.75€', value: '0.75' }, { text: '500g - 1.50€', value: '1.50' }, { text: '1kg - 3.00€', value: '3.00' } ] },
                { name: "Ciabatta", isCustomPriced: true, description: "Pane leggero e alveolato, crosta croccante", pricingOptions: [ { text: '250g - 1.00€', value: '1.00' }, { text: '500g - 2.00€', value: '2.00' }, { text: '1kg - 4.00€', value: '4.00' } ] },
                { name: "Pane Casareccio", isCustomPriced: true, description: "Pane tradizionale, mollica compatta", pricingOptions: [ { text: '250g - 0.63€', value: '0.63' }, { text: '500g - 1.25€', value: '1.25' }, { text: '1kg - 2.50€', value: '2.50' } ] },
                { name: "Ciabattine", isCustomPriced: true, description: "Versione piccola della ciabatta, ideale per panini", pricingOptions: [ { text: '250g - 0.75€', value: '0.75' }, { text: '500g - 1.50€', value: '1.50' }, { text: '1kg - 3.00€', value: '3.00' } ] },
                { name: "Rosette", isCustomPriced: true, description: "Pane soffiato, leggero e vuoto all’interno", pricingOptions: [ { text: '250g - 0.75€', value: '0.75' }, { text: '500g - 1.50€', value: '1.50' }, { text: '1kg - 3.00€', value: '3.00' } ] },
                { name: "Pane all'olio", isCustomPriced: true, description: "Pane morbido e profumato con olio d’oliva", pricingOptions: [ { text: '250g - 2.00€', value: '2.00' }, { text: '500g - 4.00€', value: '4.00' }, { text: '1kg - 8.00€', value: '8.00' } ] },
                { name: "Pane Arabo", isCustomPriced: true, description: "Pane morbido e sottile, ideale per farciture", pricingOptions: [ { text: '250g - 1.25€', value: '1.25' }, { text: '500g - 2.50€', value: '2.50' }, { text: '1kg - 5.00€', value: '5.00' } ] },
                { name: "Pane Azzimo", isCustomPriced: true, description: "Pane senza lievito, sottile e croccante", pricingOptions: [ { text: '250g - 1.25€', value: '1.25' }, { text: '500g - 2.50€', value: '2.50' }, { text: '1kg - 5.00€', value: '5.00' } ] },
                { name: "Pane Integrale", isCustomPriced: true, description: "Pane ricco di fibre, gusto più deciso", pricingOptions: [ { text: '250g - 1.00€', value: '1.00' }, { text: '500g - 2.00€', value: '2.00' }, { text: '1kg - 4.00€', value: '4.00' } ] },
                { name: "Pizza Rossa", isCustomPriced: true, description: "Base croccante con salsa di pomodoro", pricingOptions: [ { text: '200g - 2.00€', value: '2.00' }, { text: '500g - 5.00€', value: '5.00' }, { text: '1kg - 10.00€', value: '10.00' } ] },
                { name: "Pizza Patate", isCustomPriced: true, description: "Pizza bianca con patate sottili e rosmarino", pricingOptions: [ { text: '200g - 2.00€', value: '2.00' }, { text: '500g - 5.00€', value: '5.00' }, { text: '1kg - 10.00€', value: '10.00' } ] },
                { name: "Pizza Bianca", isCustomPriced: true, description: "Semplice, soffice e leggermente salata", pricingOptions: [ { text: '200g - 1.80€', value: '1.80' }, { text: '500g - 4.50€', value: '4.50' }, { text: '1kg - 9.00€', value: '9.00' } ] },
                { name: "Pizzette", price: 1.50, description: "Mini pizze morbide, ideali come snack", allergens: ["G", "L"], diet: ["vegetariano"] }
            ],
            "menù combinati": [
                { name: "Panino + Acqua 50cl", price: 4.00, ingredients: ["Panino a scelta", "Acqua 50cl"], diet: ["carne/pesce", "vegetariano", "vegano"], allergens: ["G", "L", "P"] },
                { name: "Panino + Lattina 33cl", price: 4.50, ingredients: ["Panino a scelta", "Lattina 33cl"], diet: ["carne/pesce", "vegetariano", "vegano"], allergens: ["G", "L", "P"] },
                { name: "Panino + Bibita 50cl", price: 5.00, ingredients: ["Panino a scelta", "Bibita 50cl"], diet: ["carne/pesce", "vegetariano", "vegano"], allergens: ["G", "L", "P"] }
            ],
            "gastronomia": [
                { name: "Melanzane alla parmigiana", price: 6.00, allergens: ["L"], diet: ["vegetariano"], calories: 350, ingredients: ["Melanzane grigliate", "Pomodoro", "Parmigiano"] },
                { name: "Lasagna classica al ragù", price: 6.00, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 550, ingredients: ["Sfoglia all'uovo", "Ragù di carne", "Besciamella"] },
                { name: "Lasagna bianca vegetariana", price: 6.00, allergens: ["G", "L"], diet: ["vegetariano"], calories: 500, ingredients: ["Sfoglia all'uovo", "Besciamella", "Carciofi", "Parmigiano"] },
                { name: "Lasagna funghi e salsiccia", price: 6.00, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 600, ingredients: ["Besciamella", "Funghi", "Piselli", "Salsiccia"] },
                { name: "Cous cous pollo", price: 4.00, allergens: ["G"], diet: ["carne/pesce"], calories: 450, ingredients: ["Cous cous", "Verdure", "Pollo"] },
                { name: "Cous cous vegetale", price: 4.00, allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 350, ingredients: ["Cous cous", "Verdure miste"] },
                { name: "Riso Venere gamberi", price: 4.00, allergens: ["C"], diet: ["carne/pesce"], calories: 420, ingredients: ["Riso Venere", "Gamberi", "Zucchine"] },
                { name: "Insalata di riso", price: 4.00, allergens: [], diet: ["carne/pesce"], calories: 400 },
                { name: "Pasta fredda tonno", price: 4.00, allergens: ["G", "P"], diet: ["carne/pesce"], calories: 450 },
                { name: "Pasta fredda pesto primo sale", price: 4.00, allergens: ["G", "L"], diet: ["vegetariano"], calories: 500 },
                { name: "Insalata di pollo", price: 4.00, allergens: [], diet: ["carne/pesce"], calories: 350 },
                { name: "Riso bresaola limone", price: 4.00, allergens: [], diet: ["carne/pesce"], calories: 380 },
                { name: "Pomodori riso (2 pz)", price: 6.00, allergens: [], diet: ["vegetariano", "vegano"], calories: 320 }
            ],
            "panini": [
                { name: "Crudo pomodoro mozzarella", price: 3.50, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 550, ingredients: ["Crudo", "Pomodoro", "Mozzarella"] },
                { name: "Crudo stracchino rughetta", price: 3.50, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580, ingredients: ["Crudo", "Stracchino", "Rucola"] },
                { name: "Cotto scamorza verdura", price: 3.50, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 520 },
                { name: "Capocollo pecorino pom secchi", price: 3.50, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 600 },
                { name: "Salame pecorino pom secchi", price: 3.50, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 620 },
                { name: "Speck Brie pom secchi", price: 3.50, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 610 },
                { name: "Porchetta", price: 3.50, allergens: ["G"], diet: ["carne/pesce"], calories: 650 },
                { name: "Vegetariano grigliato", price: 3.50, allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 450 },
                { name: "Tacchino arrosto verdura", price: 3.50, allergens: ["G"], diet: ["carne/pesce"], calories: 480 },
                { name: "Fesa tacchino verdura", price: 3.50, allergens: ["G"], diet: ["carne/pesce"], calories: 480 },
                { name: "Bresaola parmigiano rughetta", price: 3.50, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 500 },
                { name: "Bresaola primo sale rughetta", price: 3.50, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 470 },
                { name: "Salmone formaggio", price: 3.50, allergens: ["G", "L", "P"], diet: ["carne/pesce"], calories: 530 },
                { name: "Tonno pomodoro", price: 3.50, allergens: ["G", "P"], diet: ["carne/pesce"], calories: 490 },
                { name: "Tonno carciofini", price: 3.50, allergens: ["G", "P"], diet: ["carne/pesce"], calories: 510 },
                { name: "5 cereali salmone", price: 3.50, allergens: ["G", "L", "P"], diet: ["carne/pesce"], calories: 540 },
                { name: "5 cereali tacchino", price: 3.50, allergens: ["G"], diet: ["carne/pesce"], calories: 490 },
                { name: "Pollo lattuga pomodoro", price: 3.50, allergens: ["G"], diet: ["carne/pesce"], calories: 580 },
                { name: "Brasato manzo verdura", price: 3.50, allergens: ["G"], diet: ["carne/pesce"], calories: 620 }
            ],
            "pizze": [
                { name: "Pizza pollo maionese", price: 3.50, allergens: ["G"], diet: ["carne/pesce"], calories: 560 },
                { name: "Pizza classica bresaola", price: 3.50, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 570 },
                { name: "Pizza tacchino verdure", price: 3.50, allergens: ["G"], diet: ["carne/pesce"], calories: 490 },
                { name: "Crudo mozzarella", price: 3.50, allergens: ["G", "L"] },
                { name: "Speck stracchino rughetta", price: 3.50, allergens: ["G", "L"] },
                { name: "Cotto melanzane", price: 3.50, allergens: ["G", "L"] },
                { name: "Mortadella stracciatella", price: 3.50, allergens: ["G", "L"] },
                { name: "Frittata zucchine", price: 3.50, allergens: ["G", "L"] },
                { name: "Bresaola formaggio", price: 3.50, allergens: ["G", "L"] },
                { name: "Cotto stracchino", price: 3.50, allergens: ["G", "L"] },
                { name: "Pizza Rustica: Scarola", price: 8.00, isCustomPriced: true, pricingOptions: [ { text: 'Intera - 8.00€', value: '8.00' }, { text: 'Mezza - 4.00€', value: '4.00' }, { text: '1/4 - 2.00€', value: '2.00' } ], allergens: ["G"], diet: ["vegetariano", "vegano"] },
                { name: "Pizza Rustica: Cicoria", price: 8.00, isCustomPriced: true, pricingOptions: [ { text: 'Intera - 8.00€', value: '8.00' }, { text: 'Mezza - 4.00€', value: '4.00' }, { text: '1/4 - 2.00€', value: '2.00' } ], allergens: ["G"], diet: ["vegetariano", "vegano"] },
                { name: "Pizza Rustica: Broccoli e salsiccia", price: 8.00, isCustomPriced: true, pricingOptions: [ { text: 'Intera - 8.00€', value: '8.00' }, { text: 'Mezza - 4.00€', value: '4.00' }, { text: '1/4 - 2.00€', value: '2.00' } ], allergens: ["G"], diet: ["carne/pesce"] }
            ],
            "insalatone": [
                { name: "Insalatona Tonno", price: 5.00, diet: ["carne/pesce"], allergens: ["P"], calories: 450, ingredients: ["Misticanza", "Mais", "Olive", "Carote", "Tonno"] },
                { name: "Insalatona Uovo Sodo", price: 5.00, diet: ["vegetariano"], allergens: [], calories: 380, ingredients: ["Misticanza", "Mais", "Olive", "Carote", "Uovo sodo"] },
                { name: "Insalatona Primo Sale", price: 5.00, diet: ["vegetariano"], allergens: ["L"], calories: 420, ingredients: ["Misticanza", "Mais", "Olive", "Carote", "Primo Sale"] }
            ],
            "verdure": [
                { name: "Melanzane", price: 4.00, diet: ["vegetariano", "vegano"], calories: 180 },
                { name: "Zucchine", price: 4.00, diet: ["vegetariano", "vegano"], calories: 160 },
                { name: "Peperoni", price: 4.00, diet: ["vegetariano", "vegano"], calories: 160 },
                { name: "Cicoria ripassata", price: 4.00, diet: ["vegetariano", "vegano"], calories: 140 },
                { name: "Broccoletti ripassati", price: 4.00, diet: ["vegetariano", "vegano"], calories: 150 },
                { name: "Broccoli vapore", price: 4.00, diet: ["vegetariano", "vegano"], calories: 150 },
                { name: "Scarola con olive", price: 4.00, diet: ["vegetariano", "vegano"], calories: 130 }
            ],
            "fritti": [
                { name: "Pizzetta rossa", price: 1.50, isCustomPriced: true, pricingOptions: [ { text: '2 pz - 1.50€', value: '1.50' }, { text: '3 pz - 2.00€', value: '2.00' }, { text: '6 pz - 4.00€', value: '4.00' } ], allergens: ["G"] },
                { name: "Lingua romana", price: 1.50, allergens: ["G"], diet: ["vegetariano", "vegano"] },
                { name: "Supplì", price: 1.50, allergens: ["G", "L"], diet: ["vegetariano"] },
                { name: "Polpetta melanzane", price: 1.50, allergens: ["G", "L"], diet: ["vegetariano"] }
            ],
            "dessert": [
                { name: "Macedonia", price: 3.00, diet: ["vegetariano", "vegano"] },
                { name: "Crostatina", price: 1.50, allergens: ["G"] },
                { name: "Lingue di gatto (1pz)", price: 1.00, allergens: ["G", "L"] },
                { name: "Ferretti glassati (1pz)", price: 2.00, allergens: ["G", "L"] }
            ]
        };

        const state = {
            currentUser: null, currentView: 'menu', searchTerm: '', activeCategoryFilter: 'all',
            cart: [], allOrders: [], menuData: [],
            customSandwich: { base: null, subtype: null, ingredients: [], totalPrice: 0 }
        };
        const dom = {};

        function showToast(msg) {
            dom.toastMessageEl.textContent = msg;
            dom.toastEl.classList.remove('opacity-0');
            setTimeout(() => dom.toastEl.classList.add('opacity-0'), 3000);
        }

        function processMenuData(raw) {
            let id = 1;
            const icons = { gastronomia: 'fa-bowl-food', panini: 'fa-bread-slice', "prodotti da forno": 'fa-wheat-awn', insalatone: 'fa-seedling', pizze: 'fa-pizza-slice', "menù combinati": "fa-box", dessert: "fa-ice-cream", fritti: "fa-utensils", verdure: "fa-carrot" };
            return Object.entries(raw).flatMap(([catKey, items]) => items.map(item => ({
                id: id++, ...item, category: catKey, 
                categoryDisplay: catKey.charAt(0).toUpperCase() + catKey.slice(1),
                icon: icons[catKey] || 'fa-utensils'
            })));
        }

        function renderMenu() {
            const filtered = state.menuData.filter(i => {
                const term = state.searchTerm.toLowerCase();
                return i.name.toLowerCase().includes(term) && 
                       (state.activeCategoryFilter === 'all' || i.category === state.activeCategoryFilter);
            });

            if (filtered.length === 0) {
                dom.menuItemsContainer.innerHTML = '<div class="col-span-full text-center p-10 text-gray-400 font-medium">Nessun prodotto trovato.</div>';
                return;
            }

            let currentCat = '';
            dom.menuItemsContainer.innerHTML = filtered.map(item => {
                let html = '';
                if (item.categoryDisplay !== currentCat) {
                    currentCat = item.categoryDisplay;
                    html += `<div class="col-span-full mt-6 mb-2 font-bold text-xl border-b-2 border-primary-light pb-1">${currentCat}</div>`;
                }

                const priceArea = item.isCustomPriced ? 
                    `<div class="flex items-center gap-2 justify-between w-full">
                        <select data-id="${item.id}" class="portion-select text-[10px] p-1 border rounded bg-white flex-grow mr-2 max-w-[130px]">
                            ${item.pricingOptions.map(o => `<option value="${o.value}">${o.text}</option>`).join('')}
                        </select>
                        <span id="price-display-${item.id}" class="font-bold text-primary shrink-0">€${parseFloat(item.pricingOptions[0].value).toFixed(2)}</span>
                    </div>` : 
                    `<span class="font-bold text-primary text-lg">€${item.price.toFixed(2)}</span>`;

                html += `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-transparent hover:border-primary/20 flex flex-col justify-between h-full transition-all">
                    <div>
                        <div class="flex items-start gap-3 mb-2">
                            <div class="bg-primary/10 p-2 rounded-full text-primary shrink-0 w-10 h-10 flex items-center justify-center"><i class="fas ${item.icon}"></i></div>
                            <div class="min-w-0">
                                <h3 class="font-bold leading-tight truncate text-sm md:text-base">${item.name}</h3>
                                <p class="text-[10px] text-gray-500 mt-1 line-clamp-2 italic">${item.description || item.ingredients?.join(', ') || 'Tradizione e freschezza'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-3 border-t">
                        <div class="mb-3 h-8 flex items-center">${priceArea}</div>
                        <button data-id="${item.id}" class="add-to-cart-btn w-full bg-primary text-white p-2 rounded-xl text-xs font-bold shadow-md active:scale-95 transition-transform">Aggiungi</button>
                    </div>
                </div>`;
                return html;
            }).join('');
        }

        function renderCustomSandwichBuilder() {
            dom.ingredientsList.innerHTML = INGREDIENTS_LIST.map(ing => {
                const count = state.customSandwich.ingredients.filter(i => i.id === ing.id).length;
                const badge = count > 0 ? `<span class="absolute -top-2 -right-2 bg-primary text-white text-[10px] font-bold rounded-full h-5 w-5 flex items-center justify-center border-2 border-white shadow-sm">${count}</span>` : '';
                return `<div data-id="${ing.id}" class="ingredient-card bg-white p-3 rounded-xl border-2 border-transparent shadow-sm relative h-20 flex items-center justify-center text-center cursor-pointer active:scale-95 transition-all">
                    <p class="font-semibold text-xs leading-tight">${ing.name}</p>${badge}
                </div>`;
            }).join('');
            updateSandwichSummary();
        }

        function updateSandwichSummary() {
            const { base, subtype, ingredients } = state.customSandwich;
            if (!base || !subtype) {
                dom.sandwichTotalPrice.textContent = "€0.00";
                dom.addSandwichBtn.disabled = true;
                dom.sandwichBaseSummary.textContent = "Inizia selezionando base e variante";
                return;
            }
            const currentPrice = CUSTOM_PRODUCT_BASE_PRICE + (Math.max(0, ingredients.length - 3) * 1.00);
            state.customSandwich.totalPrice = currentPrice;
            dom.sandwichTotalPrice.textContent = `€${currentPrice.toFixed(2)}`;
            dom.sandwichBaseSummary.textContent = `${BASE_OPTIONS[base].name} (${subtype})`;
            dom.selectedIngredientsList.innerHTML = ingredients.map(i => `<li class="flex items-center gap-1"><i class="fas fa-check text-secondary text-[8px]"></i> ${i.name}</li>`).join('');
            dom.addSandwichBtn.disabled = ingredients.length === 0;
        }

        async function exportData() {
            try {
                const sn = await getDocs(query(ordersCollectionRef, orderBy("createdAt", "desc")));
                const rows = [["Data", "Utente", "Totale EUR", "Dettaglio Prodotti"]];
                sn.forEach(d => {
                    const o = d.data();
                    rows.push([o.createdAt?.toDate().toLocaleString() || 'N/D', o.user, o.total.toFixed(2), o.items.map(i => `${i.quantity}x ${i.name}`).join(" | ")]);
                });
                const csv = rows.map(r => r.join(";")).join("\n");
                const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `Report_Ordini_${new Date().toLocaleDateString()}.csv`;
                a.click();
            } catch (e) { showToast("Errore durante l'esportazione"); }
        }

        function navigate(v) {
            state.currentView = v;
            document.querySelectorAll('.view').forEach(el => el.classList.toggle('active', el.id === `${v}-view`));
            document.querySelectorAll('.nav-btn').forEach(b => {
                const active = b.dataset.view === v;
                b.classList.toggle('bg-primary', active);
                b.classList.toggle('text-white', active);
            });
            if (v === 'menu') renderMenu();
            if (v === 'custom-sandwich') renderCustomSandwichBuilder();
            if (v === 'all-orders') renderAllOrders();
            if (v === 'my-order') renderMyOrder();
        }

        document.body.addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            const link = e.target.closest('a.nav-btn');
            const ingCard = e.target.closest('.ingredient-card');

            if (link) { e.preventDefault(); navigate(link.dataset.view); }
            
            if (btn && btn.classList.contains('add-to-cart-btn')) {
                const item = { ...state.menuData.find(i => i.id === parseInt(btn.dataset.id)) };
                const select = document.querySelector(`select[data-id="${item.id}"]`);
                if (select) {
                    item.price = parseFloat(select.value);
                    item.name = `${item.name} (${select.options[select.selectedIndex].text.split('-')[0].trim()})`;
                }
                state.cart.push({ ...item, cartId: Date.now(), quantity: 1 });
                dom.cartCountEl.textContent = state.cart.length;
                showToast("Aggiunto!");
            }

            if (btn && btn.id === 'export-history-btn') exportData();

            if (btn && btn.dataset.type) {
                state.customSandwich.base = btn.dataset.type;
                dom.subtypeOptions.innerHTML = BASE_OPTIONS[btn.dataset.type].subtypes.map(s => 
                    `<button data-subtype="${s}" class="subtype-btn p-3 bg-gray-50 rounded-xl border-2 border-transparent font-bold text-[10px] hover:bg-orange-100 transition-all">${s}</button>`
                ).join('');
                dom.subtypeChoiceContainer.classList.remove('hidden');
                updateSandwichSummary();
            }

            if (e.target.classList.contains('subtype-btn')) {
                state.customSandwich.subtype = e.target.dataset.subtype;
                dom.ingredientsStepContainer.classList.remove('hidden');
                updateSandwichSummary();
            }

            if (ingCard) {
                const id = ingCard.dataset.id;
                state.customSandwich.ingredients.push(INGREDIENTS_LIST.find(i => i.id === id));
                renderCustomSandwichBuilder();
            }

            if (btn && btn.id === 'add-sandwich-to-cart-btn') {
                const { base, subtype, ingredients, totalPrice } = state.customSandwich;
                state.cart.push({ name: `${BASE_OPTIONS[base].name} (${subtype})`, price: totalPrice, quantity: 1, cartId: Date.now(), details: ingredients.map(i => i.name).join(", ") });
                dom.cartCountEl.textContent = state.cart.length;
                navigate('my-order');
            }

            if (btn && btn.id === 'confirm-order-btn') {
                if(!state.currentUser?.name) return dom.userModal.classList.remove('hidden');
                await addDoc(ordersCollectionRef, { user: state.currentUser.name, total: state.cart.reduce((s,i) => s+(i.price*i.quantity), 0), items: state.cart, createdAt: serverTimestamp() });
                state.cart = [];
                dom.cartCountEl.textContent = '0';
                showToast("Ordine Inviato con Successo!");
                navigate('menu');
            }

            if (btn && btn.id === 'save-username-btn') {
                const n = document.getElementById('username-input').value.trim();
                const em = document.getElementById('user-email-input').value.trim();
                if(n && em) { localStorage.setItem('dosepranza-username', n); localStorage.setItem('dosepranza-useremail', em); state.currentUser = { name: n }; dom.userModal.classList.add('hidden'); }
                else { showToast("Inserisci nome ed email"); }
            }
        });

        document.body.addEventListener('change', (e) => {
            if (e.target.id === 'category-select') { state.activeCategoryFilter = e.target.value; renderMenu(); }
            if (e.target.classList.contains('portion-select')) {
                document.getElementById(`price-display-${e.target.dataset.id}`).textContent = `€${parseFloat(e.target.value).toFixed(2)}`;
            }
        });

        document.body.addEventListener('input', (e) => {
            if (e.target.id === 'search-input') { state.searchTerm = e.target.value; renderMenu(); }
        });

        function renderMyOrder() {
            const tot = state.cart.reduce((s,i) => s + (i.price*i.quantity), 0);
            dom.myOrderContentEl.innerHTML = state.cart.length ? 
                state.cart.map(i => `<div class="flex justify-between border-b py-2"><div class="text-xs font-bold">${i.name}</div><div class="text-primary font-bold">€${i.price.toFixed(2)}</div></div>`).join('') +
                `<div class="flex justify-between font-bold text-xl mt-4"><span>Totale Carrello:</span><span class="text-primary">€${tot.toFixed(2)}</span></div>
                <button id="confirm-order-btn" class="w-full mt-6 bg-primary text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all">Conferma ed Invia Ordine</button>` : 
                `<div class="text-center p-12"><i class="fas fa-shopping-basket text-4xl text-gray-200 mb-3"></i><p class="text-gray-400">Il carrello è vuoto</p></div>`;
        }

        function renderAllOrders() {
            onSnapshot(query(ordersCollectionRef, orderBy("createdAt", "desc")), sn => {
                dom.allOrdersListEl.innerHTML = sn.docs.map(d => {
                    const o = d.data();
                    return `<div class="bg-white p-4 rounded-xl border-l-4 border-primary flex justify-between shadow-sm"><div><div class="font-bold text-sm text-gray-800">${o.user}</div><div class="text-[9px] text-gray-500 mt-1">${o.items.map(i => `${i.quantity}x ${i.name}`).join(", ")}</div></div><div class="font-bold text-primary">€${o.total.toFixed(2)}</div></div>`;
                }).join('');
                const grand = sn.docs.reduce((s,d) => s + d.data().total, 0);
                dom.grandTotalEl.textContent = `€${grand.toFixed(2)}`;
            });
        }

        function init() {
            state.menuData = processMenuData(RAW_MENU);
            Object.assign(dom, {
                menuItemsContainer: document.getElementById('menu-items'), categorySelect: document.getElementById('category-select'),
                cartCountEl: document.getElementById('cart-count'), toastEl: document.getElementById('toast'), toastMessageEl: document.getElementById('toast-message'),
                ingredientsList: document.getElementById('ingredients-list'), sandwichTotalPrice: document.getElementById('sandwich-total-price'),
                addSandwichBtn: document.getElementById('add-sandwich-to-cart-btn'), sandwichBaseSummary: document.getElementById('sandwich-base-summary'),
                subtypeChoiceContainer: document.getElementById('subtype-choice-container'), subtypeOptions: document.getElementById('subtype-options'),
                ingredientsStepContainer: document.getElementById('ingredients-step-container'), selectedIngredientsList: document.getElementById('selected-ingredients-list'),
                myOrderContentEl: document.getElementById('my-order-content'), allOrdersListEl: document.getElementById('all-orders-list'),
                grandTotalEl: document.getElementById('grand-total'), userModal: document.getElementById('user-modal')
            });
            dom.categorySelect.innerHTML = `<option value="all">Tutte le Categorie</option>` + CATEGORY_ORDER.map(c => `<option value="${c.toLowerCase()}">${c}</option>`).join('');
            navigate('menu');
        }

        onAuthStateChanged(auth, u => {
            if (u) {
                const n = localStorage.getItem('dosepranza-username');
                if(!n) dom.userModal.classList.remove('hidden'); else state.currentUser = { name: n, email: localStorage.getItem('dosepranza-useremail') };
            } else signInAnonymously(auth);
        });

        init();
    </script>
</body>
</html>
