<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dosemagna</title>
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            light: '#e8b39a',
                            DEFAULT: '#D6804F',
                            dark: '#c0673a',
                            '100': '#fef4ef',
                            '800': '#8c502f'
                        },
                        secondary: {
                            light: '#a1bb96',
                            DEFAULT: '#709460',
                            dark: '#5a794d',
                            '100': '#eef4ec',
                            '800': '#415738'
                        },
                        background: '#F3F1E7',
                        'text-main': '#3B3F2F',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .paid-order { opacity: 0.7; }
        #favorites-section .overflow-x-auto::-webkit-scrollbar { height: 6px; }
        #favorites-section .overflow-x-auto::-webkit-scrollbar-track { background: #e0ddd3; border-radius: 10px; }
        #favorites-section .overflow-x-auto::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        #favorites-section .overflow-x-auto::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .payment-radio:checked + label {
            border-color: #D6804F;
            box-shadow: 0 0 0 2px rgba(214, 128, 79, 0.4);
        }
        .toggle-checkbox:checked { right: 0; border-color: #709460; }
        .toggle-checkbox:checked + .toggle-label { background-color: #709460; }
        .ingredient-card.selected, .choice-btn.selected {
            border-color: #D6804F;
            box-shadow: 0 0 0 3px rgba(214, 128, 79, 0.5);
            transform: translateY(-4px);
        }
    </style>
</head>
<body class="bg-background text-text-main">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        <header class="mb-6 flex flex-col items-center">
            <div class="flex flex-col items-center">
                <img src="https://i.postimg.cc/L6H20zfp/logo-dosepranza-People-About-Food.png" alt="Dosepranza Logo" class="w-64 md:w-80 mx-auto">
                <div class="text-center">
                    <a href="https://www.mermaidchart.com/app/projects/6940d9d3-fca9-4615-9516-3753f0d6dd1e/diagrams/7034c164-c365-454d-9a8e-02d597c94465/version/v0.1/edit" target="_blank" class="mt-2 inline-block text-sm text-secondary-dark hover:underline">
                        <i class="fas fa-project-diagram mr-1"></i> Come funziona? Vedi il processo d'ordine
                    </a>
                </div>
            </div>

            <div class="bg-primary-100 border-l-4 border-primary text-primary-800 p-4 rounded-md my-4 w-full mt-6" role="alert">
                <p class="font-bold">Attenzione: L'ordine deve essere completato entro le 11:30.</p>
                <p>La consegna è stimata intorno alle 12:30.</p>
                <p>La consegna è <strong>gratuita</strong>.</p>
            </div>
        </header>

        <nav class="flex justify-center bg-white/70 backdrop-blur-sm p-2 rounded-xl shadow-md mb-6 sticky top-4 z-40">
            <button data-view="menu" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold text-text-main transition-all duration-300"><i class="fas fa-utensils mr-2"></i>Menù</button>
            <button data-view="custom-sandwich" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold text-text-main transition-all duration-300"><i class="fas fa-plus-circle mr-2"></i>Crea Prodotto</button>
            <button data-view="my-order" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold text-text-main transition-all duration-300"><i class="fas fa-shopping-basket mr-2"></i>Il Mio Ordine <span id="cart-count" class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 inline-flex items-center justify-center ml-1">0</span></button>
            <button data-view="all-orders" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold text-text-main transition-all duration-300"><i class="fas fa-users mr-2"></i>Tutti gli Ordini</button>
        </nav>

        <main>
            <section id="menu-view" class="view">
                <h2 class="text-3xl font-extrabold mb-4">Scegli cosa ordinare</h2>
                
                <div id="favorites-section" class="mb-8"></div>
                
                <div class="flex flex-col sm:flex-row gap-3 mb-4 items-center flex-wrap">
                    <div class="relative w-full sm:flex-grow">
                        <input type="search" id="search-input" placeholder="Cerca un piatto..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary transition-all duration-300">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <select id="category-select" class="w-full sm:w-auto p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-2 focus:ring-primary transition-all duration-300"></select>
                    <select id="diet-select" class="w-full sm:w-auto p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-2 focus:ring-primary transition-all duration-300"></select>
                    <button id="suggest-dish-btn" class="w-full sm:w-auto p-3 border border-dashed border-primary text-primary rounded-lg bg-primary-100/50 shadow-sm hover:bg-primary-100 transition-all duration-300 font-semibold"><i class="fas fa-random mr-2"></i>Suggerisci una pietanza</button>
                </div>
                
                <div class="flex justify-between items-center mb-4">
                    <div id="filter-counter-container" class="text-sm"></div>
                    <div class="flex gap-2">
                        <button id="show-allergens-btn" class="bg-gray-200 hover:bg-gray-300 text-text-main font-bold py-2 px-4 rounded-lg flex items-center text-sm transition-all duration-300"><i class="fas fa-info-circle mr-2"></i> Mostra Allergeni</button>
                        <button id="toggle-calories" class="bg-gray-200 hover:bg-gray-300 text-text-main font-bold py-2 px-4 rounded-lg flex items-center text-sm transition-all duration-300">
                            <i class="fas fa-toggle-off mr-2"></i>
                            <span id="toggle-calories-text">Mostra Calorie</span>
                        </button>
                    </div>
                </div>

                <div id="menu-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </section>

            <section id="custom-sandwich-view" class="view">
                <h2 class="text-3xl font-extrabold mb-4">Crea il Tuo Prodotto</h2>
                
                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="text-xl font-bold mb-3 text-center">1. Scegli la base</h3>
                    <div id="base-choice-container" class="flex gap-4">
                        <button data-type="panino" class="choice-btn flex-1 p-4 bg-gray-50 rounded-lg shadow-sm border-2 border-transparent transition-all duration-200 flex flex-col items-center">
                            <i class="fas fa-bread-slice text-2xl text-primary mb-2"></i>
                            <span class="font-semibold">Panino</span>
                        </button>
                        <button data-type="pizza" class="choice-btn flex-1 p-4 bg-gray-50 rounded-lg shadow-sm border-2 border-transparent transition-all duration-200 flex flex-col items-center">
                            <i class="fas fa-pizza-slice text-2xl text-primary mb-2"></i>
                            <span class="font-semibold">Pizza Ripiena</span>
                        </button>
                    </div>
                </div>

                <div id="ingredients-step-container" class="hidden">
                    <h3 class="text-xl font-bold mb-3 text-center">2. Aggiungi gli ingredienti</h3>
                    <p class="text-center text-text-main/80 mb-4">Il prezzo base di **3,50€** include fino a 3 ingredienti. Dal 4° in poi si applica un supplemento di **1,00€** per ogni ingrediente.</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="ingredients-list" class="md:col-span-2 grid grid-cols-2 sm:grid-cols-3 gap-4">
                        </div>

                        <div id="sandwich-summary" class="md:col-span-1">
                            <div class="bg-white p-4 rounded-xl shadow-md sticky top-24">
                                <h3 class="font-bold text-lg border-b pb-2 mb-3">Riepilogo</h3>
                                <div class="mb-3">
                                    <p class="font-semibold" id="sandwich-base-summary">Seleziona una base...</p>
                                </div>
                                <ul id="selected-ingredients-list" class="space-y-2 text-sm mb-4 min-h-[60px]">
                                </ul>
                                <div class="border-t pt-3">
                                    <p id="extra-charge-notice" class="text-xs text-red-500 mb-2 h-4"></p>
                                    <p class="text-right text-2xl font-bold text-primary" id="sandwich-total-price">€0.00</p>
                                </div>
                                <button id="add-sandwich-to-cart-btn" class="w-full mt-4 bg-secondary hover:bg-secondary-dark text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fas fa-plus-circle mr-2"></i>Aggiungi al Carrello
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="my-order-view" class="view">
                <h2 class="text-3xl font-extrabold mb-4">Riepilogo del Tuo Ordine</h2>
                <div id="my-order-content" class="bg-white p-6 rounded-xl shadow-md"></div>
            </section>

            <section id="all-orders-view" class="view">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-3xl font-extrabold">Riepilogo Ordini di Oggi</h2>
                    <div class="flex gap-2">
                        <button id="export-history-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg hidden transition-all duration-300"><i class="fas fa-download mr-2"></i> Esporta Storico</button>
                        <button id="copy-summary-btn" class="bg-secondary hover:bg-secondary-dark text-white font-bold py-2 px-4 rounded-lg transition-all duration-300"><i class="fas fa-copy mr-2"></i> Copia Riepilogo</button>
                    </div>
                </div>
                <div id="satispay-details" class="bg-white p-4 rounded-xl shadow-md mb-6 flex flex-col md:flex-row items-center gap-4">
                    <div class="flex-shrink-0">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=https://web.satispay.com/app/open/shops/986e3af6-8a54-4c3d-9c23-b741ca0f8cc0" alt="QR Code Satispay" class="rounded-lg">
                    </div>
                    <div class="text-center md:text-left">
                        <h3 class="text-xl font-bold">Paga con Satispay</h3>
                        <p class="text-text-main/80">Inquadra il QR Code o usa il link per pagare l'importo del tuo ordine a <strong>Alimentari Russo</strong>.</p>
                        <p class="text-primary-800 font-semibold text-sm mt-1">Il pagamento va effettuato entro le 11:30.</p>
                        <a href="https://web.satispay.com/app/open/shops/986e3af6-8a54-4c3d-9c23-b741ca0f8cc0" target="_blank" class="mt-2 inline-block bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">
                            <i class="fas fa-external-link-alt mr-2"></i>Vai a Satispay
                        </a>
                    </div>
                </div>
                <div id="all-orders-list" class="space-y-4"></div>
                 <div class="mt-6 bg-white p-4 rounded-xl shadow-lg text-right">
                    <span class="text-xl font-bold">Totale Complessivo:</span>
                    <span id="grand-total" class="text-2xl font-bold text-primary ml-2">€0.00</span>
                </div>
            </section>
        </main>
    </div>

    <div id="user-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md text-center"><h3 class="text-2xl font-bold mb-4">Benvenuto!</h3><p class="text-gray-600 mb-6">Per iniziare, inserisci il tuo nome e cognome.</p><input type="text" id="username-input" placeholder="Es. Marco Rossi" class="w-full p-3 border rounded-lg"><button id="save-username-btn" class="w-full mt-4 bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">Salva</button></div></div>
    <div id="allergen-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md relative"><button id="close-allergen-modal-btn" class="absolute top-2 right-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button><h3 class="text-2xl font-bold mb-4">Legenda Allergeni</h3><div id="allergen-modal-content" class="text-gray-600 text-sm space-y-2"></div></div></div>
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-text-main text-white py-3 px-6 rounded-full shadow-xl z-50 opacity-0 transition-opacity"><p id="toast-message"></p></div>
    <div id="suggestion-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md text-center transform transition-all scale-95 opacity-0" id="suggestion-modal-content-box">
          <h3 class="text-2xl font-bold mb-2">💡 Ti suggeriamo...</h3>
          <div id="suggestion-content" class="my-6"></div>
          <div class="flex justify-center gap-4">
            <button id="suggestion-add-btn" class="flex-1 bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">Aggiungi</button>
            <button id="suggestion-close-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 font-bold py-3 px-4 rounded-lg transition-all duration-300">Chiudi</button>
          </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, doc, updateDoc, deleteDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCQJsNbgaR89gF_1vLe6H4DPboOhQvm9nI", authDomain: "app-ordini-pranzo-alimentari.firebaseapp.com", projectId: "app-ordini-pranzo-alimentari", storageBucket: "app-ordini-pranzo-alimentari.appspot.com", messagingSenderId: "553169964686", appId: "1:553169964686:web:7f8ca6f32a301949e4c3df" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ordersCollectionRef = collection(db, "orders");
        
        const PRICES = { gastronomia: 4.00, verdure: 4.00, panini: 3.50, pizze: 3.50, fritti: 1.50, dessert: 3.00 };
        const ALLERGENS = { G: { name: "Glutine", icon: "fa-wheat-awn" }, L: { name: "Latticini", icon: "fa-cheese" }, C: { name: "Crostacei", icon: "fa-shrimp" }, P: { name: "Pesce", icon: "fa-fish-fins" }};
        const DIETS = { vegetariano: { name: "Vegetariano", icon: "🧀" }, vegano: { name: "Vegano", icon: "🌱" }, "carne/pesce": { name: "Carne/🐟Pesce", icon: "🥩" } };
        const PAYMENT_METHODS = { 
            Satispay: { name: "Satispay", icon: "fa-mobile-alt", note: "Pagamento da effettuare entro le 11:30." },
            Contanti: { name: "Contanti", icon: "fa-money-bill-wave", note: "Pagamento alla consegna." },
            CarteBancomat: { name: "Carte e bancomat", icon: "fa-credit-card", note: "Pagamento alla consegna." },
            Edenred: { name: "Buoni Pasto Edenred", icon: "fa-ticket-alt", note: "È richiesto il saldo in negozio entro fine settimana." }
        };
        const CATEGORY_ORDER = ["Menù", "Panini", "Pizze", "Gastronomia", "Verdure", "Fritti", "Dessert", "Bevande"];
        
        const BASE_OPTIONS = {
            panino: { name: 'Panino' },
            pizza: { name: 'Pizza Ripiena' }
        };

        const CUSTOM_PRODUCT_BASE_PRICE = 3.50;
        const CUSTOM_PRODUCT_EXTRA_INGREDIENT_PRICE = 1.00;
        const CUSTOM_PRODUCT_INCLUDED_INGREDIENTS = 3;

        const SANDWICH_INGREDIENTS = [
            // Salumi
            { id: 'p-crudo', name: 'Prosciutto Crudo' }, { id: 'p-cotto', name: 'Prosciutto Cotto' },
            { id: 'salame', name: 'Salame' }, { id: 'mortadella', name: 'Mortadella' },
            { id: 'porchetta', name: 'Porchetta' }, { id: 'tacchino', name: 'Tacchino Arrosto' },
            { id: 'bresaola', name: 'Bresaola' }, { id: 'speck', name: 'Speck' },
            { id: 'capocollo', name: 'Capocollo' }, { id: 'salmone', name: 'Salmone' }, { id: 'tonno', name: 'Tonno' },
            // Formaggi
            { id: 'mozzarella', name: 'Mozzarella' }, { id: 'scamorza', name: 'Scamorza' },
            { id: 'stracchino', name: 'Stracchino' }, { id: 'parmigiano', name: 'Parmigiano' },
            { id: 'pecorino', name: 'Pecorino' }, { id: 'brie', name: 'Brie' },
            { id: 'primo-sale', name: 'Primo Sale' }, { id: 'stracciatella', name: 'Stracciatella' },
            // Verdure e Altro
            { id: 'pomodoro', name: 'Pomodoro' }, { id: 'pom-secchi', name: 'Pomodori Secchi' },
            { id: 'rucola', name: 'Rucola' }, { id: 'melanzane', name: 'Melanzane Grigliate' },
            { id: 'zucchine', name: 'Zucchine Grigliate' }, { id: 'peperoni', name: 'Peperoni Grigliati' },
            { id: 'carciofini', name: 'Carciofini' }, { id: 'frittata', name: 'Frittata' },
            { id: 'insalata', name: 'Insalata' }, { id: 'olive', name: 'Olive' }
        ].sort((a, b) => a.name.localeCompare(b.name));


        const RAW_MENU = {
            menù: [
                { name: "Panino + Lattina 33cl", price: 4.00, ingredients: ["Scegli un panino e una lattina da 33cl (specificare nelle note)"], allergens: [], diet: [] },
                { name: "Panino + Lattina 50cl", price: 4.50, ingredients: ["Scegli un panino e una lattina da 50cl (specificare nelle note)"], allergens: [], diet: [] }
            ],
            panini: [ 
                { name: "Crudo pomodoro mozzarella", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 550, ingredients: ["Prosciutto crudo", "Pomodoro", "Mozzarella"] }, 
                { name: "Crudo stracchino rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580, ingredients: ["Prosciutto crudo", "Stracchino", "Rucola"] }, 
                { name: "Cotto arrosto scamorza e verdura", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 520, ingredients: ["Prosciutto cotto", "Scamorza", "Verdura di stagione"] }, 
                { name: "Capocollo pecorino e pomodori secchi", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 600, ingredients: ["Capocollo", "Pecorino", "Pomodori secchi"] }, 
                { name: "Salame pecorino e pomodori secchi", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 620, ingredients: ["Salame", "Pecorino", "Pomodori secchi"] }, 
                { name: "Speck Brie e pomodori secchi", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 610, ingredients: ["Speck", "Brie", "Pomodori secchi"] }, 
                { name: "Porchetta", allergens: ["G"], diet: ["carne/pesce"], calories: 650, ingredients: ["Porchetta di Ariccia"] }, 
                { name: "Vegetariano melanzane zucchine e peperoni", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 450, ingredients: ["Melanzane", "Zucchine", "Peperoni grigliati"] }, 
                { name: "Tacchino e verdura", allergens: ["G"], diet: ["carne/pesce"], calories: 480, ingredients: ["Tacchino arrosto", "Verdura di stagione"] }, 
                { name: "Bresaola parmigiano e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 500, ingredients: ["Bresaola", "Parmigiano a scaglie", "Rucola"] }, 
                { name: "Bresaola primo sale e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 470, ingredients: ["Bresaola", "Primo sale", "Rucola"] }, 
                { name: "Salmone e formaggio", allergens: ["G", "L", "P"], diet: ["carne/pesce"], calories: 530, ingredients: ["Salmone affumicato", "Formaggio spalmabile"] }, 
                { name: "Tonno e pomodoro", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 490, ingredients: ["Tonno", "Pomodoro a fette"] }, 
                { name: "Tonno e carciofini", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 510, ingredients: ["Tonno", "Carciofini sott'olio"] },
                { name: "Pane ai 5 cereali con formaggio spalmabile e salmone", allergens: ["G", "L", "P"], diet: ["carne/pesce"], calories: 540, ingredients: ["Pane ai 5 cereali", "Formaggio spalmabile", "Salmone affumicato"] },
                { name: "Pane ai 5 cereali con tacchino e zucchine o scarola", allergens: ["G"], diet: ["carne/pesce"], calories: 490, ingredients: ["Pane ai 5 cereali", "Tacchino arrosto", "Zucchine/Scarola"] }
            ],
            pizze: [ 
                { name: "Crudo e mozzarella", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 600, ingredients: ["Prosciutto crudo", "Mozzarella"] }, 
                { name: "Speck stracchino e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 650, ingredients: ["Speck", "Stracchino", "Rucola"] }, 
                { name: "Cotto arrosto e melanzane", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580, ingredients: ["Prosciutto cotto", "Melanzane"] }, 
                { name: "Mortadella e stracciatella", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 700, ingredients: ["Mortadella", "Stracciatella"] }, 
                { name: "Frittata e zucchine", allergens: ["G", "L"], diet: ["vegetariano"], calories: 550, ingredients: ["Frittata", "Zucchine"] }, 
                { name: "Bresaola e formaggio", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580, ingredients: ["Bresaola", "Formaggio"] }, 
                { name: "Insalata di pollo", allergens: ["G"], diet: ["carne/pesce"], calories: 560, ingredients: ["Insalata di pollo"] }, 
                { name: "Cotto e stracchino", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 620, ingredients: ["Prosciutto cotto", "Stracchino"] },
                { name: "Pizza ai 5 cereali bresaola formaggio spalmabile e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 590, ingredients: ["Pizza ai 5 cereali", "Bresaola", "Formaggio spalmabile", "Rucola"] },
                { name: "Pizza ai 5 cereali con insalata di pollo", allergens: ["G"], diet: ["carne/pesce"], calories: 570, ingredients: ["Pizza ai 5 cereali", "Insalata di pollo"] }
            ],
            gastronomia: [ 
                { name: "Cous cous vegetale con pollo", allergens: ["G"], diet: ["carne/pesce"], calories: 450, ingredients: ["Cous cous", "Verdure miste", "Pollo"] }, 
                { name: "Cous cous vegetale", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 350, ingredients: ["Cous cous", "Verdure miste"] }, 
                { name: "Farro vegetale", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 380, ingredients: ["Farro", "Verdure miste"] }, 
                { name: "Farro vegetale con salmone", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 480, ingredients: ["Farro", "Verdure miste", "Salmone"] }, 
                { name: "Riso Venere con gamberi e zucchine", allergens: ["C"], diet: ["carne/pesce"], calories: 420, ingredients: ["Riso Venere", "Gamberi", "Zucchine"] }, 
                { name: "Insalata di riso", allergens: [], diet: ["carne/pesce"], calories: 400, ingredients: ["Riso", "Wurstel", "Uova", "Verdure sott'olio"] }, 
                { name: "Pasta fredda con tonno pomodori e olive", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 450, ingredients: ["Pasta", "Tonno", "Pomodorini", "Olive"] }, 
                { name: "Pasta fredda pesto primo sale pomodori olive", allergens: ["G", "L"], diet: ["vegetariano"], calories: 500, ingredients: ["Pasta", "Pesto", "Formaggio primo sale", "Pomodorini", "Olive"] }, 
                { name: "Insalata di pollo", allergens: [], diet: ["carne/pesce"], calories: 350, ingredients: ["Pollo", "Insalata", "Mais", "Pomodorini", "Olive"] }, 
                { name: "Riso integrale bresaola limone e rughetta", allergens: [], diet: ["carne/pesce"], calories: 380, ingredients: ["Riso integrale", "Bresaola", "Rucola", "Succo di limone"] }, 
                { name: "Pomodori con il riso (2pz)", price: 6.00, allergens: [], diet: ["vegetariano", "vegano"], calories: 300, ingredients: ["Pomodori", "Riso", "Patate al forno"] } 
            ],
            verdure: [ { name: "Melanzane", allergens: [], diet: ["vegetariano", "vegano"], calories: 180, ingredients: ["Melanzane grigliate"] }, { name: "Zucchine", allergens: [], diet: ["vegetariano", "vegano"], calories: 160, ingredients: ["Zucchine grigliate"] }, { name: "Peperoni", allergens: [], diet: ["vegetariano", "vegano"], calories: 160, ingredients: ["Peperoni arrostiti"] }, { name: "Cicoria", allergens: [], diet: ["vegetariano", "vegano"], calories: 140, ingredients: ["Cicoria ripassata"] }, { name: "Broccoletti", allergens: [], diet: ["vegetariano", "vegano"], calories: 150, ingredients: ["Broccoletti ripassati"] }, { name: "Broccoli", allergens: [], diet: ["vegetariano", "vegano"], calories: 150, ingredients: ["Broccoli al vapore"] }, { name: "Scarola con olive", allergens: [], diet: ["vegetariano", "vegano"], calories: 130, ingredients: ["Scarola", "Olive di Gaeta"] } ],
            fritti: [ { name: "Supplì", allergens: ["G", "L"], diet: ["vegetariano"], calories: 250, ingredients: ["Riso", "Pomodoro", "Mozzarella", "Pangrattato"] }, { name: "Polpetta di melanzane", allergens: ["G", "L"], diet: ["vegetariano"], calories: 180, ingredients: ["Melanzane", "Parmigiano", "Uova", "Pangrattato"] } ],
            dessert: [ { name: "Macedonia", allergens: [], diet: ["vegetariano", "vegano"], calories: 120, ingredients: ["Frutta fresca di stagione"] } ],
            bevande: [
                { name: "Acqua naturale", format: "0,5 l", price: 0.50, allergens: [], diet: ["vegetariano", "vegano"] },
                { name: "Acqua frizzante", format: "0,5 l", price: 0.50, allergens: [], diet: ["vegetariano", "vegano"] },
                { name: "Coca Cola", format: "lattina 33 cl", price: 2.50, allergens: [], diet: ["vegetariano", "vegano"] },
                { name: "Fanta", format: "lattina 33 cl", price: 2.50, allergens: [], diet: ["vegetariano", "vegano"] },
                { name: "Tè freddo", format: "bottiglia 33 cl", price: 2.50, allergens: [], diet: ["vegetariano", "vegano"] }
            ]
        };
        
        const state = { 
            currentUser: null, 
            currentView: 'menu', 
            activeCategoryFilter: 'all', 
            activeDietFilter: 'all', 
            searchTerm: '', 
            cart: [], 
            allOrders: [], 
            menuData: [], 
            caloriesVisible: false,
            customSandwich: {
                base: null,
                ingredients: [],
                basePrice: CUSTOM_PRODUCT_BASE_PRICE,
                totalPrice: 0
            }
        };
        const dom = { };
        
        function updateIngredientsWithOlives(menu) {
            for (const category in menu) {
                menu[category].forEach(item => {
                    const hasSalad = item.name.toLowerCase().includes('insalata') || 
                                     (item.ingredients && item.ingredients.some(ing => ing.toLowerCase().includes('insalata')));
                    if (hasSalad) {
                        if (!item.ingredients) item.ingredients = [];
                        const hasOlives = item.ingredients.some(ing => ing.toLowerCase().includes('olive'));
                        if (!hasOlives) item.ingredients.push('Olive');
                    }
                });
            }
            return menu;
        }

        function processMenuData(rawMenu, prices) { 
            const updatedMenu = updateIngredientsWithOlives(rawMenu);
            let id = 1; 
            const icons = { menù: 'fa-tags', gastronomia: 'fa-bowl-food', fritti: 'fa-stroopwafel', verdure: 'fa-carrot', panini: 'fa-bread-slice', pizze: 'fa-pizza-slice', dessert: 'fa-ice-cream', bevande: 'fa-wine-bottle' }; 
            return Object.entries(updatedMenu).flatMap(([cat, items]) => items.map(item => ({ id: id++, name: item.name, category: cat.charAt(0).toUpperCase() + cat.slice(1), price: item.price !== undefined ? item.price : (prices[cat] || 0), icon: icons[cat] || 'fa-utensils', ...item })));
        }

        function showToast(message, duration = 3000) { dom.toastMessageEl.textContent = message; dom.toastEl.classList.remove('opacity-0'); setTimeout(() => dom.toastEl.classList.add('opacity-0'), duration); }
        
        function navigate(viewName) { 
            state.currentView = viewName; 
            dom.views.forEach(v => v.classList.toggle('active', v.id === `${viewName}-view`)); 
            dom.navBtns.forEach(b => { b.classList.toggle('bg-primary', b.dataset.view === viewName); b.classList.toggle('text-white', b.dataset.view === viewName); }); 
            if (viewName === 'my-order') renderMyOrder();
            if (viewName === 'all-orders') renderAllOrders();
            if (viewName === 'custom-sandwich') renderCustomSandwichBuilder();
        }
        
        // ... (The rest of the script is unchanged but contains all the logic)

    </script>
</body>
</html>
