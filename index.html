<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dosemagna</title>
    <link rel="icon" type="dosepranza/favicondosepranza.png" href="favicondosepranza.png">
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            light: '#e8b39a',
                            DEFAULT: '#D6804F',
                            dark: '#c0673a',
                            '100': '#fef4ef',
                            '800': '#8c502f'
                        },
                        secondary: {
                            light: '#a1bb96',
                            DEFAULT: '#709460',
                            dark: '#5a794d',
                            '100': '#eef4ec',
                            '800': '#415738'
                        },
                        background: '#F3F1E7',
                        'text-main': '#3B3F2F',
                    }
                }
            }
        }
    </script>
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .paid-order { opacity: 0.7; }
        .payment-radio:checked + label {
            border-color: #D6804F;
            box-shadow: 0 0 0 2px rgba(214, 128, 79, 0.4);
        }
        .toggle-checkbox:checked { right: 0; border-color: #709460; }
        .toggle-checkbox:checked + .toggle-label { background-color: #709460; }
        .ingredient-card.selected, .choice-btn.selected {
            border-color: #D6804F;
            box-shadow: 0 0 0 3px rgba(214, 128, 79, 0.5);
            transform: translateY(-4px);
        }
    </style>
</head>
<body class="bg-background text-text-main">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        <header class="mb-6 flex flex-col items-center">
            <div class="flex flex-col items-center">
                <img src="https://i.postimg.cc/L6H20zfp/logo-dosepranza-People-About-Food.png" alt="Dosepranza Logo" class="w-80 md:w-96 mx-auto">
            </div>

            <div class="bg-primary-100 border-l-4 border-primary text-primary-800 p-4 rounded-md my-4 w-full mt-6" role="alert">
                <p class="font-bold">Attenzione: L'ordine deve essere completato entro le 11:30.</p>
                <p>La consegna √® stimata intorno alle 12:30.</p>
                <p>La consegna √® <strong>gratuita</strong>.</p>
            </div>
        </header>

        <nav class="flex justify-center bg-white/70 backdrop-blur-sm p-2 rounded-xl shadow-md mb-6 sticky top-4 z-40">
            <a href="#menu-view" data-view="menu" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold text-text-main transition-all duration-300"><i class="fas fa-utensils mr-2"></i>Men√π</a>
            <a href="#custom-sandwich-view" data-view="custom-sandwich" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold text-text-main transition-all duration-300"><i class="fas fa-plus-circle mr-2"></i>Crea Prodotto</a>
            <a href="#my-order-view" data-view="my-order" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold text-text-main transition-all duration-300"><i class="fas fa-shopping-basket mr-2"></i>Il Mio Ordine <span id="cart-count" class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 inline-flex items-center justify-center ml-1">0</span></a>
            <a href="#all-orders-view" data-view="all-orders" class="nav-btn flex-1 text-center py-2 px-4 rounded-lg font-semibold text-text-main transition-all duration-300"><i class="fas fa-users mr-2"></i>Tutti gli Ordini</a>
        </nav>

        <main>
            <section id="menu-view" class="view">
                <h2 id="Men√π" class="text-3xl font-extrabold mb-4">Scegli cosa ordinare</h2>

                <div class="flex flex-col sm:flex-row gap-3 mb-4 items-center flex-wrap">
                    <div class="relative w-full sm:flex-grow">
                        <input type="search" id="search-input" placeholder="Cerca un piatto..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary transition-all duration-300">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <select id="category-select" class="w-full sm:w-auto p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-2 focus:ring-primary transition-all duration-300"></select>
                    <select id="diet-select" class="w-full sm:w-auto p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-2 focus:ring-primary transition-all duration-300"></select>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <div id="filter-counter-container" class="text-sm"></div>
                    <div class="flex gap-2">
                        <button id="show-allergens-btn" class="bg-gray-200 hover:bg-gray-300 text-text-main font-bold py-2 px-4 rounded-lg flex items-center text-sm transition-all duration-300"><i class="fas fa-info-circle mr-2"></i> Mostra Allergeni</button>
                        <button id="toggle-calories" class="bg-gray-200 hover:bg-gray-300 text-text-main font-bold py-2 px-4 rounded-lg flex items-center text-sm transition-all duration-300">
                            <i class="fas fa-toggle-off mr-2"></i>
                            <span id="toggle-calories-text">Mostra Calorie</span>
                        </button>
                    </div>
                </div>

                <div id="menu-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </section>

            <section id="custom-sandwich-view" class="view">
                <h2 id="Crea Prodotto" class="text-3xl font-extrabold mb-4">Crea il Tuo Prodotto</h2>

                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="text-xl font-bold mb-3 text-center">1. Scegli la base</h3>
                    <div id="base-choice-container" class="flex gap-4">
                        <button data-type="panino" class="choice-btn flex-1 p-4 bg-gray-50 rounded-lg shadow-sm border-2 border-transparent transition-all duration-200 flex flex-col items-center">
                            <i class="fas fa-bread-slice text-2xl text-primary mb-2"></i>
                            <span class="font-semibold">Panino</span>
                        </button>
                        <button data-type="pizza" class="choice-btn flex-1 p-4 bg-gray-50 rounded-lg shadow-sm border-2 border-transparent transition-all duration-200 flex flex-col items-center">
                            <i class="fas fa-pizza-slice text-2xl text-primary mb-2"></i>
                            <span class="font-semibold">Pizza Ripiena</span>
                        </button>
                    </div>
                </div>

                <div id="subtype-choice-container" class="bg-white p-4 rounded-xl shadow-md mb-6 hidden">
                    <h3 class="text-xl font-bold mb-3 text-center">2. Scegli la variante</h3>
                    <div id="subtype-options" class="flex flex-wrap gap-4 justify-center">
                    </div>
                </div>

                <div id="ingredients-step-container" class="hidden">
                    <h3 class="text-xl font-bold mb-3 text-center">3. Aggiungi gli ingredienti</h3>
                    <p class="text-center text-text-main/80 mb-4">Il prezzo base di **3,50‚Ç¨** include fino a 3 ingredienti. Dal 4¬∞ in poi si applica un supplemento di **1,00‚Ç¨** per ogni ingrediente.</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="ingredients-list" class="md:col-span-2 grid grid-cols-2 sm:grid-cols-3 gap-4">
                        </div>

                        <div id="sandwich-summary" class="md:col-span-1">
                            <div class="bg-white p-4 rounded-xl shadow-md sticky top-24">
                                <h3 class="font-bold text-lg border-b pb-2 mb-3">Riepilogo</h3>
                                <div class="mb-3">
                                    <p class="font-semibold" id="sandwich-base-summary">Seleziona una base...</p>
                                </div>
                                <ul id="selected-ingredients-list" class="space-y-2 text-sm mb-4 min-h-[60px]">
                                </ul>
                                <div class="border-t pt-3">
                                    <p id="extra-charge-notice" class="text-xs text-red-500 mb-2 h-4"></p>
                                    <p class="text-right text-2xl font-bold text-primary" id="sandwich-total-price">‚Ç¨0.00</p>
                                </div>
                                <button id="add-sandwich-to-cart-btn" class="w-full mt-4 bg-secondary hover:bg-secondary-dark text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fas fa-plus-circle mr-2"></i>Aggiungi al Carrello
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="my-order-view" class="view">
                <h2 id="Il Mio Ordine" class="text-3xl font-extrabold mb-4">Riepilogo del Tuo Ordine</h2>
                <div id="my-order-content" class="bg-white p-6 rounded-xl shadow-md"></div>
            </section>

            <section id="all-orders-view" class="view">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                     <h2 id="Tutti gli Ordini" class="text-3xl font-extrabold">Riepilogo Ordini di Oggi</h2>
                     <div class="flex gap-2">
                         <button id="export-history-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg hidden transition-all duration-300"><i class="fas fa-download mr-2"></i> Esporta Storico</button>
                         <button id="copy-summary-btn" class="bg-secondary hover:bg-secondary-dark text-white font-bold py-2 px-4 rounded-lg transition-all duration-300"><i class="fas fa-copy mr-2"></i> Copia Riepilogo</button>
                     </div>
                 </div>
                 <div id="satispay-details" class="bg-white p-4 rounded-xl shadow-md mb-6 flex flex-col md:flex-row items-center gap-4">
                     <div class="flex-shrink-0">
                         <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=https://web.satispay.com/app/open/shops/986e3af6-8a54-4c3d-9c23-b741ca0f8cc0" alt="QR Code Satispay" class="rounded-lg">
                     </div>
                     <div class="text-center md:text-left">
                         <h3 class="text-xl font-bold">Paga con Satispay</h3>
                         <p class="text-text-main/80">Inquadra il QR Code o usa il link per pagare l'importo del tuo ordine a <strong>Alimentari Russo</strong>.</p>
                         <p class="text-primary-800 font-semibold text-sm mt-1">Il pagamento va effettuato entro le 11:30.</p>
                         <a href="https://web.satispay.com/app/open/shops/986e3af6-8a54-4c3d-9c23-b741ca0f8cc0" target="_blank" class="mt-2 inline-block bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">
                             <i class="fas fa-external-link-alt mr-2"></i>Vai a Satispay
                         </a>
                     </div>
                 </div>
                 <div id="all-orders-list" class="space-y-4"></div>
                  <div class="mt-6 bg-white p-4 rounded-xl shadow-lg text-right">
                     <span class="text-xl font-bold">Totale Complessivo:</span>
                     <span id="grand-total" class="text-2xl font-bold text-primary ml-2">‚Ç¨0.00</span>
                 </div>
            </section>
        </main>
    </div>

    <div id="user-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md text-center">
            <h3 class="text-2xl font-bold mb-4">Benvenuto!</h3>
            <p class="text-gray-600 mb-6">Per iniziare, inserisci i tuoi dati.</p>
            <input type="text" id="username-input" placeholder="Es. Marco Rossi" class="w-full p-3 border rounded-lg mb-3">
            <input type="email" id="user-email-input" placeholder="Es. marco.rossi@email.com" class="w-full p-3 border rounded-lg">
            <button id="save-username-btn" class="w-full mt-4 bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">Salva</button>
        </div>
    </div>

    <div id="allergen-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md relative"><button id="close-allergen-modal-btn" class="absolute top-2 right-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button><h3 class="text-2xl font-bold mb-4">Legenda Allergeni</h3><div id="allergen-modal-content" class="text-gray-600 text-sm space-y-2"></div></div></div>
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-text-main text-white py-3 px-6 rounded-full shadow-xl z-50 opacity-0 transition-opacity"><p id="toast-message"></p></div>
    
    <div id="combo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-md">
            <h3 class="text-2xl font-bold mb-4">Scegli il tuo men√π</h3>
            <div class="space-y-4">
                <div>
                    <label for="combo-panino-select" class="block mb-2 font-semibold">Scegli il Panino:</label>
                    <select id="combo-panino-select" class="w-full p-3 border border-gray-300 rounded-lg"></select>
                </div>
                <div>
                    <label for="combo-drink-select" id="combo-drink-label" class="block mb-2 font-semibold">Scegli la Bevanda:</label>
                    <select id="combo-drink-select" class="w-full p-3 border border-gray-300 rounded-lg"></select>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="combo-cancel-btn" class="bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg">Annulla</button>
                <button id="combo-add-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Aggiungi al Carrello</button>
            </div>
        </div>
    </div>

    <div id="satispay-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md text-center relative">
            <button id="satispay-close-btn" class="absolute top-2 right-4 text-3xl text-gray-400 hover:text-gray-700">&times;</button>
            <h3 class="text-2xl font-bold mb-4">Paga con Satispay</h3>
            <p class="text-text-main/80 mb-4">Il tuo ordine √® stato inviato! <br> Inquadra il QR Code o usa il link per pagare <strong>Alimentari Russo</strong>.</p>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=https://web.satispay.com/app/open/shops/986e3af6-8a54-4c3d-9c23-b741ca0f8cc0" alt="QR Code Satispay" class="rounded-lg mx-auto w-64 h-64">
            <a href="https://web.satispay.com/app/open/shops/986e3af6-8a54-4c3d-9c23-b741ca0f8cc0" target="_blank" class="mt-6 inline-block w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">
                <i class="fas fa-external-link-alt mr-2"></i>Apri Satispay
            </a>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, doc, updateDoc, deleteDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCQJsNbgaR89gF_1vLe6H4DPboOhQvm9nI", authDomain: "app-ordini-pranzo-alimentari.firebaseapp.com", projectId: "app-ordini-pranzo-alimentari", storageBucket: "app-ordini-pranzo-alimentari.appspot.com", messagingSenderId: "553169964686", appId: "1:553169964686:web:7f8ca6f32a301949e4c3df" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ordersCollectionRef = collection(db, "orders");

        const PRICES = { gastronomia: 4.00, verdure: 4.00, panini: 3.50, pizze: 3.50, fritti: 1.50, dessert: 3.00, "men√π combinati": 0, insalatone: 5.00 };
        const ALLERGENS = { G: { name: "Glutine", icon: "fa-wheat-awn" }, L: { name: "Latticini", icon: "fa-cheese" }, C: { name: "Crostacei", icon: "fa-shrimp" }, P: { name: "Pesce", icon: "fa-fish-fins" }};
        const DIETS = { vegetariano: { name: "Vegetariano", icon: "üßÄ" }, vegano: { name: "Vegano", icon: "üå±" }, "carne/pesce": { name: "Carne/üêüPesce", icon: "ü•©" } };
        const PAYMENT_METHODS = {
            Satispay: { name: "Satispay", icon: "fa-mobile-alt", note: "Pagamento da effettuare entro le 11:30." }
        };
        const CATEGORY_ORDER = ["Men√π Combinati", "Panini", "Pizze", "Gastronomia", "Insalatone", "Verdure", "Fritti", "Dessert"];

        // --- LOGICA BASI AGGIORNATA ---
        const BASE_OPTIONS = {
            panino: { name: 'Panino', subtypes: ['Pane arabo', 'Ciabattina', 'Medaglione ai 5 cereali', 'Ciabattina integrale'] },
            pizza: { name: 'Pizza Ripiena', subtypes: ['Pizza classica'] }
        };

        const CUSTOM_PRODUCT_BASE_PRICE = 3.50;
        const CUSTOM_PRODUCT_EXTRA_INGREDIENT_PRICE = 1.00;
        const CUSTOM_PRODUCT_INCLUDED_INGREDIENTS = 3;

        // --- LOGICA INGREDIENTI AGGIORNATA ---
        // Rimossi 'Salmone', 'Tonno', 'Cotoletta di Pollo', 'Brasato di Manzo'
        const SANDWICH_INGREDIENTS = [
            // Salumi & Carni
            { id: 'p-crudo', name: 'Prosciutto Crudo' }, { id: 'p-cotto', name: 'Prosciutto Cotto' },
            { id: 'salame', name: 'Salame' }, { id: 'mortadella', name: 'Mortadella' },
            { id: 'porchetta', name: 'Porchetta' }, { id: 'tacchino', name: 'Tacchino Arrosto' },
            { id: 'bresaola', name: 'Bresaola' }, { id: 'speck', name: 'Speck' },
            { id: 'capocollo', name: 'Capocollo' },
            // Formaggi
            { id: 'mozzarella', name: 'Mozzarella' }, { id: 'scamorza', name: 'Scamorza' },
            { id: 'stracchino', name: 'Stracchino' }, { id: 'parmigiano', name: 'Parmigiano' },
            { id: 'pecorino', name: 'Pecorino' }, { id: 'brie', name: 'Brie' },
            { id: 'primo-sale', name: 'Primo Sale' }, { id: 'stracciatella', name: 'Stracciatella' },
            // Verdure e Altro
            { id: 'pomodoro', name: 'Pomodoro' }, { id: 'pom-secchi', name: 'Pomodori Secchi' },
            { id: 'rucola', name: 'Rucola' }, { id: 'melanzane', name: 'Melanzane Grigliate' },
            { id: 'zucchine', name: 'Zucchine Grigliate' }, { id: 'peperoni', name: 'Peperoni Grigliati' },
            { id: 'carciofini', name: 'Carciofini' }, { id: 'frittata', name: 'Frittata' },
            { id: 'insalata', name: 'Insalata' }, { id: 'olive', name: 'Olive' },
            { id: 'lattuga', name: 'Lattuga' }, { id: 'broccoletti', name: 'Broccoletti' },
            { id: 'cicoria', name: 'Cicoria' }, { id: 'scarola', name: 'Scarola' }
        ].sort((a, b) => a.name.localeCompare(b.name));


        // --- RAW_MENU AGGIORNATO ---
        const RAW_MENU = {
            "men√π combinati": [
                { name: "Panino + bottiglia acqua 50 cl", price: 4.00, isCombo: true, comboType: 'panino_acqua_50cl', ingredients: ["Un panino a scelta", "Una bottiglietta di acqua naturale o frizzante da 50 cl"], diet: ["carne/pesce", "vegetariano", "vegano"], allergens: ["G", "L", "P"] },
                { name: "Panino + lattina 33 cl", price: 4.50, isCombo: true, comboType: 'panino_33cl', ingredients: ["Un panino a scelta", "Una bevanda da 33 cl a scelta"], diet: ["carne/pesce", "vegetariano", "vegano"], allergens: ["G", "L", "P"] },
                { name: "Panino + bottiglia 50 cl", price: 5.00, isCombo: true, comboType: 'panino_bevanda_50cl', ingredients: ["Un panino a scelta", "Una bevanda da 50 cl a scelta"], diet: ["carne/pesce", "vegetariano", "vegano"], allergens: ["G", "L", "P"] }
            ],
            panini: [
                { name: "Crudo pomodoro mozzarella", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 550, ingredients: ["Prosciutto crudo", "Pomodoro", "Mozzarella"] },
                { name: "Crudo stracchino rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580, ingredients: ["Prosciutto crudo", "Stracchino", "Rucola"] },
                { name: "Cotto arrosto scamorza e verdura", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 520, ingredients: ["Prosciutto cotto", "Scamorza", "Verdura di stagione"] },
                { name: "Capocollo pecorino e pomodori secchi", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 600, ingredients: ["Capocollo", "Pecorino", "Pomodori secchi"] },
                { name: "Salame pecorino e pomodori secchi", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 620, ingredients: ["Salame", "Pecorino", "Pomodori secchi"] },
                { name: "Speck Brie e pomodori secchi", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 610, ingredients: ["Speck", "Brie", "Pomodori secchi"] },
                { name: "Porchetta", allergens: ["G"], diet: ["carne/pesce"], calories: 650, ingredients: ["Porchetta di Ariccia"] },
                { name: "Vegetariano melanzane zucchine e peperoni", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 450, ingredients: ["Melanzane", "Zucchine", "Peperoni grigliati"] },
                { name: "Tacchino e verdura", allergens: ["G"], diet: ["carne/pesce"], calories: 480, ingredients: ["Tacchino arrosto", "Verdura di stagione"] },
                { name: "Bresaola parmigiano e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 500, ingredients: ["Bresaola", "Parmigiano a scaglie", "Rucola"] },
                { name: "Bresaola primo sale e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 470, ingredients: ["Bresaola", "Primo sale", "Rucola"] },
                { name: "Salmone e formaggio", allergens: ["G", "L", "P"], diet: ["carne/pesce"], calories: 530, ingredients: ["Salmone affumicato", "Formaggio spalmabile"] },
                { name: "Tonno e pomodoro", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 490, ingredients: ["Tonno", "Pomodoro a fette"] },
                { name: "Tonno e carciofini", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 510, ingredients: ["Tonno", "Carciofini sott'olio"] },
                { name: "Pane ai 5 cereali con formaggio spalmabile e salmone", allergens: ["G", "L", "P"], diet: ["carne/pesce"], calories: 540, ingredients: ["Pane 5 cereali", "Salmone affumicato", "Formaggio spalmabile"] },
                { name: "Pane ai 5 cereali con tacchino e zucchine o scarola", allergens: ["G"], diet: ["carne/pesce"], calories: 490, ingredients: ["Pane 5 cereali", "Tacchino arrosto", "Verdura di stagione"] },
                { name: "Cotoletta di pollo lattuga e pomodoro", allergens: ["G"], diet: ["carne/pesce"], calories: 580, ingredients: ["Cotoletta di pollo", "Lattuga", "Pomodoro"] },
                { name: "Brasato di manzo e verdura cotta", allergens: ["G"], diet: ["carne/pesce"], calories: 620, ingredients: ["Brasato di manzo", "Verdura cotta di stagione (broccoletti/cicoria/scarola)"] }
            ],
            pizze: [
                { name: "Pizza con insalata di pollo con maionese", allergens: ["G"], diet: ["carne/pesce"], calories: 560, ingredients: ["Insalata di pollo con maionese"] },
                { name: "Pizza classica con bresaola, filadelfia e rughetta", price: 3.50, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 570, ingredients: ["Bresaola", "Filadelfia", "Rughetta"] },
                { name: "Pizza con tacchino e verdure", price: 3.50, allergens: ["G"], diet: ["carne/pesce"], calories: 490, ingredients: ["Tacchino arrosto", "Verdure di stagione"] },
                { name: "Crudo e mozzarella", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 600, ingredients: ["Prosciutto crudo", "Mozzarella"] },
                { name: "Speck stracchino e rughetta", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 650, ingredients: ["Speck", "Stracchino", "Rucola"] },
                { name: "Cotto arrosto e melanzane", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580, ingredients: ["Prosciutto cotto", "Melanzane"] },
                { name: "Mortadella e stracciatella", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 700, ingredients: ["Mortadella", "Stracciatella"] },
                { name: "Frittata e zucchine", allergens: ["G", "L"], diet: ["vegetariano"], calories: 550, ingredients: ["Frittata", "Zucchine"] },
                { name: "Bresaola e formaggio", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 580, ingredients: ["Bresaola", "Formaggio"] },
                { name: "Cotto e stracchino", allergens: ["G", "L"], diet: ["carne/pesce"], calories: 620, ingredients: ["Prosciutto cotto", "Stracchino"] },
                // Pizze Rustiche Aggiunte
                { name: "Pizza Rustica: Scarola e olive", price: 8.00, isCustomPriced: true, pricingOptions: [ { text: 'Intera - 8.00‚Ç¨', value: '8.00' }, { text: 'Mezza - 4.00‚Ç¨', value: '4.00' }, { text: '1/4 - 2.00‚Ç¨', value: '2.00' } ], allergens: ["G"], diet: ["vegetariano", "vegano"], ingredients: ["Scarola", "Olive"], calories: 500 },
                { name: "Pizza Rustica: Cicoria e pachino", price: 8.00, isCustomPriced: true, pricingOptions: [ { text: 'Intera - 8.00‚Ç¨', value: '8.00' }, { text: 'Mezza - 4.00‚Ç¨', value: '4.00' }, { text: '1/4 - 2.00‚Ç¨', value: '2.00' } ], allergens: ["G"], diet: ["vegetariano", "vegano"], ingredients: ["Cicoria", "Pomodorini Pachino"], calories: 480 },
                { name: "Pizza Rustica: Broccoli e salsiccia", price: 8.00, isCustomPriced: true, pricingOptions: [ { text: 'Intera - 8.00‚Ç¨', value: '8.00' }, { text: 'Mezza - 4.00‚Ç¨', value: '4.00' }, { text: '1/4 - 2.00‚Ç¨', value: '2.00' } ], allergens: ["G"], diet: ["carne/pesce"], ingredients: ["Broccoli", "Salsiccia"], calories: 620 }
            ],
            gastronomia: [
                // Monoporzioni Aggiunte
                { name: "Melanzane alla parmigiana (grigliate, 250-300g)", price: 6.00, allergens: ["L"], diet: ["vegetariano"], calories: 350, ingredients: ["Melanzane grigliate", "Pomodoro", "Parmigiano"] },
                { name: "Lasagna classica al rag√π (250-300g)", price: 6.00, allergens: ["G", "L"], diet: ["carne/pesce"], calories: 550, ingredients: ["Sfoglia all'uovo", "Rag√π di carne", "Besciamella"] },
                // Esistenti
                { name: "Cous cous vegetale con pollo", allergens: ["G"], diet: ["carne/pesce"], calories: 450, ingredients: ["Cous cous", "Verdure miste", "Pollo"] },
                { name: "Cous cous vegetale", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 350, ingredients: ["Cous cous", "Verdure miste"] },
                { name: "Farro vegetale", allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 380, ingredients: ["Farro", "Verdure miste"] },
                { name: "Farro vegetale con salmone", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 480, ingredients: ["Farro", "Verdure miste", "Salmone"] },
                { name: "Riso Venere con gamberi e zucchine", allergens: ["C"], diet: ["carne/pesce"], calories: 420, ingredients: ["Riso Venere", "Gamberi", "Zucchine"] },
                { name: "Insalata di riso", allergens: [], diet: ["carne/pesce"], calories: 400, ingredients: ["Riso", "Wurstel", "Uova", "Verdure sott'olio"] },
                { name: "Pasta fredda con tonno pomodori e olive", allergens: ["G", "P"], diet: ["carne/pesce"], calories: 450, ingredients: ["Pasta", "Tonno", "Pomodorini", "Olive"] },
                { name: "Pasta fredda pesto primo sale pomodori olive", allergens: ["G", "L"], diet: ["vegetariano"], calories: 500, ingredients: ["Pasta", "Pesto", "Formaggio primo sale", "Pomodorini", "Olive"] },
                { name: "Insalata di pollo", allergens: [], diet: ["carne/pesce"], calories: 350, ingredients: ["Pollo", "Insalata", "Mais", "Pomodorini", "Olive"] },
                { name: "Riso integrale bresaola limone e rughetta", allergens: [], diet: ["carne/pesce"], calories: 380, ingredients: ["Riso integrale", "Bresaola", "Rucola", "Succo di limone"] },
                { name: "Pomodori con il riso (2 pz)", price: 6.00, allergens: [], diet: ["vegetariano", "vegano"], calories: 320, ingredients: ["Pomodori", "Riso", "Patate al forno"] }
            ],
            insalatone: [
                { name: "Insalatona con Uovo Sodo", diet: ["vegetariano"], allergens: [], calories: 380, ingredients: ["Base: Misticanza, mais, pomodorini, olive e carote", "Proteina: Uovo Sodo"] },
                { name: "Insalatona con Primo Sale", diet: ["vegetariano"], allergens: ["L"], calories: 420, ingredients: ["Base: Misticanza, mais, pomodorini, olive e carote", "Proteina: Primo Sale"] },
                { name: "Insalatona con Tonno", diet: ["carne/pesce"], allergens: ["P"], calories: 450, ingredients: ["Base: Misticanza, mais, pomodorini, olive e carote", "Proteina: Tonno"] }
            ],
            verdure: [ { name: "Melanzane", allergens: [], diet: ["vegetariano", "vegano"], calories: 180, ingredients: ["Melanzane grigliate"] }, { name: "Zucchine", allergens: [], diet: ["vegetariano", "vegano"], calories: 160, ingredients: ["Zucchine grigliate"] }, { name: "Peperoni", allergens: [], diet: ["vegetariano", "vegano"], calories: 160, ingredients: ["Peperoni arrostiti"] }, { name: "Cicoria", allergens: [], diet: ["vegetariano", "vegano"], calories: 140, ingredients: ["Cicoria ripassata"] }, { name: "Broccoletti", allergens: [], diet: ["vegetariano", "vegano"], calories: 150, ingredients: ["Broccoletti ripassati"] }, { name: "Broccoli", allergens: [], diet: ["vegetariano", "vegano"], calories: 150, ingredients: ["Broccoli al vapore"] }, { name: "Scarola con olive", allergens: [], diet: ["vegetariano", "vegano"], calories: 130, ingredients: ["Scarola", "Olive di Gaeta"] } ],
            fritti: [
                { name: "Pizzetta rossa", price: 1.50, isCustomPriced: true, pricingOptions: [ { text: '2 pz - 1.50‚Ç¨', value: '1.50' }, { text: '3 pz - 2.00‚Ç¨', value: '2.00' }, { text: '6 pz - 4.00‚Ç¨', value: '4.00' } ], allergens: ["G"], diet: ["vegetariano"], calories: 180, ingredients: ["Pomodoro", "Pasta per pizza"] },
                { name: "Lingua romana scrocchiarella", price: 1.50, allergens: ["G"], diet: ["vegetariano", "vegano"], calories: 190, ingredients: ["Pomodoro", "Olio EVO"] },
                { name: "Suppl√¨", allergens: ["G", "L"], diet: ["vegetariano"], calories: 250, ingredients: ["Riso", "Pomodoro", "Mozzarella", "Pangrattato"] },
                { name: "Polpetta di melanzane", allergens: ["G", "L"], diet: ["vegetariano"], calories: 180, ingredients: ["Melanzane", "Parmigiano", "Uova", "Pangrattato"] }
            ],
            dessert: [
                { name: "Macedonia", allergens: [], diet: ["vegetariano", "vegano"], calories: 120, ingredients: ["Frutta fresca di stagione"] },
                // Pasticceria Aggiunta
                { name: "Crostatina alla marmellata", price: 1.50, allergens: ["G"], diet: ["vegetariano"], calories: 220, ingredients: ["Pasta frolla", "Marmellata"] },
                { name: "Lingue di gatto e ferretti glassati", price: 0.00, allergens: ["G", "L"], diet: ["vegetariano"], calories: 150, ingredients: ["Biscotti secchi", "Cioccolato"], note: "Prezzo da definire" }
            ]
        };
        // --- FINE MENU AGGIORNATO ---


        const state = {
            currentUser: null,
            currentView: 'menu',
            activeCategoryFilter: 'all',
            activeDietFilter: 'all',
            searchTerm: '',
            cart: [],
            allOrders: [],
            menuData: [],
            caloriesVisible: false,
            currentComboItem: null,
            customSandwich: {
                base: null,
                subtype: null,
                ingredients: [],
                basePrice: CUSTOM_PRODUCT_BASE_PRICE,
                totalPrice: 0
            }
        };
        const dom = { };

        function updateIngredientsWithOlives(menu) {
            for (const category in menu) {
                menu[category].forEach(item => {
                    const hasSalad = item.name.toLowerCase().includes('insalata') ||
                                     (item.ingredients && item.ingredients.some(ing => ing.toLowerCase().includes('insalata')));
                    if (hasSalad) {
                        if (!item.ingredients) item.ingredients = [];
                        const hasOlives = item.ingredients.some(ing => ing.toLowerCase().includes('olive'));
                        if (!hasOlives) item.ingredients.push('Olive');
                    }
                });
            }
            return menu;
        }

        function processMenuData(rawMenu, prices) {
            const updatedMenu = updateIngredientsWithOlives(rawMenu);
            let id = 1;
            const icons = { gastronomia: 'fa-bowl-food', fritti: 'fa-stroopwafel', verdure: 'fa-carrot', panini: 'fa-bread-slice', pizze: 'fa-pizza-slice', dessert: 'fa-ice-cream', "men√π combinati": 'fa-box-open', insalatone: 'fa-seedling' };
            return Object.entries(updatedMenu).flatMap(([cat, items]) => items.map(item => ({ id: id++, name: item.name, category: cat.charAt(0).toUpperCase() + cat.slice(1), price: item.price !== undefined ? item.price : (prices[cat] || 0), icon: icons[cat] || 'fa-utensils', ...item })))
        }

        function showToast(message, duration = 3000) { dom.toastMessageEl.textContent = message; dom.toastEl.classList.remove('opacity-0'); setTimeout(() => dom.toastEl.classList.add('opacity-0'), duration); }

        function navigate(viewName) {
            state.currentView = viewName;
            dom.views.forEach(v => v.classList.toggle('active', v.id === `${viewName}-view`));
            dom.navBtns.forEach(b => { b.classList.toggle('bg-primary', b.dataset.view === viewName); b.classList.toggle('text-white', b.dataset.view === viewName); });
            if (viewName === 'my-order') renderMyOrder();
            if (viewName === 'all-orders') renderAllOrders();
            if (viewName === 'custom-sandwich') renderCustomSandwichBuilder();

            // Scrolling behavior
            const targetElement = document.getElementById(viewName + "-view");
            if (targetElement) {
                const navHeight = dom.navEl.offsetHeight;
                const targetOffsetTop = targetElement.getBoundingClientRect().top + window.scrollY;
                const finalPosition = targetOffsetTop - navHeight - 32; // 32px padding (adjust as needed)

                window.scrollTo({
                    top: finalPosition,
                    behavior: 'smooth'
                });
            }
        }

        function updateFilterCounter() {
            let count = 0; if (state.activeCategoryFilter !== 'all') count++; if (state.activeDietFilter !== 'all') count++; if(state.searchTerm) count++;
            dom.filterCounterContainer.innerHTML = count > 0 ? `<i class="fas fa-filter text-primary"></i> ${count} ${count === 1 ? 'filtro applicato' : 'filtri applicati'}` : '';
        }

        function renderFilters() {
            let catSelectHtml = `<option value="all">Tutte le Categorie</option>`;
            CATEGORY_ORDER.forEach(catKey => {
                 const catName = catKey.charAt(0).toUpperCase() + catKey.slice(1);
                 catSelectHtml += `<option value="${catKey.toLowerCase()}">${catName}</option>`;
             });
            dom.categorySelect.innerHTML = catSelectHtml;

            let dietSelectHtml = `<option value="all">Tutti i Regimi</option>`; Object.entries(DIETS).forEach(([key, info]) => { dietSelectHtml += `<option value="${key}">${info.icon} ${info.name}</option>`; }); dom.dietSelect.innerHTML = dietSelectHtml;
            let legendHtml = ''; Object.values(ALLERGENS).forEach(info => { legendHtml += `<p class="flex items-center text-base mb-1"><i class="fas ${info.icon} mr-2 text-gray-600"></i> ${info.name}</p>`; }); dom.allergenModalContent.innerHTML = legendHtml;
        }

        function renderMenu() {
            const term = state.searchTerm.toLowerCase();
            const filtered = state.menuData.filter(item => (item.name.toLowerCase().includes(term)) && (state.activeCategoryFilter === 'all' || item.category.toLowerCase() === state.activeCategoryFilter) && (state.activeDietFilter === 'all' || (item.diet && item.diet.includes(state.activeDietFilter))));

            if (filtered.length === 0) {
                 dom.menuItemsContainer.innerHTML = `<div class="text-center p-8 col-span-full bg-white rounded-xl shadow"><p class="text-gray-500">Nessun piatto trovato.</p></div>`;
                 return;
            }

            let currentCategory = '';
            let menuHtml = '';
            const sortedItems = filtered.sort((a, b) => CATEGORY_ORDER.indexOf(a.category) - CATEGORY_ORDER.indexOf(b.category));

            sortedItems.forEach(item => {
                if (item.category !== currentCategory) {
                    currentCategory = item.category;
                    menuHtml += `<div class="col-span-full mt-6 mb-2"><h3 class="text-2xl font-bold border-b-2 border-primary-light pb-2">${currentCategory}</h3></div>`;
                }

                const allergenHtml = (item.allergens || []).map(key => `<i class="fas ${ALLERGENS[key]?.icon || 'fa-question-circle'}" title="${ALLERGENS[key]?.name || 'Allergene sconosciuto'}"></i>`).join(' ');

                let priceOrPortionSelectorHtml = `<span class="font-semibold text-lg">‚Ç¨${item.price.toFixed(2)}</span>`;
                
                // --- Gestione Prezzo da Definire ---
                if (item.price === 0.00 && item.note) {
                     priceOrPortionSelectorHtml = `<span class="font-semibold text-sm text-red-500">Prezzo da definire</span>`;
                }
                // --- Fine Gestione ---

                if ((item.category === 'Verdure' || item.isCustomPriced) && !(item.price === 0.00 && item.note)) {
                    let options;
                    if (item.category === 'Verdure') {
                        options = [
                            { text: '100g - 2.00‚Ç¨', value: '2.00' },
                            { text: '150g - 3.00‚Ç¨', value: '3.00' },
                            { text: '200g - 4.00‚Ç¨', value: '4.00' }
                        ];
                    } else { // isCustomPriced
                        options = item.pricingOptions;
                    }

                    const initialPrice = options[0].value;
                    const optionsHtml = options.map(opt => `<option value="${opt.value}" ${opt.value === initialPrice ? 'selected' : ''}>${opt.text}</option>`).join('');

                    priceOrPortionSelectorHtml = `
                        <div class="flex items-center gap-2">
                            <select data-id="${item.id}" class="portion-select bg-gray-50 border border-gray-300 text-sm rounded-lg p-2">
                                ${optionsHtml}
                            </select>
                            <span id="price-display-${item.id}" class="font-bold text-lg text-primary w-20 text-right">‚Ç¨${parseFloat(initialPrice).toFixed(2)}</span>
                        </div>
                    `;
                }

                const noteHtml = item.note ? `<p class="text-xs text-red-500 ml-9 mt-1">${item.note}</p>` : '';
                const addButtonDisabled = (item.price === 0.00 && item.note) ? 'disabled' : '';
                const addButtonClass = (item.price === 0.00 && item.note) ? 'bg-gray-400 cursor-not-allowed' : 'bg-primary hover:bg-primary-dark';


                menuHtml += `
                <div class="bg-white p-4 rounded-xl shadow-md flex flex-col hover:shadow-lg transition-all duration-300">
                    <div class="flex-grow">
                        <div class="flex items-start mb-2">
                            <i class="fas ${item.icon} text-primary text-xl mr-3 w-6 text-center pt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg">${item.name}</h3>
                                <p class="text-text-main/70 text-sm">${item.category}</p>
                            </div>
                        </div>
                        <p class="text-xs text-text-main/80 ml-9 mt-1"><span class="font-semibold">Ingredienti:</span> ${item.ingredients ? item.ingredients.join(', ') : 'Non specificati'}</p>
                        ${noteHtml}
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <div class="flex gap-3 text-lg items-center text-text-main/70">${allergenHtml}</div>
                        ${priceOrPortionSelectorHtml}
                    </div>
                    <p class="calorie-info text-xs text-text-main/70 text-right mt-1" style="display: ${state.caloriesVisible ? 'flex' : 'none'}; justify-content: flex-end; align-items: center;">
                        ~${item.calories || 'N/A'} kcal <i class="fas fa-question-circle text-primary ml-1 cursor-pointer calorie-info-icon"></i>
                    </p>
                    <button data-id="${item.id}" class="add-to-cart-btn w-full mt-4 ${addButtonClass} text-white font-bold py-2 px-4 rounded-lg transition-all duration-300" ${addButtonDisabled}><i class="fas fa-plus mr-2"></i> Aggiungi</button>
                </div>`;
            });
            dom.menuItemsContainer.innerHTML = menuHtml;
        }

        function renderMyOrder() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todaysUserOrder = state.allOrders.find(order => order.uid === state.currentUser?.uid && order.createdAt && order.createdAt.toDate() >= today);

            if (todaysUserOrder) {
                const itemsHtml = todaysUserOrder.items.map(item => `<li class="flex justify-between items-center text-sm"><span>${item.quantity} x ${item.name}</span><span class="font-medium">‚Ç¨${(item.price * item.quantity).toFixed(2)}</span></li>`).join('');
                
                const notesHtml = `
                    ${todaysUserOrder.allergies ? `<p class="text-sm mt-2 p-2 bg-red-50 border-l-4 border-red-400"><b class="text-red-700">Allergie:</b> ${todaysUserOrder.allergies}</p>` : ''}
                    ${todaysUserOrder.cutlery ? `<p class="text-sm mt-2 p-2 bg-green-50 border-l-4 border-green-400"><b>Posate richieste.</b></p>` : ''}
                `;

                const responseHtml = todaysUserOrder.restaurateurResponse
                    ? `<div id="restaurateur-response" class="mt-4 p-3 rounded-lg bg-yellow-100 border-l-4 border-yellow-400">
                            <p class="font-bold text-yellow-800"><i class="fas fa-comment-dots mr-2"></i>Messaggio dal ristoratore:</p>
                            <p class="text-yellow-700">${todaysUserOrder.restaurateurResponse}</p>
                        </div>`
                    : '';

                dom.myOrderContentEl.innerHTML = `
                    <p class="mb-4">Hai gi√† inviato il tuo ordine per oggi. Ecco il riepilogo:</p>
                    <ul class="space-y-2 border-t border-b py-4">${itemsHtml}</ul>
                    <div class="text-right font-bold text-2xl mt-4">Totale: ‚Ç¨${todaysUserOrder.total.toFixed(2)}</div>
                    <div class="mt-2">${notesHtml}</div>
                    ${responseHtml}
                    <p class="text-xs text-gray-500 mt-4 text-center">Puoi modificare o eliminare l'ordine dalla sezione "Tutti gli Ordini" entro le 11:30.</p>
                `;
                dom.cartCountEl.textContent = '‚úì';
                return;
            }

            const totalItems = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            dom.cartCountEl.textContent = totalItems;
            if (state.cart.length === 0) {
                dom.myOrderContentEl.innerHTML = `<p class="text-center text-gray-500 py-8">Il tuo carrello √® vuoto.</p>`;
                return;
            }

            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            const itemsHtml = state.cart.map(item => {
                let detailsHtml = (item.isCustom || item.isCombo)
                    ? `<p class="text-xs text-gray-500 mt-1">${item.details}</p>`
                    : '';

                return `
                <div class="py-4 border-b border-gray-200">
                    <div class="flex justify-between items-start">
                        <div><p class="font-semibold">${item.name}</p><p class="text-sm text-text-main/70">‚Ç¨${item.price.toFixed(2)}</p></div>
                        <div class="flex items-center gap-3">
                            <button data-id="${item.cartId}" data-action="decrease" class="cart-qty-btn bg-gray-200 rounded-full h-8 w-8 transition-all duration-300">-</button>
                            <span class="font-bold text-lg">${item.quantity}</span>
                            <button data-id="${item.cartId}" data-action="increase" class="cart-qty-btn bg-gray-200 rounded-full h-8 w-8 transition-all duration-300">+</button>
                            <button data-id="${item.cartId}" class="cart-remove-btn text-red-500 text-lg flex-shrink-0 ml-4 transition-all duration-300"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    ${detailsHtml}
                </div>`;
            }).join('');

            // Blocco 'paymentOptionsHtml' e blocco blu rimossi.

            dom.myOrderContentEl.innerHTML = `
                <div class="space-y-4 mb-4">${itemsHtml}</div>
                <div class="mt-6 space-y-4">
                    
                    <div>
                        <label for="allergies-input" class="block mb-2 font-semibold text-red-700"><i class="fas fa-exclamation-triangle mr-2"></i>Segnalazione Allergie Importanti:</label>
                        <textarea id="allergies-input" placeholder="Per favore, specifica qui eventuali allergie gravi." class="w-full p-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-400"></textarea>
                    </div>

                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                        <label for="cutlery-checkbox" class="font-semibold cursor-pointer">Hai bisogno di posate?</label>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none">
                            <input type="checkbox" name="cutlery-checkbox" id="cutlery-checkbox" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 ease-in-out"/>
                            <label for="cutlery-checkbox" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>

                <a href="https://www.satispay.com/it-it/privati/" target="_blank" 
                    class="block mt-4 p-3 rounded-lg shadow-sm bg-primary-100 border-2 border-primary">
                   
                    <div class="flex items-center justify-center gap-3 sm:gap-4">
                        <div class="text-left text-primary-800 flex-1">
                            <p class="font-bold text-lg leading-tight">Scarica l'app e</p>
                            <p class="font-bold text-lg leading-tight">ottieni 5‚Ç¨</p>
                            <p class="font-semibold text-base mt-1">con il codice: <span class="font-extrabold">WEB</span></p>
                        </div>
                        <div class="flex-shrink-0 w-24 h-24 sm:w-28 sm:h-28">
                            <img src="https://www.satispay.com/_next/image/?url=https%3A%2F%2Fwww.datocms-assets.com%2F133951%2F1737978066-qr_code_svg_giftcard_mainpage.svg" 
                                alt="QR Code Satispay" 
                                class="w-full h-full object-cover rounded-md bg-white p-1">
                        </div>
                    </div>
                </a>
                
                <div class="mt-6">
                    <h4 class="block mb-2 font-semibold">Metodo di Pagamento</h4>
                    <div class="mt-2">
                        <input type="radio" id="payment-Satispay" name="payment-method" value="Satispay" class="hidden payment-radio" checked disabled>
                        <label for="payment-Satispay" class="block border-2 border-primary rounded-lg p-3 text-center cursor-not-allowed opacity-100" style="box-shadow: 0 0 0 2px rgba(214, 128, 79, 0.4);">
                            <i class="fas fa-mobile-alt text-2xl text-primary"></i>
                            <span class="block text-sm font-semibold mt-2">Satispay</span>
                            <span class="block text-xs text-text-main/60 mt-1 font-normal">Pagamento da effettuare entro le 11:30.</span>
                        </label>
                    </div>
                </div>

                <div class="text-right font-bold text-2xl mt-6">Totale: ‚Ç¨${total.toFixed(2)}</div>
                
                <button id="confirm-order-btn" class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">
                    <i class="fab fa-satispay mr-2"></i>Paga ora e Invia Ordine
                </button>
            `;
        }

        function renderCustomSandwichBuilder() {
            state.customSandwich = { base: null, subtype: null, ingredients: [], basePrice: CUSTOM_PRODUCT_BASE_PRICE, totalPrice: 0 };

            dom.baseChoiceContainer.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
            dom.subtypeChoiceContainer.classList.add('hidden');
            dom.ingredientsStepContainer.classList.add('hidden');

            const ingredientsHtml = SANDWICH_INGREDIENTS.map(ing => `
                <div data-id="${ing.id}" class="ingredient-card bg-white p-3 rounded-lg shadow-sm cursor-pointer border-2 border-transparent transition-all duration-200 flex flex-col justify-center items-center text-center">
                    <p class="font-semibold text-sm">${ing.name}</p>
                </div>
            `).join('');
            dom.ingredientsList.innerHTML = ingredientsHtml;
            updateSandwichSummary();
        }

        function updateSandwichSummary() {
            const { ingredients, basePrice, base, subtype } = state.customSandwich;

            if (!base || !subtype) {
                dom.sandwichTotalPrice.textContent = `‚Ç¨0.00`;
                dom.addSandwichBtn.disabled = true;
                dom.selectedIngredientsList.innerHTML = `<li class="text-gray-400">Seleziona una base e una variante...</li>`;
                dom.sandwichBaseSummary.textContent = `Seleziona una base...`;
                dom.extraChargeNotice.textContent = '';
                return;
            }

            dom.sandwichBaseSummary.textContent = `${BASE_OPTIONS[base].name} (${subtype})`;

            let currentPrice = basePrice;
            const extraIngredientsCount = Math.max(0, ingredients.length - CUSTOM_PRODUCT_INCLUDED_INGREDIENTS);
            currentPrice += extraIngredientsCount * CUSTOM_PRODUCT_EXTRA_INGREDIENT_PRICE;

            dom.extraChargeNotice.textContent = extraIngredientsCount > 0 ? `Supplemento: +‚Ç¨${(extraIngredientsCount * CUSTOM_PRODUCT_EXTRA_INGREDIENT_PRICE).toFixed(2)}` : '';

            const listHtml = ingredients.map((ing, index) => {
                const priceText = index < CUSTOM_PRODUCT_INCLUDED_INGREDIENTS ? '(incluso)' : `+‚Ç¨${CUSTOM_PRODUCT_EXTRA_INGREDIENT_PRICE.toFixed(2)}`;
                return `<li class="flex justify-between"><span>${ing.name}</span> <span class="text-gray-500">${priceText}</span></li>`;
            }).join('');

            if (ingredients.length === 0) {
                dom.selectedIngredientsList.innerHTML = `<li class="text-gray-400">Seleziona fino a 3 ingredienti inclusi...</li>`;
            } else {
                 dom.selectedIngredientsList.innerHTML = listHtml;
            }

            state.customSandwich.totalPrice = currentPrice;
            dom.sandwichTotalPrice.textContent = `‚Ç¨${currentPrice.toFixed(2)}`;

            dom.addSandwichBtn.disabled = ingredients.length < 1;

            document.querySelectorAll('.ingredient-card').forEach(card => {
                const cardId = card.dataset.id;
                card.classList.toggle('selected', ingredients.some(ing => ing.id === cardId));
            });
        }

        function renderAllOrders() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todaysOrders = state.allOrders.filter(order => order.createdAt && order.createdAt.toDate() >= today).sort((a, b) => a.user.localeCompare(b.user));

            const now = new Date();
            const isBeforeCutoff = now.getHours() < 11 || (now.getHours() === 11 && now.getMinutes() < 30);

            if (todaysOrders.length === 0) {
                dom.allOrdersListEl.innerHTML = `<div class="text-center p-8 bg-white rounded-xl shadow"><p class="text-gray-500">Nessun ordine per oggi.</p></div>`;
                dom.grandTotalEl.textContent = '‚Ç¨0.00';
                return;
            }

            let grandTotal = 0;
            const ordersHtml = todaysOrders.map(order => {
                grandTotal += order.total;

                const itemsHtml = order.items.map(item => {
                    let detailsHtml = item.details
                        ? `<p class="text-xs text-gray-500 pl-4">${item.details}</p>`
                        : '';
                    return `
                        <li class="text-sm py-1">
                            <div class="flex justify-between items-center">
                                <span>${item.quantity} x ${item.name}</span>
                                <span class="font-medium">‚Ç¨${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                            ${detailsHtml}
                        </li>`;
                }).join('');
                
                const notesHtml = `
                    ${order.allergies ? `<p class="text-xs text-red-700 mt-2 pl-4 border-l-2 border-red-300"><b>Allergie:</b> ${order.allergies}</p>` : ''}
                    ${order.cutlery ? `<p class="text-xs text-secondary-800 mt-2 pl-4 border-l-2 border-secondary-light"><b><i class="fas fa-utensils"></i> Posate richieste</b></p>` : ''}
                `;
                const paymentInfo = PAYMENT_METHODS[order.paymentMethod] || { name: order.paymentMethod, icon: 'fa-credit-card' };

                const deleteButtonHtml = (state.currentUser?.uid === order.uid && isBeforeCutoff)
                    ? `<button data-id="${order.id}" class="delete-order-btn text-red-500 hover:text-red-700 ml-2 text-sm" title="Elimina ordine"><i class="fas fa-trash-alt"></i></button>`
                    : `<button class="text-gray-300 ml-2 text-sm cursor-not-allowed" disabled title="Eliminazione bloccata dopo le 11:30 o non sei il proprietario"><i class="fas fa-trash-alt"></i></button>`;

                const restaurateurResponseHtml = `
                    <div class="mt-3 pt-3 border-t">
                        <label for="response-input-${order.id}" class="text-xs font-semibold">Risposta del ristoratore:</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="response-input-${order.id}" class="flex-grow p-1 border rounded text-sm" value="${order.restaurateurResponse || ''}" placeholder="Invia un messaggio al cliente...">
                            <button data-id="${order.id}" class="save-response-btn bg-secondary hover:bg-secondary-dark text-white text-xs px-3 rounded">Salva</button>
                        </div>
                    </div>
                `;

                return `
                    <div id="order-${order.id}" class="bg-white p-4 rounded-xl shadow-md transition-all duration-300 ${order.paid ? 'paid-order' : ''}">
                        <div class="flex justify-between items-start border-b pb-2 mb-2">
                            <div>
                                <h4 class="font-bold text-lg">${order.user}</h4>
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded-full"><i class="fas ${paymentInfo.icon} mr-2"></i>${paymentInfo.name}</span>
                            </div>
                            <div class="text-right flex items-center">
                                <span class="font-bold text-primary text-lg">‚Ç¨${order.total.toFixed(2)}</span>
                                ${deleteButtonHtml}
                            </div>
                        </div>
                        <ul class="space-y-1">${itemsHtml}</ul>
                        ${notesHtml}
                        ${restaurateurResponseHtml}
                    </div>`;
            }).join('');
            dom.allOrdersListEl.innerHTML = ordersHtml;
            dom.grandTotalEl.textContent = `‚Ç¨${grandTotal.toFixed(2)}`;
        }

        function handlePaymentChange(target) {
            const confirmBtn = document.getElementById('confirm-order-btn');
            if (!confirmBtn) return;
        }

        function handleEvents(event) {
            const target = event.target;
            const button = target.closest('button');
            const navLink = target.closest('a.nav-btn');
            const ingredientCard = target.closest('.ingredient-card');
            const choiceBtn = target.closest('.choice-btn');

            if (navLink) {
                event.preventDefault();
                navigate(navLink.dataset.view);
            }
            else if (choiceBtn) {
                if (choiceBtn.classList.contains('subtype-choice-btn')) {
                    state.customSandwich.subtype = choiceBtn.dataset.subtype;
                    dom.subtypeOptions.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
                    choiceBtn.classList.add('selected');
                    dom.ingredientsStepContainer.classList.remove('hidden');
                } else { // Base choice
                    const type = choiceBtn.dataset.type;
                    state.customSandwich.base = type;
                    state.customSandwich.subtype = null; // Reset subtype

                    dom.baseChoiceContainer.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
                    choiceBtn.classList.add('selected');

                    const subtypes = BASE_OPTIONS[type].subtypes;
                    dom.subtypeOptions.innerHTML = subtypes.map(st => `<button data-subtype="${st}" class="choice-btn subtype-choice-btn flex-1 p-3 bg-gray-50 rounded-lg shadow-sm border-2 border-transparent transition-all duration-200">${st}</button>`).join('');

                    dom.subtypeChoiceContainer.classList.remove('hidden');
                    dom.ingredientsStepContainer.classList.add('hidden'); // Hide ingredients until subtype is selected
                }
                updateSandwichSummary();
            }
            else if (ingredientCard) {
                const ingredientId = ingredientCard.dataset.id;
                const selectedIngredient = SANDWICH_INGREDIENTS.find(ing => ing.id === ingredientId);
                const index = state.customSandwich.ingredients.findIndex(ing => ing.id === ingredientId);

                if (index > -1) {
                    state.customSandwich.ingredients.splice(index, 1);
                } else {
                    state.customSandwich.ingredients.push(selectedIngredient);
                }
                updateSandwichSummary();
            }
            else if (event.type === 'click' && button) {
                handleClicks(button);
            }
            else if (event.type === 'change' && target.matches('.portion-select')) {
                const price = target.value;
                const itemId = target.dataset.id;
                const priceElement = document.getElementById(`price-display-${itemId}`);
                if (priceElement) {
                    priceElement.textContent = `‚Ç¨${parseFloat(price).toFixed(2)}`;
                }
            }
            else if (event.type === 'change' && target.matches('select')) {
                handleSelectChange(target);
            } else if (event.type === 'input' && target.id === 'search-input') {
                state.searchTerm = target.value;
                updateFilterCounter();
                renderMenu();
            }
        }

        function handleSelectChange(target) {
            if (target.id === 'category-select') state.activeCategoryFilter = target.value;
            else if (target.id === 'diet-select') state.activeDietFilter = target.value;
            updateFilterCounter();
            renderMenu();
        }

        function openComboModal(item) {
            state.currentComboItem = item;
            const panini = state.menuData.filter(m => m.category === 'Panini' && !m.name.toLowerCase().includes("5 cereali"));
            dom.comboPaninoSelect.innerHTML = panini.map(p => `<option value="${p.name}">${p.name}</option>`).join('');

            let drinks = [];
            const drinkLabel = dom.comboDrinkLabel; // Usa l'elemento DOM memorizzato

            if (item.comboType === 'panino_acqua_50cl') {
                drinks = ['Acqua naturale 50cl', 'Acqua frizzante 50cl'];
                drinkLabel.textContent = 'Scegli l\'Acqua (50cl):';
            } else if (item.comboType === 'panino_33cl') {
                drinks = ['Coca Cola 33cl', 'Fanta 33cl', 'T√® freddo 33cl'];
                drinkLabel.textContent = 'Scegli la Bevanda (33cl):';
            } else if (item.comboType === 'panino_bevanda_50cl') {
                drinks = ['Coca Cola 50cl', 'Fanta 50cl', 'T√® freddo 50cl']; // Assunzione
                drinkLabel.textContent = 'Scegli la Bevanda (50cl):';
            } else {
                // Fallback
                drinks = ['Acqua naturale', 'Acqua frizzante', 'Coca Cola', 'Fanta', 'T√® freddo'];
                drinkLabel.textContent = 'Scegli la Bevanda:';
            }

            dom.comboDrinkSelect.innerHTML = drinks.map(d => `<option value="${d}">${d}</option>`).join('');

            dom.comboModal.classList.remove('hidden');
        }

        function closeComboModal() {
            state.currentComboItem = null;
            dom.comboModal.classList.add('hidden');
        }

        async function handleClicks(button) {
             if (button.matches('.nav-btn')) {
                 navigate(button.dataset.view);
             }
             // --- SNIPPET SATISPAY CLOSE AGGIORNATO ---
             else if (button.id === 'satispay-close-btn') {
                // Nasconde il modale di Satispay
                if (dom.satispayModal) {
                    dom.satispayModal.classList.add('hidden');
                }
                
                // Opzionale: puoi also reindirizzare l'utente 
                // alla pagina "I miei ordini" o alla home,
                // dato che l'ordine √® gi√† stato confermato.
                // navigate('my-order'); 
             }
             // --- FINE SNIPPET ---
             else if (button.matches('.add-to-cart-btn')) {
                  const item = { ...state.menuData.find(i => i.id === parseInt(button.dataset.id))};
                  if (!item) return;

                  if (item.isCombo) {
                       openComboModal(item);
                       return;
                  }

                  const portionSelect = document.querySelector(`.portion-select[data-id="${item.id}"]`);
                  if (portionSelect) {
                      const selectedOption = portionSelect.options[portionSelect.selectedIndex];
                      item.price = parseFloat(portionSelect.value);
                      const portionText = selectedOption.text.split(' - ')[0]; // Get only the portion text e.g., "100g"
                      item.name = `${item.name.split(' (')[0]} (${portionText})`; // Update name to include portion
                  }

                  const cartItem = { ...item, cartId: Date.now(), quantity: 1 };
                  state.cart.push(cartItem);
                  renderMyOrder();
                  showToast(`${item.name} aggiunto!`);
             }
             else if (button.id === 'add-sandwich-to-cart-btn') {
                 const { ingredients, totalPrice, subtype, base } = state.customSandwich;
                 if (ingredients.length < 1 || !base || !subtype) return; // Ensure base and subtype are selected

                 const ingredientNames = ingredients.map(ing => ing.name);
                 const sandwichName = `${subtype} personalizzato`;

                 state.cart.push({
                     cartId: Date.now(),
                     name: sandwichName,
                     price: totalPrice,
                     quantity: 1,
                     isCustom: true,
                     details: ingredientNames.join(', '),
                     category: base === 'panino' ? 'Panini' : 'Pizze', // Use base type for category
                 });

                 showToast('Prodotto personalizzato aggiunto!');
                 navigate('my-order'); // Go to cart after adding
             }
             else if (button.id === 'combo-add-btn') {
                 if (!state.currentComboItem) return;

                 const selectedPanino = dom.comboPaninoSelect.value;
                 const selectedDrink = dom.comboDrinkSelect.value;
                 const baseItem = state.currentComboItem;

                 const finalName = `Men√π (${selectedPanino} + ${selectedDrink})`;
                 const details = `Panino: ${selectedPanino}, Bevanda: ${selectedDrink}`;

                 state.cart.push({
                     cartId: Date.now(),
                     name: finalName,
                     details: details,
                     price: baseItem.price,
                     quantity: 1,
                     isCombo: true,
                     category: baseItem.category,
                 });

                 renderMyOrder();
                 showToast('Men√π aggiunto al carrello!');
                 closeComboModal();
             }
             else if (button.id === 'combo-cancel-btn') {
                 closeComboModal();
             }
             else if (button.matches('.cart-qty-btn')) {
                 const cartId = parseInt(button.dataset.id);
                 const itemInCart = state.cart.find(i => i.cartId === cartId);
                 if (itemInCart) {
                     if (button.dataset.action === 'increase') itemInCart.quantity++;
                     else if (button.dataset.action === 'decrease' && itemInCart.quantity > 1) itemInCart.quantity--;
                     else state.cart = state.cart.filter(i => i.cartId !== cartId); // Remove if quantity becomes 0
                 }
                 renderMyOrder();
             }
             else if (button.matches('.cart-remove-btn')) {
                 state.cart = state.cart.filter(i => i.cartId !== parseInt(button.dataset.id));
                 renderMyOrder();
             }
             else if (button.matches('.delete-order-btn')) {
                 const now = new Date();
                 if (now.getHours() > 11 || (now.getHours() === 11 && now.getMinutes() >= 30)) {
                     showToast("Non √® pi√π possibile eliminare gli ordini dopo le 11:30.");
                     return;
                 }
                 const orderId = button.dataset.id;
                 if (confirm('Sei sicuro di voler eliminare questo ordine? L\'azione √® irreversibile.')) {
                     try {
                         await deleteDoc(doc(db, "orders", orderId));
                         showToast("Ordine eliminato con successo.");
                     } catch (error) {
                         console.error("Errore eliminazione ordine:", error);
                         showToast("Impossibile eliminare l'ordine.");
                     }
                 }
             }
             else if (button.matches('.save-response-btn')) {
                 const orderId = button.dataset.id;
                 const responseInput = document.getElementById(`response-input-${orderId}`);
                 if (!orderId || !responseInput) return;

                 const responseText = responseInput.value.trim();
                 const orderRef = doc(db, "orders", orderId);
                 try {
                     await updateDoc(orderRef, { restaurateurResponse: responseText });
                     showToast("Risposta salvata.");
                 } catch (error) {
                     console.error("Errore salvataggio risposta: ", error);
                     showToast("Errore durante il salvataggio.", 4000);
                 }
             }
             else if (button.id === 'save-username-btn') {
                 const name = dom.usernameInput.value.trim();
                 const email = dom.userEmailInput.value.trim();
                 if (name && email && /^\S+@\S+\.\S+$/.test(email)) {
                     localStorage.setItem('dosepranza-username', name);
                     localStorage.setItem('dosepranza-useremail', email);
                     state.currentUser.name = name;
                     state.currentUser.email = email;
                     dom.userModal.classList.add('hidden');
                     updateAdminControlsVisibility();
                 } else if (!name) {
                     showToast("Per favore, inserisci il tuo nome.");
                 } else {
                     showToast("Per favore, inserisci un'email valida.");
                 }
             }
             else if (button.id === 'toggle-calories') {
                 state.caloriesVisible = !state.caloriesVisible;
                 button.querySelector('span').textContent = state.caloriesVisible ? 'Nascondi Calorie' : 'Mostra Calorie';
                 button.querySelector('i').className = `fas ${state.caloriesVisible ? 'fa-toggle-on' : 'fa-toggle-off'} mr-2`;
                 renderMenu(); // Re-render menu to show/hide calories
             }
             else if (button.id === 'show-allergens-btn') {
                 dom.allergenModal.classList.remove('hidden');
             }
             else if (button.id === 'close-allergen-modal-btn') {
                 dom.allergenModal.classList.add('hidden');
             }
             else if (button.id === 'confirm-order-btn') {
                 if (state.cart.length === 0) { showToast("Il tuo carrello √® vuoto."); return; }
                 
                 if (!state.currentUser || !state.currentUser.name || !state.currentUser.email) { 
                     showToast("Per favore, inserisci nome ed email."); 
                     dom.userModal.classList.remove('hidden'); 
                     return; 
                 }

                 const allergies = document.getElementById('allergies-input').value.trim();
                 const cutlery = document.getElementById('cutlery-checkbox').checked;
                 const paymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value;
                 if (!paymentMethod) { showToast("Seleziona un metodo di pagamento."); return; }

                 const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                 const itemsToSave = state.cart.map(item => ({
                     name: item.name,
                     category: item.category,
                     quantity: item.quantity,
                     price: item.price,
                     details: item.details || null
                 }));

                 const orderData = {
                     user: state.currentUser.name,
                     uid: state.currentUser.uid,
                     email: state.currentUser.email,
                     items: itemsToSave,
                     total,
                     allergies,
                     cutlery,
                     paymentMethod,
                     createdAt: serverTimestamp(),
                     paid: false,
                     restaurateurResponse: ""
                 };

                 try {
                     await addDoc(ordersCollectionRef, orderData);
                     
                     // --- SNIPPET SLACK AGGIUNTO ---
                     const slackWebhookUrl = 'https://hooks.slack.com/triggers/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'; 

                     const slackPayload = {
                         user_email: orderData.email,
                         user_name: orderData.user,
                         order_details: orderData.items.map(item => `${item.quantity}x ${item.name}`).join(', '),
                         order_total: orderData.total.toFixed(2),
                         allergies: orderData.allergies || 'Nessuna',
                         cutlery: orderData.cutlery ? 'S√¨' : 'No'
                     };

                     try {
                         await fetch(slackWebhookUrl, {
                             method: 'POST',
                             headers: {
                                 'Content-Type': 'application/json',
                             },
                             body: JSON.stringify(slackPayload),
                         });
                     } catch (slackError) {
                         console.error("Errore durante l'invio della notifica a Slack: ", slackError);
                         // Non blocchiamo l'ordine dell'utente se Slack fallisce,
                         // registriamo solo l'errore in console.
                     }
                     // --- FINE SNIPPET SLACK ---

                     if (orderData.paymentMethod === 'Satispay') {
                         dom.satispayModal.classList.remove('hidden');
                     }

                     showToast("Ordine confermato con successo!");
                     state.cart = []; // Clear cart
                     navigate('my-order'); // Navigate to confirmation/order view
                 } catch (error) {
                     console.error("Errore nell'invio dell'ordine: ", error);
                     showToast("Si √® verificato un errore. Riprova.", 4000);
                 }
             }
             else if (button.id === 'copy-summary-btn') {
                 const today = new Date();
                 today.setHours(0, 0, 0, 0);

                 const todaysOrders = state.allOrders
                     .filter(order => order.createdAt && order.createdAt.toDate() >= today)
                     .sort((a, b) => a.createdAt.toDate() - b.createdAt.toDate());

                 if (todaysOrders.length === 0) {
                     showToast("Nessun ordine da copiare per oggi.");
                     return;
                 }

                 const prepItems = {};
                 todaysOrders.forEach(order => {
                     order.items.forEach(item => {
                         let itemName = item.name;
                         if (item.details) {
                             itemName += ` (${item.details})`;
                         }

                         if (!prepItems[itemName]) {
                             prepItems[itemName] = { quantity: 0, users: [] };
                         }
                         prepItems[itemName].quantity += item.quantity;

                         let userNote = `${order.user}`;
                         if (item.quantity > 1) {
                             userNote += ` (x${item.quantity})`;
                         }
                         
                         let combinedNotes = [];
                         if(order.allergies) combinedNotes.push(`ALLERGIA: ${order.allergies}`);
                         if(combinedNotes.length > 0) userNote += ` [${combinedNotes.join('; ')}]`;

                         prepItems[itemName].users.push(userNote);
                     });
                 });

                 let prepText = "--- üìù LISTA PREPARAZIONE ---\n\n";
                 Object.keys(prepItems).sort().forEach(itemName => {
                     const itemDetails = prepItems[itemName];
                     prepText += `*${itemDetails.quantity}x ${itemName}*\n`;
                     prepText += `  - Per: ${itemDetails.users.join(', ')}\n\n`;
                 });

                 let ordersText = "--- üíµ RIEPILOGO ORDINI E PAGAMENTI ---\n\n";
                 let grandTotal = 0;
                 todaysOrders.forEach(order => { 
                     ordersText += `*${order.user}* - Totale: ‚Ç¨${order.total.toFixed(2)}\n`;
                     ordersText += `  - Pagamento: ${PAYMENT_METHODS[order.paymentMethod]?.name || order.paymentMethod}\n`;
                     order.items.forEach(item => {
                         let itemText = item.name;
                         if (item.details) {
                             itemText += ` (${item.details})`;
                         }
                         ordersText += `  - ${item.quantity}x ${itemText}\n`;
                     });
                     
                     if (order.allergies) {
                         ordersText += `  - ‚ùó ALLERGIA: ${order.allergies}\n`;
                     }

                      if (order.cutlery) {
                         ordersText += `  - üç¥ Posate: S√¨\n`;
                     }
                     ordersText += `\n`;
                     grandTotal += order.total;
                 });

                 ordersText += `-------------------------------------\n`;
                 ordersText += `TOTALE COMPLESSIVO: ‚Ç¨${grandTotal.toFixed(2)}`;

                 const finalSummary = prepText + "\n\n" + ordersText;

                 navigator.clipboard.writeText(finalSummary)
                     .then(() => {
                         showToast("Riepilogo ottimizzato copiato negli appunti!");
                     })
                     .catch(err => {
                         console.error('Errore durante la copia:', err);
                         showToast("Errore: impossibile copiare il riepilogo.");
                     });
             }
             else if (button.id === 'export-history-btn') {
                 showToast("Esportazione in corso...");

                 try {
                     const allOrdersQuery = query(ordersCollectionRef, orderBy("createdAt", "desc"));
                     const querySnapshot = await getDocs(allOrdersQuery);
                     const allOrdersHistory = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                     if (allOrdersHistory.length === 0) {
                         showToast("Nessun ordine nello storico da esportare.");
                         return;
                     }

                     const escapeCsvField = (field) => {
                         if (field === null || field === undefined) return '""';
                         let stringField = String(field);
                         if (stringField.search(/("|,|;|\n)/g) >= 0) {
                             stringField = `"${stringField.replace(/"/g, '""')}"`;
                         }
                         return stringField.includes(';') ? `"${stringField}"` : stringField;
                     };

                     const header = [
                         'OrderID', 'TimestampISO8601', 'DataLeggibile', 'UserID', 'Utente',
                         'EmailUtente', 'Prodotto', 'Dettagli', 'CategoriaProdotto', 'Quantita',
                         'PrezzoUnitario', 'TotaleRiga', 'MetodoPagamento',
                         'Allergie', 'Posate', 'CanaleOrdine', 'StatoPagamento', 'RispostaRistoratore'
                     ];

                     let csvRows = [header.join(';')];

                     allOrdersHistory.forEach(order => {
                         order.items.forEach(item => {
                             let category = item.category;
                             if (!category) {
                                 const menuItem = state.menuData.find(m => m.name === item.name);
                                 category = menuItem ? menuItem.category : 'Sconosciuta';
                             }

                             const row = [
                                 escapeCsvField(order.id),
                                 escapeCsvField(order.createdAt ? order.createdAt.toDate().toISOString() : 'N/D'),
                                 escapeCsvField(order.createdAt ? order.createdAt.toDate().toLocaleString('it-IT') : 'N/D'),
                                 escapeCsvField(order.uid || 'N/D'),
                                 escapeCsvField(order.user),
                                 escapeCsvField(order.email || ''),
                                 escapeCsvField(item.name),
                                 escapeCsvField(item.details || ''),
                                 escapeCsvField(category),
                                 escapeCsvField(item.quantity),
                                 escapeCsvField(item.price ? item.price.toFixed(2).replace('.', ',') : '0,00'),
                                 escapeCsvField(item.price ? (item.quantity * item.price).toFixed(2).replace('.', ',') : '0,00'),
                                 escapeCsvField(order.paymentMethod),
                                 escapeCsvField(order.allergies || ''),
                                 escapeCsvField(order.cutlery ? 'Si' : 'No'),
                                 escapeCsvField('Web'), 
                                 escapeCsvField(order.paid ? 'Pagato' : 'Da Pagare'),
                                 escapeCsvField(order.restaurateurResponse || '')
                             ];
                             csvRows.push(row.join(';'));
                         });
                     });

                     const csvContent = csvRows.join('\n');
                     const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' }); // Added BOM for Excel
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.setAttribute('href', url);
                     a.setAttribute('download', 'storico_ordini_dosepranza.csv');
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                     URL.revokeObjectURL(url);

                 } catch (error) {
                     console.error("Errore durante l'esportazione: ", error);
                     showToast("Esportazione fallita. Controlla la console.");
                 }
             }
        }

        function updateAdminControlsVisibility() {
            const exportBtn = document.getElementById('export-history-btn');
            if (!exportBtn) return;

            if (state.currentUser && state.currentUser.name) {
                if (state.currentUser.name === 'Marco Tranquilli') {
                    exportBtn.classList.remove('hidden');
                } else {
                    exportBtn.classList.add('hidden');
                }
            } else {
                exportBtn.classList.add('hidden');
            }
        }

        function init() {
            state.menuData = processMenuData(RAW_MENU, PRICES);
            Object.assign(dom, {
                views: document.querySelectorAll('.view'),
                navBtns: document.querySelectorAll('.nav-btn'),
                navEl: document.querySelector('nav'),
                menuItemsContainer: document.getElementById('menu-items'), cartCountEl: document.getElementById('cart-count'),
                myOrderContentEl: document.getElementById('my-order-content'), allOrdersListEl: document.getElementById('all-orders-list'),
                grandTotalEl: document.getElementById('grand-total'), userModal: document.getElementById('user-modal'),
                usernameInput: document.getElementById('username-input'),
                userEmailInput: document.getElementById('user-email-input'),
                toastEl: document.getElementById('toast'),
                toastMessageEl: document.getElementById('toast-message'), categorySelect: document.getElementById('category-select'),
                dietSelect: document.getElementById('diet-select'), filterCounterContainer: document.getElementById('filter-counter-container'),
                allergenModal: document.getElementById('allergen-modal'), allergenModalContent: document.getElementById('allergen-modal-content'),
                comboModal: document.getElementById('combo-modal'),
                comboPaninoSelect: document.getElementById('combo-panino-select'),
                comboDrinkSelect: document.getElementById('combo-drink-select'),
                comboDrinkLabel: document.getElementById('combo-drink-label'),
                ingredientsList: document.getElementById('ingredients-list'),
                selectedIngredientsList: document.getElementById('selected-ingredients-list'),
                sandwichTotalPrice: document.getElementById('sandwich-total-price'),
                addSandwichBtn: document.getElementById('add-sandwich-to-cart-btn'),
                baseChoiceContainer: document.getElementById('base-choice-container'),
                subtypeChoiceContainer: document.getElementById('subtype-choice-container'),
                ingredientsStepContainer: document.getElementById('ingredients-step-container'),
                subtypeOptions: document.getElementById('subtype-options'),
                sandwichBaseSummary: document.getElementById('sandwich-base-summary'),
                extraChargeNotice: document.getElementById('extra-charge-notice'),
                satispayModal: document.getElementById('satispay-modal'),
            });
            document.body.addEventListener('click', handleEvents);
            document.body.addEventListener('change', handleEvents);
            document.body.addEventListener('input', handleEvents);
            renderFilters();

            dom.views.forEach(v => {
                if (v.id === 'menu-view') {
                    v.classList.add('active'); 
                } else {
                    v.classList.remove('active'); 
                }
            });
            dom.navBtns.forEach(b => {
                b.classList.toggle('bg-primary', b.dataset.view === 'menu');
                b.classList.toggle('text-white', b.dataset.view === 'menu');
            });
            state.currentView = 'menu'; 

            renderMenu(); 
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.currentUser = { 
                    uid: user.uid, 
                    name: localStorage.getItem('dosepranza-username'),
                    email: localStorage.getItem('dosepranza-useremail')
                };
                if (!state.currentUser.name || !state.currentUser.email) {
                    // Pre-popola l'email se √® nel localStorage
                    dom.userEmailInput.value = state.currentUser.email || '';
                    dom.usernameInput.value = state.currentUser.name || '';
                    dom.userModal.classList.remove('hidden');
                }
                updateAdminControlsVisibility();

                onSnapshot(query(ordersCollectionRef, orderBy("createdAt", "desc")), snapshot => { 
                    state.allOrders = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
                    if (state.currentView === 'all-orders') renderAllOrders();
                    if (state.currentView === 'my-order') renderMyOrder();
                }, error => {
                    console.error("Errore con lo snapshot di Firestore:", error);
                });
            } else {
                signInAnonymously(auth).catch(error => {
                    console.error("Errore login anonimo:", error);
                });
            }
        });

        init();
    </script>
</body>
</html>
