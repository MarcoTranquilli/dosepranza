<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dosemagna - Ordini Alimentari</title>
    <link rel="icon" href="https://i.postimg.cc/L6H20zfp/logo-dosepranza-People-About-Food.png">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        primary: { light: '#e8b39a', DEFAULT: '#D6804F', dark: '#c0673a', '100': '#fef4ef', '800': '#8c502f' },
                        secondary: { DEFAULT: '#709460', dark: '#5a794d' },
                        background: '#F3F1E7', 'text-main': '#3B3F2F',
                    }
                }
            }
        }
    </script>
    <style>
        .view { display: none; }
        .view.active { display: block; }
        .product-title { min-height: 2.8rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .ingredient-card.selected { border-color: #D6804F; background-color: #fef4ef; border-width: 3px; }
        .nav-btn.active { background-color: #D6804F; color: white; }
    </style>
</head>
<body class="bg-background text-text-main pb-20 font-sans">

    <div id="app" class="max-w-4xl mx-auto p-4">
        <header class="mb-6 flex flex-col items-center">
            <img src="https://i.postimg.cc/L6H20zfp/logo-dosepranza-People-About-Food.png" class="w-64 md:w-80">
            <div class="bg-white/50 border-l-4 border-primary p-3 rounded-r-xl mt-4 w-full text-xs font-bold shadow-sm">
                Ordine entro le 11:30 | Consegna gratuita ore 12:30.
            </div>
        </header>

        <nav class="grid grid-cols-4 gap-1 bg-white p-2 rounded-2xl shadow-lg sticky top-2 z-50 mb-6 border border-gray-100">
            <button onclick="window.navigate('menu')" id="btn-menu" class="nav-btn py-3 rounded-xl font-bold text-[10px] uppercase transition-all active"><i class="fas fa-utensils block text-sm mb-1"></i>Men√π</button>
            <button onclick="window.navigate('custom')" id="btn-custom" class="nav-btn py-3 rounded-xl font-bold text-[10px] uppercase transition-all"><i class="fas fa-plus-circle block text-sm mb-1"></i>Crea</button>
            <button onclick="window.navigate('cart')" id="btn-cart" class="nav-btn py-3 rounded-xl font-bold text-[10px] uppercase transition-all relative">
                <i class="fas fa-shopping-basket block text-sm mb-1"></i>Ordine
                <span id="cart-count" class="absolute top-1 right-1 bg-red-500 text-white text-[9px] h-4 w-4 rounded-full flex items-center justify-center border border-white">0</span>
            </button>
            <button onclick="window.navigate('history')" id="btn-history" class="nav-btn py-3 rounded-xl font-bold text-[10px] uppercase transition-all"><i class="fas fa-users block text-sm mb-1"></i>Tutti</button>
        </nav>

        <main>
            <section id="menu-view" class="view active">
                <div class="space-y-4 mb-6">
                    <input type="search" id="search-input" placeholder="Cerca un piatto..." class="w-full p-4 border border-gray-200 rounded-2xl outline-none focus:ring-2 focus:ring-primary shadow-sm">
                    <div class="grid grid-cols-2 gap-2">
                        <select id="category-select" class="p-3 bg-white border border-gray-200 rounded-xl text-xs font-bold outline-none cursor-pointer"></select>
                        <select id="diet-select" class="p-3 bg-white border border-gray-200 rounded-xl text-xs font-bold outline-none cursor-pointer"></select>
                    </div>
                </div>
                <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-10"></div>
            </section>

            <section id="custom-view" class="view">
                <h2 class="text-2xl font-black mb-6">Crea il Tuo Prodotto</h2>
                <div class="bg-white p-6 rounded-3xl shadow-sm mb-4 border border-gray-100 text-center">
                    <h3 class="text-xs font-black text-gray-400 uppercase mb-4 tracking-widest">1. Scegli la base</h3>
                    <div class="flex gap-4">
                        <button onclick="window.selectBase('Panino')" class="flex-1 p-6 bg-gray-50 rounded-2xl border-2 border-transparent hover:border-primary transition-all flex flex-col items-center">
                            <i class="fas fa-bread-slice text-3xl text-primary mb-2"></i><span class="font-bold text-sm">Panino</span>
                        </button>
                        <button onclick="window.selectBase('Pizza Ripiena')" class="flex-1 p-6 bg-gray-50 rounded-2xl border-2 border-transparent hover:border-primary transition-all flex flex-col items-center">
                            <i class="fas fa-pizza-slice text-3xl text-primary mb-2"></i><span class="font-bold text-sm">Pizza</span>
                        </button>
                    </div>
                </div>
                <div id="custom-subtype-container" class="bg-white p-5 rounded-3xl shadow-sm mb-4 border border-gray-100 hidden text-center">
                    <h3 class="text-xs font-black text-gray-400 uppercase mb-4 font-bold">2. Variante</h3>
                    <div id="subtype-list" class="grid grid-cols-2 gap-2"></div>
                </div>
                <div id="custom-ingredients-container" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="ingredients-grid" class="md:col-span-2 grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                        <div class="md:col-span-1">
                            <div class="bg-white p-6 rounded-3xl shadow-xl sticky top-24 border border-gray-50 text-center">
                                <h4 class="font-bold text-xs mb-4 uppercase text-primary border-b pb-2">Riepilogo</h4>
                                <ul id="custom-summary-list" class="text-[10px] space-y-1 mb-4 text-left"></ul>
                                <div class="flex justify-between items-center mb-6 pt-2 border-t font-bold">
                                    <span class="text-xs">Prezzo:</span>
                                    <span id="custom-price-display" class="text-xl font-black text-primary">‚Ç¨3.50</span>
                                </div>
                                <button onclick="window.addCustomToCart()" class="w-full bg-secondary text-white font-black py-4 rounded-2xl shadow-lg">AGGIUNGI</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="cart-view" class="view">
                <h2 class="text-2xl font-black mb-6">Il Mio Ordine</h2>
                <div id="cart-content-wrapper" class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 mb-4">
                    <div id="cart-items-list"></div>
                    <div id="cart-options" class="mt-8 space-y-6 hidden">
                        <div class="p-4 rounded-2xl bg-orange-50 border border-orange-200">
                            <div class="flex items-center gap-4">
                                <div class="flex-grow">
                                    <p class="font-black text-xs text-primary-800 uppercase mb-1">Nuovo su Satispay?</p>
                                    <p class="text-[10px] text-primary-800 leading-tight">Scarica l'app con codice <strong>WEB</strong> e ricevi <strong>5‚Ç¨ di Bonus</strong>!</p>
                                </div>
                                <img src="https://www.datocms-assets.com/133951/1745419747-qr-code-scarica-app.svg" class="w-12 h-12 bg-white p-1 rounded-lg shadow-sm">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-black text-red-700 uppercase mb-2">Note o Allergie:</label>
                            <textarea id="allergies-input" class="w-full p-4 border border-red-100 rounded-2xl bg-red-50/30 outline-none text-sm"></textarea>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-4 rounded-2xl">
                            <span class="text-xs font-bold uppercase tracking-widest text-gray-500">Ti servono le posate?</span>
                            <button onclick="window.togglePosate()" id="posate-btn" class="px-6 py-2 rounded-full font-black text-[10px] bg-gray-200 uppercase transition-all">No</button>
                        </div>
                        <div class="flex justify-between items-end border-t pt-6">
                            <span class="text-gray-400 font-bold text-xs uppercase">Totale Ordine</span>
                            <span id="cart-total-display" class="text-4xl font-black text-primary">‚Ç¨0.00</span>
                        </div>
                        <button onclick="window.sendOrder()" class="w-full bg-primary text-white font-black py-5 rounded-[2rem] shadow-xl text-lg uppercase tracking-widest">Invia Ordine</button>
                    </div>
                </div>
            </section>

            <section id="history-view" class="view">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black">Ordini di Oggi</h2>
                    <div class="flex gap-2">
                        <button id="admin-export-btn" onclick="window.exportFullHistory()" class="hidden bg-gray-900 text-white text-[10px] font-bold px-4 py-2 rounded-xl uppercase shadow-md"><i class="fas fa-file-csv mr-1"></i> Storico (Admin)</button>
                        <button onclick="window.copyDailySummary()" class="bg-primary text-white text-[10px] font-bold px-4 py-2 rounded-xl uppercase shadow-md"><i class="fas fa-copy mr-1"></i> Ristoratore</button>
                    </div>
                 </div>

                 <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 mb-6 flex items-center gap-4">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://web.satispay.com/app/open/shops/986e3af6-8a54-4c3d-9c23-b741ca0f8cc0" class="w-20 h-20 rounded-xl shadow-sm">
                    <div>
                        <p class="font-black text-xs uppercase text-gray-400 mb-1">Paga Alimentari Russo</p>
                        <p class="text-[10px] leading-tight text-gray-500 mb-2">Inquadra per pagare con Satispay.</p>
                        <a href="https://web.satispay.com/app/open/shops/986e3af6-8a54-4c3d-9c23-b741ca0f8cc0" target="_blank" class="inline-block bg-[#E52230] text-white font-bold text-[9px] px-3 py-1.5 rounded-lg uppercase">Paga Ora</a>
                    </div>
                 </div>

                 <div id="all-orders-list" class="space-y-3 pb-24"></div>
                 <div class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[90%] max-w-lg bg-white p-5 rounded-3xl shadow-2xl border-t-4 border-primary flex justify-between items-center z-[60]">
                     <span class="text-gray-400 font-black text-[10px] uppercase">Incasso Oggi</span>
                     <span id="grand-total-display" class="text-2xl font-black text-primary">‚Ç¨0.00</span>
                 </div>
            </section>
        </main>
    </div>

    <div id="user-modal" class="fixed inset-0 bg-gray-900/90 backdrop-blur-md flex items-center justify-center z-[100] hidden p-4">
        <div class="bg-white p-8 rounded-[3rem] shadow-2xl w-full max-w-sm text-center">
            <h3 class="text-2xl font-bold mb-6">Dati per l'ordine</h3>
            <input type="text" id="user-name-input" placeholder="Nome e Cognome" class="w-full p-5 border-2 border-gray-100 rounded-3xl mb-3 outline-none focus:border-primary text-center font-bold text-lg shadow-inner">
            <input type="email" id="user-email-input" placeholder="Indirizzo Email" class="w-full p-5 border-2 border-gray-100 rounded-3xl mb-8 outline-none focus:border-primary text-center font-bold text-sm shadow-inner">
            <button id="save-user-btn" onclick="window.saveUserData()" class="w-full bg-primary text-white font-black py-5 rounded-3xl shadow-lg uppercase tracking-widest transition-all active:scale-95">ACCEDI</button>
        </div>
    </div>

    <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 bg-gray-900 text-white py-4 px-8 rounded-full shadow-2xl z-[200] opacity-0 transition-all duration-300 pointer-events-none scale-90 text-[10px] font-black uppercase text-center tracking-widest">
        <p id="toast-message"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeFirestore, persistentLocalCache, collection, onSnapshot, addDoc, serverTimestamp, query, orderBy, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DEFINIZIONI DATI ---
        const DIETS_CONFIG = { "carne/pesce": "ü•© Carne/Pesce", "vegetariano": "üßÄ Vegetariano", "vegano": "üå± Vegano" };
        const INGREDIENTS_DATA = [{id:'br',name:'Bresaola'},{id:'bi',name:'Brie'},{id:'bl',name:'Broccoletti'},{id:'cp',name:'Capocollo'},{id:'cr',name:'Carciofini'},{id:'ci',name:'Cicoria'},{id:'fr',name:'Frittata'},{id:'in',name:'Insalata'},{id:'lt',name:'Lattuga'},{id:'mg',name:'Melanzane Grigliate'},{id:'mo',name:'Mortadella'},{id:'mz',name:'Mozzarella'},{id:'ol',name:'Olive'},{id:'pa',name:'Parmigiano'},{id:'pe',name:'Pecorino'},{id:'pg',name:'Peperoni Grigliati'},{id:'ps',name:'Pomodori Secchi'},{id:'po',name:'Pomodoro'},{id:'pc',name:'Porchetta'},{id:'pr',name:'Primo Sale'},{id:'co',name:'Prosciutto Cotto'},{id:'cu',name:'Prosciutto Crudo'},{id:'ru',name:'Rucola'},{id:'sa',name:'Salame'},{id:'sc',name:'Scamorza'},{id:'sk',name:'Scarola'},{id:'sp',name:'Speck'},{id:'st',name:'Stracchino'},{id:'sz',name:'Stracciatella'},{id:'ta',name:'Tacchino Arrosto'},{id:'zg',name:'Zucchine Grigliate'}].sort((a,b)=>a.name.localeCompare(b.name));

        const RAW_MENU = {
            "Men√π Combinati": [
                { name: "Panino + acqua 50 cl", price: 4.0, diet: ["carne/pesce", "vegetariano", "vegano"] },
                { name: "Panino + lattina 33 cl", price: 4.5, diet: ["carne/pesce", "vegetariano", "vegano"] },
                { name: "Panino + bevanda 50 cl", price: 5.0, diet: ["carne/pesce", "vegetariano", "vegano"] }
            ],
            "Gastronomia": [
                { name: "Melanzane alla parmigiana", price: 6.0, desc: "Grigliate (250-300g)", diet: ["vegetariano"] },
                { name: "Lasagna classica al rag√π", price: 6.0, desc: "Sfoglia all'uovo (250-300g)", diet: ["carne/pesce"] },
                { name: "Lasagna bianca ai carciofi", price: 6.0, desc: "Besciamella e carciofi (250-300g)", diet: ["vegetariano"] },
                { name: "Lasagna bianca funghi piselli e salsiccia", price: 6.0, desc: "Besciamella (250-300g)", diet: ["carne/pesce"] },
                { name: "Cous cous vegetale con pollo", price: 4.0, diet: ["carne/pesce"] },
                { name: "Cous cous vegetale", price: 4.0, diet: ["vegano"] },
                { name: "Riso Venere con gamberi e zucchine", price: 4.0, diet: ["carne/pesce"] },
                { name: "Insalata di riso", price: 4.0, diet: ["carne/pesce"] },
                { name: "Pasta fredda tonno pomodori olive", price: 4.0, diet: ["carne/pesce"] },
                { name: "Pasta fredda pesto primo sale pomodori olive", price: 4.0, diet: ["vegetariano"] },
                { name: "Insalata di pollo", price: 4.0, diet: ["carne/pesce"] },
                { name: "Riso integrale bresaola limone rughetta", price: 4.0, diet: ["carne/pesce"] },
                { name: "Pomodori con il riso (2 pz)", price: 6.0, desc: "Con patate al forno", diet: ["vegano"] },
                { name: "Ovoline di bufala 150g", price: 1.0, desc: "1‚Ç¨ l'una", diet: ["vegetariano"] }
            ],
            "Insalatone": [
                { name: "Insalatona con Uovo Sodo", price: 5.0, diet: ["vegetariano"] },
                { name: "Insalatona con Primo Sale", price: 5.0, diet: ["vegetariano"] },
                { name: "Insalatona con Tonno", price: 5.0, diet: ["carne/pesce"] }
            ],
            "Verdure": [
                { name: "Melanzane grigliate", price: 2.0, hasPortions:true, portions:[{t:"100g-2‚Ç¨",v:2.0},{t:"150g-3‚Ç¨",v:3.0},{t:"200g-4‚Ç¨",v:4.0}], diet:["vegano"] },
                { name: "Zucchine grigliate", price: 2.0, hasPortions:true, portions:[{t:"100g-2‚Ç¨",v:2.0},{t:"150g-3‚Ç¨",v:3.0},{t:"200g-4‚Ç¨",v:4.0}], diet:["vegano"] },
                { name: "Peperoni arrostiti", price: 2.0, hasPortions:true, portions:[{t:"100g-2‚Ç¨",v:2.0},{t:"150g-3‚Ç¨",v:3.0},{t:"200g-4‚Ç¨",v:4.0}], diet:["vegano"] },
                { name: "Cicoria ripassata", price: 2.0, hasPortions:true, portions:[{t:"100g-2‚Ç¨",v:2.0},{t:"150g-3‚Ç¨",v:3.0},{t:"200g-4‚Ç¨",v:4.0}], diet:["vegano"] },
                { name: "Broccoletti ripassati", price: 2.0, hasPortions:true, portions:[{t:"100g-2‚Ç¨",v:2.0},{t:"150g-3‚Ç¨",v:3.0},{t:"200g-4‚Ç¨",v:4.0}], diet:["vegano"] },
                { name: "Broccoli al vapore", price: 2.0, hasPortions:true, portions:[{t:"100g-2‚Ç¨",v:2.0},{t:"150g-3‚Ç¨",v:3.0},{t:"200g-4‚Ç¨",v:4.0}], diet:["vegano"] },
                { name: "Scarola con olive", price: 2.0, hasPortions:true, portions:[{t:"100g-2‚Ç¨",v:2.0},{t:"150g-3‚Ç¨",v:3.0},{t:"200g-4‚Ç¨",v:4.0}], diet:["vegano"] }
            ],
            "Fritti": [
                { name: "Pizzetta rossa", price: 1.5, hasPortions:true, portions:[{t:"2pz-1.50‚Ç¨",v:1.5},{t:"3pz-2.00‚Ç¨",v:2.0},{t:"6pz-4.00‚Ç¨",v:4.0}], diet:["vegetariano"] },
                { name: "Lingua romana scrocchiarella", price: 1.5, desc: "Pomodoro, Olio EVO", diet:["vegano"] },
                { name: "Suppl√¨", price: 1.5, desc: "Riso, Pomodoro, Mozzarella", diet:["vegetariano"] },
                { name: "Polpetta di melanzane", price: 1.5, desc: "Melanzane, Parmigiano, Uova", diet:["vegetariano"] }
            ],
            "Panini": [
                { name: "Crudo pomodoro mozzarella", price: 3.5, diet:["carne/pesce"] },
                { name: "Crudo stracchino rughetta", price: 3.5, diet:["carne/pesce"] },
                { name: "Cotto scamorza e verdura", price: 3.5, diet:["carne/pesce"] },
                { name: "Capocollo pecorino pom. secchi", price: 3.5, diet:["carne/pesce"] },
                { name: "Porchetta", price: 3.5, diet:["carne/pesce"] },
                { name: "Vegetariano melanzane zucchine", price: 3.5, diet:["vegano"] },
                { name: "Bresaola parmigiano rughetta", price: 3.5, diet:["carne/pesce"] },
                { name: "Salmone formaggio spalmabile", price: 3.5, diet:["carne/pesce"] },
                { name: "Cotoletta pollo lattuga pomodoro", price: 3.5, diet:["carne/pesce"] },
                { name: "Brasato di manzo e verdura", price: 3.5, diet:["carne/pesce"] }
            ],
            "Pizze": [
                { name: "Pizza insalata pollo maionese", price: 3.5, diet:["carne/pesce"] },
                { name: "Pizza bresaola filadelfia rughetta", price: 3.5, diet:["carne/pesce"] },
                { name: "Pizza tacchino e verdure", price: 3.5, diet:["carne/pesce"] },
                { name: "Pizza rustica: Scarola e olive", price: 8.0, hasPortions:true, portions:[{t:"Intera-8‚Ç¨",v:8},{t:"Mezza-4‚Ç¨",v:4},{t:"1/4-2‚Ç¨",v:2}], diet:["vegano"] },
                { name: "Pizza rustica: Cicoria e pachino", price: 8.0, hasPortions:true, portions:[{t:"Intera-8‚Ç¨",v:8},{t:"Mezza-4‚Ç¨",v:4},{t:"1/4-2‚Ç¨",v:2}], diet:["vegano"] },
                { name: "Pizza rustica: Broccoli salsiccia", price: 8.0, hasPortions:true, portions:[{t:"Intera-8‚Ç¨",v:8},{t:"Mezza-4‚Ç¨",v:4},{t:"1/4-2‚Ç¨",v:2}], diet:["carne/pesce"] }
            ],
            "Dessert": [
                { name: "Macedonia di stagione", price: 3.0, diet:["vegano"] },
                { name: "Crostatina marmellata", price: 1.5, diet:["vegetariano"] },
                { name: "Lingue di gatto (1pz)", price: 1.0, diet:["vegetariano"] },
                { name: "Ferretti glassati (1pz)", price: 2.0, diet:["vegetariano"] }
            ],
            "Prodotti da Forno": [
                { name: "Pane di Lariano", price: 0.75, hasPortions:true, portions:[{t:"250g-0.75‚Ç¨",v:0.75},{t:"500g-1.50‚Ç¨",v:1.5}], diet:["vegano"] },
                { name: "Ciabatta", price: 1.00, hasPortions:true, portions:[{t:"250g-1.00‚Ç¨",v:1.0},{t:"1kg-4.00‚Ç¨",v:4.0}], diet:["vegano"] },
                { name: "Pizza Bianca", price: 1.80, hasPortions:true, portions:[{t:"200g-1.80‚Ç¨",v:1.80},{t:"1kg-9.00‚Ç¨",v:9.0}], diet:["vegano"] },
                { name: "Pizzette (mini sfizio)", price: 1.50, desc: "Mini pizze morbide", diet:["vegetariano"] }
            ]
        };

        const state = {
            user: JSON.parse(localStorage.getItem('dose_user')) || null,
            cart: [], currentView: 'menu', search: '', cat: 'all', diet: 'all', posate: false,
            custom: { base: null, subtype: null, ings: [], total: 3.5 },
            ordersToday: [], menuData: []
        };

        // --- FIREBASE SETUP ---
        const firebaseConfig = { apiKey: "AIzaSyCQJsNbgaR89gF_1vLe6H4DPboOhQvm9nI", authDomain: "app-ordini-pranzo-alimentari.firebaseapp.com", projectId: "app-ordini-pranzo-alimentari", storageBucket: "app-ordini-pranzo-alimentari.appspot.com", messagingSenderId: "553169964686", appId: "1:553169964686:web:7f8ca6f32a301949e4c3df" };
        const app_fb = initializeApp(firebaseConfig);
        const auth_fb = getAuth(app_fb);
        const db_fb = initializeFirestore(app_fb, { experimentalForceLongPolling: true, localCache: persistentLocalCache() });
        const ordersCol = collection(db_fb, "orders");

        // --- GLOBAL FUNCTIONS ATTACHED TO WINDOW ---
        window.toast = (m) => {
            const el = document.getElementById('toast');
            document.getElementById('toast-message').textContent = m;
            el.style.opacity = '1';
            el.style.transform = 'translateX(-50%) scale(1)';
            setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateX(-50%) scale(0.9)'; }, 2000);
        };

        window.navigate = (v) => {
            state.currentView = v;
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.getElementById(`${v}-view`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.id === `btn-${v}`));
            if(v === 'cart') renderCart();
            if(v === 'history') syncOrders();
        };

        window.addStdToCart = (id) => {
            const item = state.menuData.find(i => i.id === id);
            const select = document.querySelector(`select[data-pid="${id}"]`);
            const price = select ? parseFloat(select.value) : item.price;
            const det = select ? `Porz: ${select.options[select.selectedIndex].text.split('-')[0]}` : "";
            state.cart.push({ ...item, price, details: det, cartId: Date.now() });
            document.getElementById('cart-count').textContent = state.cart.length;
            window.toast("Aggiunto!");
        };

        window.selectBase = (b) => {
            state.custom.base = b; state.custom.ings = [];
            const subs = b === 'Panino' ? ['Pane arabo','Ciabattina','5 cereali','Integrale'] : ['Pizza classica'];
            document.getElementById('subtype-list').innerHTML = subs.map(s => `<button onclick="window.setSubtype('${s}')" class="p-4 bg-gray-50 rounded-2xl border-2 border-transparent font-bold text-[10px] uppercase hover:border-primary transition-all">${s}</button>`).join('');
            document.getElementById('custom-subtype-container').classList.remove('hidden');
        };

        window.setSubtype = (s) => {
            state.custom.subtype = s;
            document.getElementById('custom-ingredients-container').classList.remove('hidden');
            renderCustomIngs(); updateCustomSummary();
        };

        window.addIng = (id) => {
            state.custom.ings.push(INGREDIENTS_DATA.find(i => i.id === id));
            renderCustomIngs(); updateCustomSummary();
        };

        window.removeIng = (idx) => {
            state.custom.ings.splice(idx, 1);
            renderCustomIngs(); updateCustomSummary();
        };

        window.addCustomToCart = () => {
            const c = state.custom;
            if(!c.subtype || c.ings.length === 0) return window.toast("Scegli gli ingredienti!");
            state.cart.push({ name: `${c.base} (${c.subtype})`, price: c.total, cat: 'Crea', details: c.ings.map(i=>i.name).join(', '), cartId: Date.now() });
            document.getElementById('cart-count').textContent = state.cart.length;
            state.custom = { base:null, subtype:null, ings:[], total:3.5 };
            document.getElementById('custom-subtype-container').classList.add('hidden');
            document.getElementById('custom-ingredients-container').classList.add('hidden');
            window.navigate('menu');
            window.toast("Aggiunto!");
        };

        window.removeFromCart = (id) => {
            state.cart = state.cart.filter(i => i.cartId !== id);
            document.getElementById('cart-count').textContent = state.cart.length;
            renderCart();
        };

        window.togglePosate = () => {
            state.posate = !state.posate;
            const b = document.getElementById('posate-btn');
            b.textContent = state.posate ? 'Si' : 'No';
            b.classList.toggle('bg-primary', state.posate);
            b.classList.toggle('text-white', state.posate);
        };

        window.saveUserData = () => {
            const name = document.getElementById('user-name-input').value.trim();
            const email = document.getElementById('user-email-input').value.trim();
            if(name && email) {
                state.user = { name, email };
                localStorage.setItem('dose_user', JSON.stringify(state.user));
                document.getElementById('user-modal').classList.add('hidden');
                checkAdmin(name);
            }
        };

        window.sendOrder = async () => {
            if(!state.user) return document.getElementById('user-modal').classList.remove('hidden');
            try {
                const total = state.cart.reduce((s,i)=>s+i.price, 0);
                await addDoc(ordersCol, { 
                    user: state.user.name, email: state.user.email,
                    items: state.cart, total, 
                    allergies: document.getElementById('allergies-input').value,
                    posate: state.posate ? 'Si' : 'No',
                    createdAt: serverTimestamp() 
                });
                state.cart = []; document.getElementById('cart-count').textContent='0'; window.navigate('history'); window.toast("Ordine Inviato!");
            } catch(e) { alert("Connessione fallita. Carica l'app online."); }
        };

        window.copyDailySummary = () => {
            const sum = {};
            state.ordersToday.forEach(o => o.items.forEach(i => {
                const k = i.name + (i.details ? ` (${i.details})` : "");
                sum[k] = (sum[k] || 0) + 1;
            }));
            const text = "ORDINI OGGI:\n" + Object.entries(sum).map(([k,v]) => `- ${v}x ${k}`).join('\n');
            navigator.clipboard.writeText(text).then(() => window.toast("Copiato!"));
        };

        window.exportFullHistory = async () => {
            const snap = await getDocs(query(ordersCol, orderBy("createdAt", "desc")));
            let csv = "OrderID;TimestampISO8601;DataLeggibile;UserID;Utente;EmailUtente;Prodotto;Dettagli;CategoriaProdotto;Quantita;PrezzoUnitario;TotaleRiga;MetodoPagamento;Allergie;Posate;CanaleOrdine;StatoPagamento\n";
            snap.forEach(d => {
                const o = d.data();
                const ts = o.createdAt?.toDate();
                o.items.forEach(i => {
                    csv += `${d.id};${ts?.toISOString()};${ts?.toLocaleString()};Auth;${o.user};${o.email};${i.name};${i.details || ""};${i.cat || ""};1;${i.price};${o.total};Satispay;${o.allergies || "No"};${o.posate || "No"};Web;Da Pagare\n`;
                });
            });
            const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "Storico_Ordini.csv"; link.click();
        };

        // --- INTERNAL ---
        function renderMenu() {
            const filtered = state.menuData.filter(i => {
                const s = i.name.toLowerCase().includes(state.search.toLowerCase());
                const c = state.cat === 'all' || i.cat === state.cat;
                const d = state.diet === 'all' || (i.diet && i.diet.includes(state.diet));
                return s && c && d;
            });
            let cur = "";
            document.getElementById('menu-container').innerHTML = filtered.map(i => {
                let html = "";
                if(i.cat !== cur) { cur = i.cat; html += `<div class="col-span-full mt-6 mb-2 font-black text-[10px] uppercase text-primary/60 border-b border-primary/10 tracking-widest">${cur}</div>`; }
                const pricing = i.hasPortions ? `<select data-pid="${i.id}" class="text-[9px] p-2 border rounded-xl w-full font-bold outline-none bg-gray-50">${i.portions.map(o=>`<option value="${o.v}">${o.t}</option>`).join('')}</select>` : `<span class="font-black text-primary text-lg">‚Ç¨${i.price.toFixed(2)}</span>`;
                html += `<div class="bg-white p-5 rounded-[2rem] shadow-sm flex flex-col justify-between border border-transparent hover:shadow-xl transition-all">
                    <div><h4 class="font-bold text-sm product-title mb-1 leading-tight text-gray-800">${i.name}</h4><p class="text-[9px] text-gray-300 italic">${i.cat}</p></div>
                    <div class="mt-4 flex justify-between items-center gap-2">${pricing}<button onclick="window.addStdToCart('${i.id}')" class="bg-primary text-white h-10 w-10 rounded-2xl shadow-lg flex items-center justify-center flex-shrink-0 active:scale-90 transition-all"><i class="fas fa-plus"></i></button></div>
                </div>`;
                return html;
            }).join('') || `<div class="col-span-full py-20 text-center text-gray-300">Nessun prodotto trovato.</div>`;
        }

        function renderCustomIngs() {
            document.getElementById('ingredients-grid').innerHTML = INGREDIENTS_DATA.map(ing => {
                const count = state.custom.ings.filter(i => i.id === ing.id).length;
                return `<div onclick="window.addIng('${ing.id}')" class="ingredient-card bg-white p-3 rounded-2xl border-2 border-transparent shadow-sm text-center cursor-pointer transition-all relative ${count > 0 ? 'selected' : ''}">
                    <p class="text-[9px] font-bold leading-tight">${ing.name}</p>
                    ${count > 0 ? `<span class="absolute -top-1 -right-1 bg-primary text-white text-[9px] h-4 w-4 rounded-full flex items-center justify-center font-black">${count}</span>` : ''}
                </div>`;
            }).join('');
        }

        function updateCustomSummary() {
            const s = state.custom;
            s.total = 3.5 + Math.max(0, s.ings.length - 3) * 1.0;
            document.getElementById('custom-price-display').textContent = `‚Ç¨${s.total.toFixed(2)}`;
            document.getElementById('custom-summary-list').innerHTML = s.ings.map((n, idx) => `<li class="flex justify-between items-center bg-gray-50 p-2 rounded-xl mb-1"><span>${n.name}</span><i class="fas fa-times text-red-300" onclick="window.removeIng(${idx})"></i></li>`).join('');
        }

        function renderCart() {
            const wrap = document.getElementById('cart-items-list');
            const opts = document.getElementById('cart-options');
            if(state.cart.length === 0) { wrap.innerHTML = `<p class="text-center py-10 text-gray-300 font-bold uppercase">Carrello vuoto</p>`; opts.classList.add('hidden'); return; }
            opts.classList.remove('hidden');
            const tot = state.cart.reduce((s,i) => s+i.price, 0);
            wrap.innerHTML = state.cart.map(i => `<div class="flex justify-between items-center py-4 border-b border-gray-50 last:border-0">
                <div class="min-w-0 pr-4"><p class="font-black text-sm text-gray-800">${i.name}</p><p class="text-[9px] text-gray-300 truncate">${i.details || ''}</p><p class="text-xs text-primary font-black">‚Ç¨${i.price.toFixed(2)}</p></div>
                <button onclick="window.removeFromCart(${i.cartId})" class="text-red-300 p-2"><i class="fas fa-trash-alt"></i></button>
            </div>`).join('');
            document.getElementById('cart-total-display').textContent = `‚Ç¨${tot.toFixed(2)}`;
        }

        function syncOrders() {
            const startOfDay = new Date(); startOfDay.setHours(0,0,0,0);
            onSnapshot(query(ordersCol, orderBy("createdAt", "desc")), snap => {
                let totalG = 0;
                state.ordersToday = snap.docs
                    .map(d => ({id: d.id, ...d.data()}))
                    .filter(o => o.createdAt && o.createdAt.toDate() >= startOfDay);
                
                document.getElementById('all-orders-list').innerHTML = state.ordersToday.map(o => {
                    totalG += o.total || 0;
                    return `<div class="bg-white p-5 rounded-3xl border-l-8 border-primary shadow-sm flex justify-between items-center">
                        <div class="min-w-0 pr-4"><p class="font-black text-sm text-gray-800">${o.user}</p><p class="text-[9px] text-gray-300 font-bold truncate">${o.items.map(i=>i.name).join(' ‚Ä¢ ')}</p></div>
                        <p class="font-black text-primary text-lg">‚Ç¨${(o.total || 0).toFixed(2)}</p>
                    </div>`;
                }).join('');
                document.getElementById('grand-total-display').textContent = `‚Ç¨${totalG.toFixed(2)}`;
            });
        }

        function checkAdmin(name) {
            if(name === "Marco Tranquilli") document.getElementById('admin-export-btn').classList.remove('hidden');
            else document.getElementById('admin-export-btn').classList.add('hidden');
        }

        // --- INIT APP ---
        const init = () => {
            state.menuData = Object.entries(RAW_MENU).flatMap(([cat, items]) => items.map((it, idx) => ({...it, cat, id: cat.replace(/\s/g,'')+idx})));
            document.getElementById('category-select').innerHTML = `<option value="all">Tutte le Categorie</option>` + Object.keys(RAW_MENU).map(c => `<option value="${c}">${c.toUpperCase()}</option>`).join('');
            document.getElementById('diet-select').innerHTML = `<option value="all">Tutti i Regimi</option>` + Object.entries(DIETS_CONFIG).map(([k,v]) => `<option value="${k}">${v}</option>`).join('');

            document.getElementById('search-input').oninput = (e) => { state.search = e.target.value; renderMenu(); };
            document.getElementById('category-select').onchange = (e) => { state.cat = e.target.value; renderMenu(); };
            document.getElementById('diet-select').onchange = (e) => { state.diet = e.target.value; renderMenu(); };

            onAuthStateChanged(auth_fb, u => { 
                if(!u) signInAnonymously(auth_fb); 
                if(!state.user) document.getElementById('user-modal').classList.remove('hidden');
                else checkAdmin(state.user.name);
            });
            renderMenu();
        };

        init();
    </script>
</body>
</html>
