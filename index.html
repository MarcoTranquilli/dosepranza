<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dosemagna - Men√π Completo</title>
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        primary: { light: '#e8b39a', DEFAULT: '#D6804F', dark: '#c0673a', '100': '#fef4ef', '800': '#8c502f' },
                        secondary: { light: '#a1bb96', DEFAULT: '#709460', dark: '#5a794d', '100': '#eef4ec', '800': '#415738' },
                        background: '#F3F1E7', 'text-main': '#3B3F2F',
                    }
                }
            }
        }
    </script>
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        .view { display: none; }
        .view.active { display: block; }
        .nav-btn.active { background-color: #D6804F; color: white; box-shadow: 0 4px 10px rgba(214, 128, 79, 0.3); }
        .ingredient-card.selected { border-color: #D6804F; background-color: #fef4ef; border-width: 3px; }
        .allergen-icon { color: #9ca3af; font-size: 0.7rem; margin-left: 3px; }
    </style>
</head>
<body class="bg-background text-text-main pb-24">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        <header class="mb-6 flex flex-col items-center">
            <img src="https://i.postimg.cc/L6H20zfp/logo-dosepranza-People-About-Food.png" alt="Dosepranza Logo" class="w-64 md:w-80 mx-auto mb-4">
            <div class="bg-primary-100 border-l-4 border-primary text-primary-800 p-4 rounded-xl w-full text-center shadow-sm">
                <p class="font-bold text-xs md:text-sm uppercase tracking-widest">‚è∞ Ordini entro 11:30 | Consegna 12:30</p>
            </div>
        </header>

        <nav id="main-nav" class="grid grid-cols-2 md:flex md:justify-center gap-2 bg-white/90 backdrop-blur-md p-2 rounded-2xl shadow-xl mb-8 sticky top-2 z-50 border border-white/50">
            <button data-view="menu" class="nav-btn flex items-center justify-center py-3 rounded-xl font-bold text-sm transition-all active:scale-95"><i class="fas fa-utensils mr-2"></i>Men√π</button>
            <button data-view="custom" class="nav-btn flex items-center justify-center py-3 rounded-xl font-bold text-sm transition-all active:scale-95"><i class="fas fa-plus-circle mr-2"></i>Crea</button>
            <button data-view="order" class="nav-btn flex items-center justify-center py-3 rounded-xl font-bold text-sm transition-all active:scale-95"><i class="fas fa-shopping-basket mr-2"></i>Ordine <span id="cart-count" class="bg-red-500 text-white text-[10px] font-bold rounded-full h-5 w-5 inline-flex items-center justify-center ml-1">0</span></button>
            <button data-view="history" class="nav-btn flex items-center justify-center py-3 rounded-xl font-bold text-sm transition-all active:scale-95"><i class="fas fa-users mr-2"></i>Tutti</button>
        </nav>

        <main>
            <section id="menu-view" class="view">
                <div class="space-y-3 mb-8">
                    <div class="relative w-full">
                        <input type="text" id="search-input" placeholder="Cerca nel men√π..." class="w-full p-4 pl-12 border border-gray-200 rounded-2xl shadow-sm focus:ring-2 focus:ring-primary outline-none">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="category-select" class="p-3 bg-white border border-gray-200 rounded-xl text-xs font-bold focus:ring-2 focus:ring-primary outline-none"></select>
                        <select id="diet-select" class="p-3 bg-white border border-gray-200 rounded-xl text-xs font-bold focus:ring-2 focus:ring-primary outline-none">
                            <option value="all">Tutti i Regimi</option>
                            <option value="carne/pesce">ü•© Carne/Pesce</option>
                            <option value="vegetariano">üßÄ Vegetariano</option>
                            <option value="vegano">üå± Vegano</option>
                        </select>
                    </div>
                </div>
                <div id="menu-items" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-20"></div>
            </section>

            <section id="custom-view" class="view">
                <div id="custom-step-1" class="bg-white p-6 rounded-[2.5rem] shadow-md mb-6">
                    <h3 class="font-bold mb-6 text-center text-gray-400 uppercase tracking-widest text-sm">1. Scegli la base (3,50‚Ç¨)</h3>
                    <div class="flex gap-4">
                        <button onclick="selectCustomBase('Panino')" class="flex-1 p-6 bg-gray-50 border-2 border-transparent rounded-3xl flex flex-col items-center hover:bg-orange-50 hover:border-primary transition-all group">
                            <i class="fas fa-bread-slice text-primary text-4xl mb-3 group-hover:scale-110 transition-transform"></i>
                            <span class="font-bold text-lg">Panino</span>
                        </button>
                        <button onclick="selectCustomBase('Pizza')" class="flex-1 p-6 bg-gray-50 border-2 border-transparent rounded-3xl flex flex-col items-center hover:bg-orange-50 hover:border-primary transition-all group">
                            <i class="fas fa-pizza-slice text-primary text-4xl mb-3 group-hover:scale-110 transition-transform"></i>
                            <span class="font-bold text-lg">Pizza Ripiena</span>
                        </button>
                    </div>
                </div>

                <div id="custom-step-2" class="hidden">
                    <div class="flex items-center justify-between mb-4 px-2">
                        <h3 class="font-bold text-gray-800 uppercase text-sm tracking-widest">2. Aggiungi Ingredienti</h3>
                        <button onclick="resetCustom()" class="text-xs text-primary font-bold underline">Cambia base</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="ingredients-list" class="md:col-span-2 grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                        <div class="md:col-span-1">
                            <div class="bg-white p-6 rounded-[2rem] shadow-xl sticky top-24 border border-gray-100">
                                <p class="text-[10px] font-black text-primary uppercase mb-1" id="custom-base-label"></p>
                                <h3 class="font-bold border-b pb-2 mb-4 text-sm uppercase">Riepilogo</h3>
                                <ul id="custom-summary" class="text-[11px] space-y-2 mb-6 min-h-[60px] text-gray-500"></ul>
                                <div class="flex justify-between items-center mb-6 border-t pt-4">
                                    <span class="text-gray-400 font-bold">Totale</span>
                                    <div class="text-2xl font-black text-primary" id="custom-total">‚Ç¨3.50</div>
                                </div>
                                <button id="add-custom-btn" class="w-full bg-secondary text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 disabled:opacity-50">AGGIUNGI AL CARRELLO</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="order-view" class="view">
                <h2 class="text-2xl font-extrabold mb-6">Il Tuo Carrello</h2>
                <div id="my-order-content" class="bg-white p-6 rounded-[2.5rem] shadow-md border border-gray-100"></div>
            </section>

            <section id="history-view" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-extrabold text-gray-800">Ordini di Oggi</h2>
                    <button id="export-history-btn" class="hidden bg-secondary hover:bg-secondary-dark text-white text-[10px] font-bold py-2 px-4 rounded-xl shadow-lg transition-all active:scale-95 uppercase">
                        <i class="fas fa-file-csv mr-1"></i>Export Storico
                    </button>
                </div>
                <div id="all-orders-list" class="space-y-4 min-h-[200px]"></div>
                <div class="mt-8 bg-white p-6 rounded-[2.5rem] shadow-2xl text-right border-t-8 border-primary">
                    <span class="text-sm font-bold text-gray-400 uppercase tracking-widest">Incasso Totale:</span>
                    <span id="grand-total" class="text-4xl font-black text-primary ml-2">‚Ç¨0.00</span>
                </div>
            </section>
        </main>
    </div>

    <div id="allergen-modal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center z-[60] hidden p-4">
        <div class="bg-white p-8 rounded-[2rem] shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-6 flex items-center text-gray-800"><i class="fas fa-info-circle text-primary mr-2"></i> Legenda Allergeni</h3>
            <div class="space-y-4 text-sm text-gray-600">
                <div class="flex items-center p-3 bg-gray-50 rounded-xl"><i class="fas fa-wheat-awn text-primary mr-3 text-xl"></i> <strong>G</strong> - Glutine</div>
                <div class="flex items-center p-3 bg-gray-50 rounded-xl"><i class="fas fa-cheese text-primary mr-3 text-xl"></i> <strong>L</strong> - Latticini</div>
                <div class="flex items-center p-3 bg-gray-50 rounded-xl"><i class="fas fa-shrimp text-primary mr-3 text-xl"></i> <strong>C</strong> - Crostacei</div>
                <div class="flex items-center p-3 bg-gray-50 rounded-xl"><i class="fas fa-fish text-primary mr-3 text-xl"></i> <strong>P</strong> - Pesce</div>
            </div>
            <button onclick="document.getElementById('allergen-modal').classList.add('hidden')" class="w-full mt-6 py-4 bg-gray-100 rounded-2xl font-bold text-gray-500 hover:bg-gray-200 transition-colors">Chiudi</button>
        </div>
    </div>

    <div id="user-modal" class="fixed inset-0 bg-gray-900/90 backdrop-blur-md flex items-center justify-center z-[100] hidden p-4">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center">
            <h3 class="text-2xl font-bold mb-2">Benvenuto!</h3>
            <p class="text-gray-400 mb-8 text-sm">Inserisci il tuo nome e la tua email per iniziare.</p>
            <input type="text" id="username-input" placeholder="Nome e Cognome" class="w-full p-4 bg-gray-50 border-none rounded-2xl mb-4 focus:ring-2 focus:ring-primary outline-none font-semibold">
            <input type="email" id="user-email-input" placeholder="Indirizzo Email" class="w-full p-4 bg-gray-50 border-none rounded-2xl mb-8 focus:ring-2 focus:ring-primary outline-none font-semibold">
            <button id="save-username-btn" class="w-full bg-primary text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all">Salva e Inizia</button>
        </div>
    </div>

    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-4 px-8 rounded-full shadow-2xl z-[110] opacity-0 transition-opacity duration-300 pointer-events-none text-sm font-bold flex items-center">
        <i class="fas fa-shopping-cart mr-2 text-primary"></i> <span id="toast-message"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCQJsNbgaR89gF_1vLe6H4DPboOhQvm9nI", authDomain: "app-ordini-pranzo-alimentari.firebaseapp.com", projectId: "app-ordini-pranzo-alimentari", storageBucket: "app-ordini-pranzo-alimentari.appspot.com", messagingSenderId: "553169964686", appId: "1:553169964686:web:7f8ca6f32a301949e4c3df" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ALLERGENS_MAP = { G: "fa-wheat-awn", L: "fa-cheese", C: "fa-shrimp", P: "fa-fish" };
        const kgWeights = (p) => [{l:'250g', v:p*0.25}, {l:'500g', v:p*0.5}, {l:'1kg', v:p}];

        // --- DATABASE COMPLETO ---
        const RAW_MENU = {
            "Gastronomia": [
                { name: "Lasagna al rag√π", price: 6.00, desc: "Pasta all'uovo, besciamella e rag√π di manzo.", allergens: ["G", "L"], calories: 550, diet: ["carne/pesce"], icon: "fa-bowl-food" },
                { name: "Cous cous vegetale", price: 4.00, desc: "Semola con verdure grigliate.", allergens: ["G"], calories: 350, diet: ["vegano", "vegetariano"], icon: "fa-bowl-food" },
                { name: "Pomodori con riso (2pz)", price: 6.00, desc: "Con patate al forno.", allergens: [], calories: 420, diet: ["vegano", "vegetariano"], icon: "fa-bowl-food" },
                { name: "Pasta fredda tonno", price: 4.00, desc: "Tonno, pomodorini e olive.", allergens: ["G", "P"], calories: 420, diet: ["carne/pesce"], icon: "fa-bowl-food" }
            ],
            "Forno: Pane": [
                { name: "Pane di Lariano", weights: kgWeights(3.00), desc: "Cotto a legna, crosta croccante.", allergens: ["G"], calories: 240, diet: ["vegano", "vegetariano"], icon: "fa-bread-slice" },
                { name: "Pane Casareccio", weights: kgWeights(2.50), desc: "Classico pane bianco.", allergens: ["G"], calories: 250, diet: ["vegano", "vegetariano"], icon: "fa-bread-slice" },
                { name: "Ciabatta", weights: kgWeights(4.00), desc: "Leggerissimo e croccante.", allergens: ["G"], calories: 270, diet: ["vegano", "vegetariano"], icon: "fa-bread-slice" },
                { name: "Pane Integrale", weights: kgWeights(4.00), desc: "Ricco di fibre.", allergens: ["G"], calories: 220, diet: ["vegano", "vegetariano"], icon: "fa-bread-slice" }
            ],
            "Forno: Pizza": [
                { name: "Pizza Rossa", weights: kgWeights(10.00), desc: "Pomodoro e olio EVO.", allergens: ["G"], calories: 220, diet: ["vegano", "vegetariano"], icon: "fa-pizza-slice" },
                { name: "Pizza Patate", weights: kgWeights(10.00), desc: "Bianca con patate e rosmarino.", allergens: ["G"], calories: 260, diet: ["vegetariano"], icon: "fa-pizza-slice" },
                { name: "Pizza Bianca", weights: kgWeights(9.00), desc: "Classica scrocchiarella.", allergens: ["G"], calories: 250, diet: ["vegano", "vegetariano"], icon: "fa-pizza-slice" },
                { name: "Pizzette Rosse", price: 1.50, desc: "Soffici al pomodoro. Prezzo cadauna.", allergens: ["G", "L"], calories: 150, icon: "fa-pizza-slice" }
            ],
            "Panini Farciti": [
                { name: "Cotoletta di pollo", price: 3.50, desc: "Cotoletta, lattuga, pomodoro.", allergens: ["G", "L"], calories: 580, diet: ["carne/pesce"], icon: "fa-bread-slice" },
                { name: "Brasato di manzo", price: 3.50, desc: "Brasato e verdura cotta ripassata.", allergens: ["G"], calories: 620, diet: ["carne/pesce"], icon: "fa-bread-slice" },
                { name: "Crudo mozzarella", price: 3.50, desc: "Fresco e saporito.", allergens: ["G", "L"], calories: 550, diet: ["carne/pesce"], icon: "fa-bread-slice" }
            ],
            "Fritti e Contorni": [
                { name: "Suppl√¨", price: 1.50, desc: "Cuore di mozzarella.", allergens: ["G", "L"], calories: 250, diet: ["vegetariano"], icon: "fa-stroopwafel" },
                { name: "Cicoria ripassata", price: 4.00, desc: "Aglio, olio e peperoncino.", allergens: [], calories: 140, diet: ["vegano", "vegetariano"], icon: "fa-carrot" },
                { name: "Broccoletti ripassati", price: 4.00, desc: "Contorno di stagione.", allergens: [], calories: 150, diet: ["vegano", "vegetariano"], icon: "fa-carrot" }
            ]
        };

        const INGREDIENTS = ["Prosciutto Crudo", "Prosciutto Cotto", "Salame", "Mortadella", "Bresaola", "Cotoletta", "Brasato", "Mozzarella", "Scamorza", "Grana", "Lattuga", "Pomodoro", "Rucola", "Olive", "Cicoria", "Broccoletti", "Scarola", "Melanzane", "Zucchine"].sort();

        const state = { currentUser: null, cart: [], allOrders: [], currentView: 'menu', customBase: null, customIngr: [], searchTerm: '', caloriesVisible: false, activeCat: 'all', activeDiet: 'all' };

        // --- CORE RENDERING ---
        function renderMenu() {
            let h = '';
            const t = state.searchTerm.toLowerCase();
            
            Object.entries(RAW_MENU).forEach(([cat, items]) => {
                if (state.activeCat !== 'all' && state.activeCat !== cat.toLowerCase()) return;

                const filtered = items.filter(i => {
                    const matchesSearch = i.name.toLowerCase().includes(t);
                    const matchesDiet = state.activeDiet === 'all' || (i.diet && i.diet.includes(state.activeDiet));
                    return matchesSearch && matchesDiet;
                });

                if (filtered.length === 0) return;

                h += `<div class="col-span-full mt-10 mb-4 border-b-2 border-primary-light flex items-center justify-between"><h3 class="font-extrabold text-gray-800 text-lg uppercase tracking-widest">${cat}</h3></div>`;
                filtered.forEach((item, idx) => {
                    const id = `${cat}-${idx}`.replace(/\s|:/g, '');
                    const aIcons = (item.allergens || []).map(a => `<i class="fas ${ALLERGENS_MAP[a]} allergen-icon" title="${a}"></i>`).join('');
                    let pArea = `<span class="font-black text-primary text-lg">‚Ç¨${(item.price || 0).toFixed(2)}</span>`;
                    
                    if (item.weights) {
                        const opts = item.weights.map(o => `<option value="${o.v}">${o.l}</option>`).join('');
                        pArea = `<select id="sel-${id}" class="text-xs p-2 border-none rounded-xl bg-gray-100 outline-none focus:ring-2 focus:ring-primary">${opts}</select>`;
                    }

                    h += `
                    <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100 flex flex-col justify-between hover:shadow-xl transition-all duration-300 h-full">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-gray-800 leading-tight flex-grow">${item.name}</h4>
                                <div class="flex ml-2">${aIcons}</div>
                            </div>
                            <p class="text-[11px] text-gray-400 mb-4 leading-relaxed italic">${item.desc || ''}</p>
                        </div>
                        <div class="mt-auto border-t pt-4 border-gray-50">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex flex-col">
                                    ${pArea}
                                    <span class="text-[10px] text-orange-500 font-bold ${state.caloriesVisible ? '' : 'hidden'}">‚ö° ${item.calories} kcal</span>
                                </div>
                                <div class="flex items-center bg-gray-50 rounded-xl p-1 border border-gray-100 shadow-inner">
                                    <button onclick="changeQty('${id}', -1)" class="w-8 h-8 flex items-center justify-center font-bold text-gray-400">-</button>
                                    <span id="qty-${id}" class="w-8 text-center font-bold text-sm">1</span>
                                    <button onclick="changeQty('${id}', 1)" class="w-8 h-8 flex items-center justify-center font-bold text-gray-400">+</button>
                                </div>
                            </div>
                            <button onclick="add('${cat}', ${idx}, '${id}')" class="w-full bg-primary text-white font-bold py-3.5 rounded-2xl shadow-md active:scale-95 transition-all text-xs uppercase">Aggiungi</button>
                        </div>
                    </div>`;
                });
            });
            document.getElementById('menu-items').innerHTML = h || '<p class="col-span-full text-center py-20 text-gray-400">Nessun prodotto trovato.</p>';
        }

        window.changeQty = (id, v) => {
            const el = document.getElementById(`qty-${id}`);
            let q = parseInt(el.textContent) + v;
            if (q < 1) q = 1;
            el.textContent = q;
        };

        window.add = (cat, idx, domId) => {
            const item = RAW_MENU[cat][idx];
            let price = item.price || 0;
            let name = item.name;
            const q = parseInt(document.getElementById(`qty-${domId}`).textContent);
            const sel = document.getElementById(`sel-${domId}`);
            if (sel) { price = parseFloat(sel.value); name += ` (${sel.options[sel.selectedIndex].text})`; }
            for(let i=0; i<q; i++) state.cart.push({ name, price, cartId: Date.now() + Math.random(), category: cat });
            document.getElementById('cart-count').textContent = state.cart.length;
            showToast(`${q}x ${name} aggiunto!`);
            document.getElementById(`qty-${domId}`).textContent = "1";
        };

        // --- SISTEMA EXPORT ---
        async function exportToCSV() {
            showToast("Esportazione...");
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            const sn = await getDocs(q);
            const header = "OrderID;TimestampISO8601;DataLeggibile;UserID;Utente;EmailUtente;Prodotto;Dettagli;CategoriaProdotto;Quantita;PrezzoUnitario;TotaleRiga;MetodoPagamento;Allergie;Posate;CanaleOrdine;StatoPagamento;RispostaRistoratore";
            let rows = [header];

            sn.docs.forEach(doc => {
                const o = doc.data();
                const oid = doc.id;
                const dIso = o.createdAt ? o.createdAt.toDate().toISOString() : "";
                const dLeg = o.createdAt ? `"${o.createdAt.toDate().toLocaleString('it-IT')}"` : "";
                
                o.items.forEach(i => {
                    const row = [
                        oid, dIso, dLeg, o.uid || "", `"${o.user}"`, o.email || "", `"${i.name}"`, `"${i.details || ""}"`,
                        `"${i.category || ""}"`, 1, `"${i.price.toFixed(2).replace('.', ',')}"`, `"${i.price.toFixed(2).replace('.', ',')}"`,
                        "Satispay", `"${o.allergies || ""}"`, o.cutlery ? "Si" : "No", "Web", o.paid ? "Pagato" : "Da Pagare", ""
                    ];
                    rows.push(row.join(";"));
                });
            });

            const blob = new Blob(["\uFEFF" + rows.join("\n")], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `storico_ordini_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // --- ALL ORDERS ---
        function renderAllOrders() {
            const todayStr = new Date().toLocaleDateString('it-IT');
            const filtered = state.allOrders.filter(o => o.createdAt && o.createdAt.toDate().toLocaleDateString('it-IT') === todayStr);
            const list = document.getElementById('all-orders-list');
            
            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-20 text-gray-300 italic"><p>Ancora nessun ordine per oggi (${todayStr}).</p></div>`;
                document.getElementById('grand-total').textContent = "‚Ç¨0.00";
                return;
            }

            list.innerHTML = filtered.map(o => `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border-l-8 border-primary flex justify-between items-center">
                    <div>
                        <h4 class="font-black text-gray-800 text-lg">${o.user}</h4>
                        <p class="text-[10px] text-gray-400 uppercase font-bold mt-1">${o.items.map(i=>i.name).join(', ')}</p>
                    </div>
                    <div class="text-xl font-black text-primary">‚Ç¨${o.total.toFixed(2)}</div>
                </div>
            `).join('');
            document.getElementById('grand-total').textContent = `‚Ç¨${filtered.reduce((s, o) => s + o.total, 0).toFixed(2)}`;
        }

        // --- SISTEMA NAVIGAZIONE ---
        function navigate(v) {
            state.currentView = v;
            document.querySelectorAll('.view').forEach(el => el.classList.toggle('active', el.id === v + '-view'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.view === v));
            if (v === 'menu') renderMenu();
            if (v === 'history') renderAllOrders();
            if (v === 'order') renderMyOrder();
            if (v === 'custom') resetCustom();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- CREA PRODOTTO ---
        window.selectCustomBase = (base) => {
            state.customBase = base;
            document.getElementById('custom-step-1').classList.add('hidden');
            document.getElementById('custom-step-2').classList.remove('hidden');
            document.getElementById('custom-base-label').textContent = "Base: " + base;
            renderIngredients();
        };
        window.resetCustom = () => {
            state.customBase = null; state.customIngr = [];
            document.getElementById('custom-step-1').classList.remove('hidden');
            document.getElementById('custom-step-2').classList.add('hidden');
        };
        function renderIngredients() {
            document.getElementById('ingredients-list').innerHTML = INGREDIENTS.map(ing => `<div onclick="toggleIng('${ing}')" id="ing-${ing.replace(/\s/g, '')}" class="ingredient-card bg-white p-3 rounded-2xl shadow-sm text-center font-bold text-[10px] border-2 border-transparent cursor-pointer active:scale-90 transition-all uppercase">${ing}</div>`).join('');
            updateCustomSum();
        }
        window.toggleIng = (ing) => {
            const i = state.customIngr.indexOf(ing);
            if (i > -1) state.customIngr.splice(i, 1); else state.customIngr.push(ing);
            document.getElementById(`ing-${ing.replace(/\s/g, '')}`).classList.toggle('selected');
            updateCustomSum();
        };
        function updateCustomSum() {
            const total = 3.5 + Math.max(0, state.customIngr.length - 3);
            document.getElementById('custom-summary').innerHTML = state.customIngr.map(i => `<li>‚Ä¢ ${i}</li>`).join('') || 'Scegli ingredienti...';
            document.getElementById('custom-total').textContent = `‚Ç¨${total.toFixed(2)}`;
            document.getElementById('add-custom-btn').disabled = state.customIngr.length === 0;
        }

        function renderMyOrder() {
            const todayStr = new Date().toLocaleDateString('it-IT');
            const userO = state.allOrders.find(o => o.uid === state.currentUser?.uid && o.createdAt?.toDate().toLocaleDateString('it-IT') === todayStr);
            const container = document.getElementById('my-order-content');
            if (userO) {
                container.innerHTML = `<div class="text-center py-10"><i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i><h3 class="font-bold">Ordine Ricevuto!</h3><p class="text-gray-400 text-sm mt-2">Passa alle 12:30.</p></div>`;
                document.getElementById('cart-count').textContent = '‚úì';
                return;
            }
            if (state.cart.length === 0) { container.innerHTML = `<div class="text-center py-10 text-gray-300"><p>Carrello vuoto.</p></div>`; return; }
            const tot = state.cart.reduce((s, i) => s + i.price, 0);
            container.innerHTML = `
                <div class="space-y-4 mb-8">${state.cart.map(i => `<div class="flex justify-between items-center border-b pb-2 text-sm"><span>${i.name}</span><b>‚Ç¨${i.price.toFixed(2)}</b></div>`).join('')}</div>
                <textarea id="allergies-input" placeholder="Note o allergie..." class="w-full bg-gray-50 p-4 rounded-3xl mb-8 outline-none focus:ring-2 focus:ring-primary h-24 text-sm"></textarea>
                <div class="flex justify-between text-2xl font-black text-primary mb-8"><span>TOTALE</span><span>‚Ç¨${tot.toFixed(2)}</span></div>
                <button id="confirm-order-btn" class="w-full bg-primary text-white font-bold py-5 rounded-[2rem] shadow-xl">INVIA ORDINE</button>`;
        }

        // --- INIT ---
        onAuthStateChanged(auth, user => {
            if (user) {
                state.currentUser = { uid: user.uid, name: localStorage.getItem('dosepranza-username'), email: localStorage.getItem('dosepranza-useremail') };
                if (!state.currentUser.name) document.getElementById('user-modal').classList.remove('hidden');
                if (state.currentUser.name === "Marco Tranquilli") document.getElementById('export-history-btn').classList.remove('hidden');
                onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), sn => {
                    state.allOrders = sn.docs.map(d => ({...d.data(), id: d.id}));
                    if (state.currentView === 'history') renderAllOrders();
                    if (state.currentView === 'order') renderMyOrder();
                });
            } else signInAnonymously(auth);
        });

        document.getElementById('save-username-btn').onclick = () => {
            const n = document.getElementById('username-input').value.trim();
            const em = document.getElementById('user-email-input').value.trim();
            if (n.length > 2 && em.includes('@')) {
                state.currentUser = { name: n, email: em, uid: auth.currentUser.uid };
                localStorage.setItem('dosepranza-username', n); localStorage.setItem('dosepranza-useremail', em);
                document.getElementById('user-modal').classList.add('hidden');
                if (n === "Marco Tranquilli") document.getElementById('export-history-btn').classList.remove('hidden');
            }
        };

        document.getElementById('add-custom-btn').onclick = () => {
            const p = 3.5 + Math.max(0, state.customIngr.length - 3);
            state.cart.push({ name: `${state.customBase.toUpperCase()} PERS. (${state.customIngr.join(', ')})`, price: p, cartId: Date.now() });
            document.getElementById('cart-count').textContent = state.cart.length;
            showToast("Prodotto aggiunto!"); navigate('menu');
        };

        document.getElementById('export-history-btn').onclick = exportToCSV;
        document.getElementById('search-input').oninput = (e) => { state.searchTerm = e.target.value; renderMenu(); };
        document.getElementById('toggle-calories').onclick = () => { state.caloriesVisible = !state.caloriesVisible; renderMenu(); };
        
        const catSel = document.getElementById('category-select');
        let opts = '<option value="all">Tutte le Categorie</option>';
        Object.keys(RAW_MENU).forEach(c => opts += `<option value="${c.toLowerCase()}">${c}</option>`);
        catSel.innerHTML = opts;
        catSel.onchange = (e) => { state.activeCat = e.target.value; renderMenu(); };
        document.getElementById('diet-select').onchange = (e) => { state.activeDiet = e.target.value; renderMenu(); };

        function showToast(m) {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').textContent = m;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 2500);
        }

        navigate('menu');
    </script>
</body>
</html>
